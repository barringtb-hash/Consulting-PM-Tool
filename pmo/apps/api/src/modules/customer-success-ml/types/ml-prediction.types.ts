/**
 * Customer Success ML Prediction Types
 *
 * Core type definitions for ML-powered predictions in Customer Success.
 * These types are used across all prediction services.
 *
 * @module customer-success-ml/types
 */

import type {
  Account,
  CTA,
  CTAPriority,
  CTAType,
  MLPredictionStatus,
  MLPredictionType,
} from '@prisma/client';

// ============================================================================
// Account Context Types
// ============================================================================

/**
 * Health score snapshot from history
 */
export interface HealthScoreSnapshot {
  /** Overall composite health score (0-100) */
  overallScore: number;
  /** When this score was calculated */
  calculatedAt: Date;
  /** Usage dimension score (0-100) */
  usageScore: number | null;
  /** Support dimension score (0-100) */
  supportScore: number | null;
  /** Engagement dimension score (0-100) */
  engagementScore: number | null;
  /** Sentiment dimension score (0-100) */
  sentimentScore: number | null;
  /** Score trend direction */
  scoreTrend: string | null;
  /** Calculated churn risk (0-1) */
  churnRisk: number | null;
}

/**
 * Recent activity record for context
 */
export interface ActivityRecord {
  /** Activity type (MEETING, EMAIL, CALL, etc.) */
  type: string;
  /** When the activity occurred */
  createdAt: Date;
  /** Sentiment if captured (POSITIVE, NEUTRAL, NEGATIVE) */
  sentiment: string | null;
}

/**
 * Open CTA record for context
 */
export interface OpenCTARecord {
  /** CTA type */
  type: string;
  /** CTA priority */
  priority: string;
  /** Current status */
  status: string;
  /** Due date if set */
  dueDate: Date | null;
}

/**
 * Opportunity record for context
 */
export interface OpportunityRecord {
  /** Pipeline stage */
  stage: string;
  /** Deal value */
  value: number | null;
  /** Win probability */
  probability: number | null;
}

/**
 * CRM engagement metrics
 */
export interface CRMMetrics {
  /** Days since last interaction */
  daysSinceLastActivity: number;
  /** Total activities in last 30 days */
  activitiesLast30Days: number;
  /** Meetings in last 30 days */
  meetingsLast30Days: number;
  /** Emails in last 30 days */
  emailsLast30Days: number;
}

/**
 * Complete account context for ML analysis.
 * Gathered from multiple sources for comprehensive prediction.
 */
export interface AccountMLContext {
  /** Account basic information */
  account: {
    id: number;
    name: string;
    type: string;
    healthScore: number | null;
    engagementScore: number | null;
    churnRisk: number | null;
    createdAt: Date;
  };
  /** Health score history (last 90 days) */
  healthHistory: HealthScoreSnapshot[];
  /** Recent activities (last 30 days) */
  recentActivities: ActivityRecord[];
  /** Open CTAs for this account */
  openCTAs: OpenCTARecord[];
  /** Active opportunities */
  opportunities: OpportunityRecord[];
  /** CRM engagement metrics */
  crmMetrics: CRMMetrics;
}

// ============================================================================
// Risk Factor Types
// ============================================================================

/**
 * Impact level of a risk factor
 */
export type RiskImpact = 'high' | 'medium' | 'low';

/**
 * Trend direction for a factor
 */
export type RiskTrend = 'improving' | 'stable' | 'worsening';

/**
 * A contributing factor to the prediction.
 * Generated by LLM with quantified impact.
 */
export interface RiskFactor {
  /** Name of the risk factor */
  factor: string;
  /** How much this factor impacts the prediction */
  impact: RiskImpact;
  /** Current value or state of this factor */
  currentValue: string | number;
  /** Threshold that defines concern (optional) */
  threshold?: string | number;
  /** Whether this factor is improving or worsening */
  trend: RiskTrend;
  /** Human-readable explanation of this factor */
  description: string;
}

// ============================================================================
// Recommendation Types
// ============================================================================

/**
 * Priority level for recommendations
 */
export type RecommendationPriority = 'urgent' | 'high' | 'medium' | 'low';

/**
 * Effort required to implement recommendation
 */
export type RecommendationEffort = 'low' | 'medium' | 'high';

/**
 * An actionable recommendation from ML analysis.
 * Provides specific steps to improve account health.
 */
export interface Recommendation {
  /** How urgent is this recommendation */
  priority: RecommendationPriority;
  /** What action to take */
  action: string;
  /** Why this action helps */
  rationale: string;
  /** Expected outcome if action is taken */
  expectedImpact: string;
  /** Estimated effort to implement */
  effort: RecommendationEffort;
  /** When to do this (e.g., "Within 48 hours", "This week") */
  timeframe: string;
}

// ============================================================================
// CTA Suggestion Types
// ============================================================================

/**
 * Suggested CTA to create from ML prediction
 */
export interface SuggestedCTA {
  /** CTA type */
  type: CTAType;
  /** Suggested priority level */
  priority: CTAPriority;
  /** CTA title */
  title: string;
  /** Why this CTA is being suggested */
  reason: string;
  /** Days from now until due */
  dueDays: number;
  /** Optional playbook to attach */
  playbookId?: number;
}

// ============================================================================
// LLM Metadata Types
// ============================================================================

/**
 * Metadata about the LLM call for tracking and debugging
 */
export interface LLMMetadata {
  /** Model used (e.g., "gpt-4o-mini") */
  model: string;
  /** Total tokens used (prompt + completion) */
  tokensUsed: number;
  /** Latency in milliseconds */
  latencyMs: number;
  /** Estimated cost in USD */
  estimatedCost: number;
}

// ============================================================================
// Prediction Result Types
// ============================================================================

/**
 * Base ML prediction result returned by prediction services.
 * Extended by specific prediction types (Churn, Health, etc.).
 */
export interface MLPredictionResult {
  /** Type of prediction */
  predictionType: MLPredictionType;
  /** Probability of the predicted event (0-1) */
  probability: number;
  /** Confidence in this prediction (0-1) */
  confidence: number;
  /** Days in the prediction window */
  predictionWindowDays: number;
  /** Factors contributing to this prediction */
  riskFactors: RiskFactor[];
  /** Human-readable explanation */
  explanation: string;
  /** Recommended actions */
  recommendations: Recommendation[];
  /** Suggested CTA if applicable */
  suggestedCTA?: SuggestedCTA;
  /** LLM call metadata for tracking */
  llmMetadata: LLMMetadata;
}

// ============================================================================
// Prediction Options Types
// ============================================================================

/**
 * Options for generating predictions
 */
export interface PredictionOptions {
  /** Force refresh even if recent prediction exists */
  forceRefresh?: boolean;
  /** Skip automatic CTA generation */
  skipCTAGeneration?: boolean;
}

/**
 * Options for batch prediction
 */
export interface BatchPredictionOptions {
  /** Maximum accounts to process */
  maxAccounts?: number;
  /** Filter by priority */
  priorityFilter?: 'high_risk' | 'all';
}

/**
 * Options for listing predictions
 */
export interface ListPredictionsOptions {
  /** Filter by prediction type */
  type?: MLPredictionType;
  /** Include expired predictions */
  includeExpired?: boolean;
}

// ============================================================================
// Prediction Accuracy Types
// ============================================================================

/**
 * Accuracy metrics for a prediction type
 */
export interface PredictionTypeAccuracy {
  /** Total predictions of this type */
  total: number;
  /** Number that were accurate */
  accurate: number;
}

/**
 * Overall prediction accuracy metrics
 */
export interface PredictionAccuracyMetrics {
  /** Total predictions made */
  totalPredictions: number;
  /** Number validated against outcomes */
  validatedCount: number;
  /** Number that were accurate */
  accurateCount: number;
  /** Overall accuracy (0-1) */
  accuracy: number;
  /** Breakdown by prediction type */
  byType: Record<string, PredictionTypeAccuracy>;
}

// ============================================================================
// Generated CTA Types
// ============================================================================

/**
 * Result of CTA generation from prediction
 */
export interface GeneratedCTAResult {
  /** The created CTA (if any) */
  cta: CTA | null;
  /** The prediction that triggered this */
  predictionId: number;
  /** Reason for generation */
  generationReason: string;
  /** Whether CTA was actually created */
  wasCreated: boolean;
  /** Reason if skipped */
  skippedReason?: string;
}

// ============================================================================
// Service Input Types
// ============================================================================

/**
 * Input for generating a single prediction
 */
export interface GeneratePredictionInput {
  /** Account to analyze */
  accountId: number;
  /** Tenant context */
  tenantId: string;
  /** Type of prediction to generate */
  predictionType: MLPredictionType;
  /** Optional generation options */
  options?: PredictionOptions;
}

/**
 * Input for batch prediction generation
 */
export interface BatchPredictionInput {
  /** Tenant context */
  tenantId: string;
  /** Type of prediction to generate */
  predictionType: MLPredictionType;
  /** Batch options */
  options?: BatchPredictionOptions;
}

/**
 * Result of batch prediction
 */
export interface BatchPredictionResult {
  /** Number of accounts processed */
  processed: number;
  /** Generated predictions */
  predictions: MLPredictionResult[];
  /** Number of errors encountered */
  errors: number;
}

// ============================================================================
// Configuration Types
// ============================================================================

/**
 * ML prediction feature configuration
 */
export interface MLPredictionConfig {
  /** Default prediction window in days */
  defaultPredictionWindowDays: number;
  /** Churn risk thresholds */
  churnRiskThresholds: {
    critical: number;
    high: number;
    medium: number;
    low: number;
  };
  /** Minimum days between auto-generated CTAs */
  ctaCooldownDays: number;
  /** Minimum confidence to generate CTA */
  minConfidenceThreshold: number;
  /** Maximum predictions per day per tenant */
  maxPredictionsPerDay: number;
  /** Enable automatic CTA generation */
  enableAutoCtaGeneration: boolean;
}

/**
 * Default configuration values
 */
export const DEFAULT_ML_CONFIG: MLPredictionConfig = {
  defaultPredictionWindowDays: 90,
  churnRiskThresholds: {
    critical: 0.8,
    high: 0.6,
    medium: 0.3,
    low: 0,
  },
  ctaCooldownDays: 7,
  minConfidenceThreshold: 0.5,
  maxPredictionsPerDay: 100,
  enableAutoCtaGeneration: true,
};

// ============================================================================
// Re-exports from Prisma
// ============================================================================

export { MLPredictionStatus, MLPredictionType };
export type { Account, CTA };
