generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum CompanySize {
  MICRO
  SMALL
  MEDIUM
}

enum AiMaturity {
  NONE
  LOW
  MEDIUM
  HIGH
}

enum ProjectStatus {
  PLANNING
  IN_PROGRESS
  ON_HOLD
  COMPLETED
  CANCELLED
}

enum ProjectHealthStatus {
  ON_TRACK
  AT_RISK
  OFF_TRACK
}

enum TaskStatus {
  BACKLOG
  IN_PROGRESS
  BLOCKED
  DONE
}

enum Priority {
  P0
  P1
  P2
}

enum MilestoneStatus {
  NOT_STARTED
  IN_PROGRESS
  DONE
}

enum AssetType {
  PROMPT_TEMPLATE
  WORKFLOW
  DATASET
  EVALUATION
  GUARDRAIL
}

enum DocumentType {
  REQUIREMENTS
  PROPOSAL
  CONTRACT
  REPORT
  OTHER
}

enum LeadSource {
  WEBSITE_CONTACT
  WEBSITE_DOWNLOAD
  REFERRAL
  LINKEDIN
  OUTBOUND
  EVENT
  OTHER
}

enum LeadStatus {
  NEW
  CONTACTED
  QUALIFIED
  DISQUALIFIED
  CONVERTED
}

enum ServiceInterest {
  STRATEGY
  POC
  IMPLEMENTATION
  TRAINING
  PMO_ADVISORY
  NOT_SURE
}

enum PipelineStage {
  NEW_LEAD
  DISCOVERY
  SHAPING_SOLUTION
  PROPOSAL_SENT
  NEGOTIATION
  VERBAL_YES
  WON
  LOST
}

enum MeetingCategory {
  SALES
  DELIVERY
  INTERNAL
}

enum UserRole {
  USER
  ADMIN
}

enum ContentType {
  BLOG_POST
  CASE_STUDY
  LINKEDIN_POST
  TWITTER_POST
  EMAIL_TEMPLATE
  WHITEPAPER
  SOCIAL_STORY
  VIDEO_SCRIPT
  NEWSLETTER
  OTHER
}

enum ContentStatus {
  IDEA
  DRAFT
  IN_REVIEW
  APPROVED
  READY
  PUBLISHED
  ARCHIVED
}

enum ContentChannel {
  WEB
  LINKEDIN
  INSTAGRAM
  TWITTER
  EMAIL
  GENERIC
}

enum CampaignStatus {
  PLANNING
  ACTIVE
  PAUSED
  COMPLETED
  ARCHIVED
}

enum BrandAssetType {
  LOGO
  IMAGE
  TEMPLATE
  DOCUMENT
  VIDEO
  OTHER
}

enum PublishingPlatform {
  LINKEDIN
  TWITTER
  INSTAGRAM
  FACEBOOK
}

model User {
  id           Int      @id @default(autoincrement())
  name         String
  email        String   @unique
  passwordHash String
  role         UserRole @default(USER)
  timezone     String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // User preferences stored as JSON
  // Includes dashboard panel preferences, theme settings, notification preferences, etc.
  // Example: { dashboardPanels: ['active-clients', 'open-tasks'], theme: 'light' }
  preferences  Json?

  ownedProjects      Project[]
  documents          Document[]
  tasks              Task[]
  createdAssets      AIAsset[]
  ownedLeads         InboundLead[]
  createdContents    MarketingContent[]
  createdCampaigns   Campaign[]
}

model Client {
  id          Int          @id @default(autoincrement())
  name        String
  industry    String?
  companySize CompanySize?
  timezone    String?
  aiMaturity  AiMaturity?
  notes       String?
  archived    Boolean      @default(false)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  contacts           Contact[]
  projects           Project[]
  documents          Document[]
  aiAssets           AIAsset[]
  inboundLeads       InboundLead[]
  marketingContents  MarketingContent[]
  campaigns          Campaign[]
  brandProfile       BrandProfile?
  publishingConnections PublishingConnection[]
}

model Contact {
  id        Int      @id @default(autoincrement())
  clientId  Int
  name      String
  email     String
  role      String?
  phone     String?
  notes     String?
  archived  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)
  convertedLeads InboundLead[]

  @@unique([clientId, email])
}

model InboundLead {
  id               Int              @id @default(autoincrement())
  name             String?
  email            String
  company          String?
  website          String?
  source           LeadSource       @default(OTHER)
  serviceInterest  ServiceInterest  @default(NOT_SURE)
  message          String?
  status           LeadStatus       @default(NEW)
  ownerUserId      Int?
  clientId         Int?
  primaryContactId Int?
  firstResponseAt  DateTime?
  // Tracking fields for website submissions
  page             String?
  utmSource        String?
  utmMedium        String?
  utmCampaign      String?
  utmContent       String?
  utmTerm          String?
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt

  owner          User?    @relation(fields: [ownerUserId], references: [id], onDelete: SetNull)
  client         Client?  @relation(fields: [clientId], references: [id], onDelete: SetNull)
  primaryContact Contact? @relation(fields: [primaryContactId], references: [id], onDelete: SetNull)

  @@index([status, createdAt(sort: Desc)])
  @@index([ownerUserId, status])
  @@index([source, createdAt(sort: Desc)])
}

model Project {
  id        Int           @id @default(autoincrement())
  clientId  Int
  ownerId   Int
  name      String
  status    ProjectStatus @default(PLANNING)
  startDate DateTime?
  endDate   DateTime?
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  // M7 - Status & Reporting
  healthStatus      ProjectHealthStatus @default(ON_TRACK)
  statusSummary     String?
  statusUpdatedAt   DateTime?

  // Sales/Pipeline fields
  pipelineStage      PipelineStage?
  pipelineValue      Decimal?       @db.Decimal(12, 2)
  currency           String?        @default("USD")
  probability        Int?
  expectedCloseDate  DateTime?
  leadSource         LeadSource?
  lostReason         String?

  client            Client             @relation(fields: [clientId], references: [id], onDelete: Cascade)
  owner             User               @relation(fields: [ownerId], references: [id])
  documents         Document[]
  tasks             Task[]
  meetings          Meeting[]
  milestones        Milestone[]
  assets            ProjectAIAsset[]
  marketingContents MarketingContent[]
  campaigns         Campaign[]

  @@index([status, pipelineStage])
}

model Document {
  id        Int          @id @default(autoincrement())
  clientId  Int
  projectId Int?
  ownerId   Int
  type      DocumentType @default(OTHER)
  filename  String
  url       String
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  client  Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  project Project? @relation(fields: [projectId], references: [id], onDelete: SetNull)
  owner   User     @relation(fields: [ownerId], references: [id])

  @@index([projectId])
}

model Milestone {
  id          Int             @id @default(autoincrement())
  projectId   Int
  name        String
  description String?
  dueDate     DateTime?
  status      MilestoneStatus @default(NOT_STARTED)
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  tasks   Task[]
}

model Task {
  id              Int         @id @default(autoincrement())
  projectId       Int
  ownerId         Int
  milestoneId     Int?
  sourceMeetingId Int?
  linkedAssetId   Int?
  title           String
  description     String?
  status          TaskStatus  @default(BACKLOG)
  priority        Priority    @default(P1)
  dueDate         DateTime?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  project   Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  owner     User      @relation(fields: [ownerId], references: [id])
  milestone Milestone? @relation(fields: [milestoneId], references: [id], onDelete: SetNull)
  sourceMeeting Meeting? @relation(fields: [sourceMeetingId], references: [id], onDelete: SetNull)

  @@index([projectId, status, priority])
  @@index([ownerId, status])
}

model Meeting {
  id            Int             @id @default(autoincrement())
  projectId     Int
  title         String
  date          DateTime
  time          String
  attendees     String[]
  notes         String?
  decisions     String?
  risks         String?
  category      MeetingCategory @default(DELIVERY)
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  project           Project            @relation(fields: [projectId], references: [id], onDelete: Cascade)
  sourceTasks       Task[]
  marketingContents MarketingContent[]

  @@index([projectId, date(sort: Desc)])
  @@index([category, date(sort: Desc)])
}

model AIAsset {
  id          Int         @id @default(autoincrement())
  type        AssetType
  name        String
  description String?
  content     Json?
  tags        String[]    @default([])
  archived    Boolean     @default(false)
  isTemplate  Boolean     @default(false)
  clientId    Int?
  createdById Int?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  client    Client?   @relation(fields: [clientId], references: [id], onDelete: SetNull)
  createdBy User?     @relation(fields: [createdById], references: [id])
  projects  ProjectAIAsset[]

  @@unique([name, clientId])
}

model ProjectAIAsset {
  id        Int      @id @default(autoincrement())
  projectId Int
  assetId   Int
  notes     String?
  createdAt DateTime @default(now())

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  asset   AIAsset @relation(fields: [assetId], references: [id], onDelete: Cascade)

  @@unique([projectId, assetId])
}

model MarketingContent {
  id               Int              @id @default(autoincrement())
  name             String
  slug             String?          @unique
  type             ContentType
  channel          ContentChannel?
  status           ContentStatus    @default(DRAFT)
  content          Json?
  summary          String?
  tags             String[]         @default([])

  // Relations
  clientId         Int
  projectId        Int?
  sourceMeetingId  Int?
  createdById      Int?
  sourceContentId  Int?
  campaignId       Int?

  // Publishing metadata
  publishedAt      DateTime?
  scheduledFor     DateTime?
  publishingConnectionId Int?
  publishedUrl     String?
  publishError     String?
  lastPublishAttempt DateTime?
  archived         Boolean          @default(false)

  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt

  client           Client           @relation(fields: [clientId], references: [id], onDelete: Cascade)
  project          Project?         @relation(fields: [projectId], references: [id], onDelete: SetNull)
  sourceMeeting    Meeting?         @relation(fields: [sourceMeetingId], references: [id], onDelete: SetNull)
  createdBy        User?            @relation(fields: [createdById], references: [id])
  campaign         Campaign?        @relation(fields: [campaignId], references: [id], onDelete: SetNull)
  publishingConnection PublishingConnection? @relation(fields: [publishingConnectionId], references: [id], onDelete: SetNull)

  // Self-referential relation for repurposed content
  sourceContent    MarketingContent? @relation("RepurposedFrom", fields: [sourceContentId], references: [id], onDelete: SetNull)
  repurposedContent MarketingContent[] @relation("RepurposedFrom")

  @@index([clientId, type])
  @@index([status, createdAt(sort: Desc)])
  @@index([projectId])
  @@index([campaignId])
  @@index([slug])
}

model Campaign {
  id          Int            @id @default(autoincrement())
  name        String
  description String?
  goals       Json?
  status      CampaignStatus @default(PLANNING)
  startDate   DateTime?
  endDate     DateTime?
  archived    Boolean        @default(false)

  // Relations
  clientId    Int
  projectId   Int?
  createdById Int?

  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  client      Client         @relation(fields: [clientId], references: [id], onDelete: Cascade)
  project     Project?       @relation(fields: [projectId], references: [id], onDelete: SetNull)
  createdBy   User?          @relation(fields: [createdById], references: [id])
  contents    MarketingContent[]

  @@index([clientId, status])
  @@index([status, startDate])
}

model BrandProfile {
  id                    Int      @id @default(autoincrement())
  clientId              Int      @unique
  name                  String
  description           String?
  logoUrl               String?
  primaryColor          String?
  secondaryColor        String?
  accentColor           String?
  fonts                 Json?
  toneVoiceGuidelines   String?
  valueProposition      String?
  targetAudience        String?
  keyMessages           String[] @default([])
  archived              Boolean  @default(false)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  client                Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  assets                BrandAsset[]
}

model BrandAsset {
  id              Int            @id @default(autoincrement())
  brandProfileId  Int
  name            String
  type            BrandAssetType @default(OTHER)
  url             String
  description     String?
  tags            String[]       @default([])
  archived        Boolean        @default(false)
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  brandProfile    BrandProfile   @relation(fields: [brandProfileId], references: [id], onDelete: Cascade)

  @@index([brandProfileId, type])
}

model PublishingConnection {
  id           Int                @id @default(autoincrement())
  clientId     Int
  platform     PublishingPlatform
  accountName  String
  accessToken  String
  refreshToken String?
  expiresAt    DateTime?
  isActive     Boolean            @default(true)
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt

  client       Client             @relation(fields: [clientId], references: [id], onDelete: Cascade)
  publishedContents MarketingContent[]

  @@index([clientId, platform])
  @@unique([clientId, platform, accountName])
}

// ============================================================================
// FEATURE FLAGS & MODULE CONFIGURATION
// ============================================================================

/**
 * FeatureFlag - Global feature flags for the system
 * Used for gradual rollouts, A/B testing, and feature toggling
 */
model FeatureFlag {
  id          Int      @id @default(autoincrement())
  key         String   @unique
  name        String
  description String?
  enabled     Boolean  @default(false)

  // Percentage rollout (0-100) for gradual rollouts
  rolloutPercentage Int @default(100)

  // JSON for additional configuration
  // Example: { "allowedUserIds": [1, 2, 3], "allowedRoles": ["ADMIN"] }
  config      Json?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([key, enabled])
}

/**
 * TenantModuleConfig - Per-tenant/deployment module configuration
 * Allows enabling/disabling modules for specific tenants or deployments
 *
 * Tenant identifier can be:
 * - "default" for system-wide defaults
 * - A specific tenant/customer identifier
 * - An environment identifier (e.g., "production", "staging")
 */
model TenantModuleConfig {
  id              Int      @id @default(autoincrement())

  // Tenant identifier - "default" for system defaults, or specific tenant ID
  tenantId        String   @default("default")

  // Module ID from the ModuleId type (dashboard, tasks, clients, projects, assets, marketing, leads, pipeline, admin)
  moduleId        String

  // Whether this module is enabled for this tenant
  enabled         Boolean  @default(true)

  // Optional: override module settings for this tenant
  // Example: { "maxUsers": 10, "customFeatures": ["featureA"] }
  settings        Json?

  // Audit fields
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  updatedBy       Int?

  @@unique([tenantId, moduleId])
  @@index([tenantId])
  @@index([moduleId, enabled])
}
