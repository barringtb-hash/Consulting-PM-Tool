generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum CompanySize {
  MICRO
  SMALL
  MEDIUM
}

enum AiMaturity {
  NONE
  LOW
  MEDIUM
  HIGH
}

enum ProjectStatus {
  PLANNING
  IN_PROGRESS
  ON_HOLD
  COMPLETED
  CANCELLED
}

enum ProjectHealthStatus {
  ON_TRACK
  AT_RISK
  OFF_TRACK
}

enum TaskStatus {
  BACKLOG
  IN_PROGRESS
  BLOCKED
  DONE
}

enum Priority {
  P0
  P1
  P2
}

enum MilestoneStatus {
  NOT_STARTED
  IN_PROGRESS
  DONE
}

enum AssetType {
  PROMPT_TEMPLATE
  WORKFLOW
  DATASET
  EVALUATION
  GUARDRAIL
}

enum DocumentType {
  REQUIREMENTS
  PROPOSAL
  CONTRACT
  REPORT
  OTHER
}

enum LeadSource {
  WEBSITE_CONTACT
  WEBSITE_DOWNLOAD
  REFERRAL
  LINKEDIN
  OUTBOUND
  EVENT
  OTHER
}

enum LeadStatus {
  NEW
  CONTACTED
  QUALIFIED
  DISQUALIFIED
  CONVERTED
}

enum ServiceInterest {
  STRATEGY
  POC
  IMPLEMENTATION
  TRAINING
  PMO_ADVISORY
  NOT_SURE
}

enum PipelineStage {
  NEW_LEAD
  DISCOVERY
  SHAPING_SOLUTION
  PROPOSAL_SENT
  NEGOTIATION
  VERBAL_YES
  WON
  LOST
}

enum MeetingCategory {
  SALES
  DELIVERY
  INTERNAL
}

model User {
  id           Int      @id @default(autoincrement())
  name         String
  email        String   @unique
  passwordHash String
  timezone     String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  ownedProjects Project[]
  documents     Document[]
  tasks         Task[]
  createdAssets AIAsset[]
  ownedLeads    InboundLead[]
}

model Client {
  id          Int          @id @default(autoincrement())
  name        String
  industry    String?
  companySize CompanySize?
  timezone    String?
  aiMaturity  AiMaturity?
  notes       String?
  archived    Boolean      @default(false)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  contacts     Contact[]
  projects     Project[]
  documents    Document[]
  aiAssets     AIAsset[]
  inboundLeads InboundLead[]
}

model Contact {
  id        Int      @id @default(autoincrement())
  clientId  Int
  name      String
  email     String
  role      String?
  phone     String?
  notes     String?
  archived  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)
  convertedLeads InboundLead[]

  @@unique([clientId, email])
}

model InboundLead {
  id               Int              @id @default(autoincrement())
  name             String?
  email            String
  company          String?
  website          String?
  source           LeadSource       @default(OTHER)
  serviceInterest  ServiceInterest  @default(NOT_SURE)
  message          String?
  status           LeadStatus       @default(NEW)
  ownerUserId      Int?
  clientId         Int?
  primaryContactId Int?
  firstResponseAt  DateTime?
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt

  owner          User?    @relation(fields: [ownerUserId], references: [id], onDelete: SetNull)
  client         Client?  @relation(fields: [clientId], references: [id], onDelete: SetNull)
  primaryContact Contact? @relation(fields: [primaryContactId], references: [id], onDelete: SetNull)

  @@index([status, createdAt(sort: Desc)])
  @@index([ownerUserId, status])
}

model Project {
  id        Int           @id @default(autoincrement())
  clientId  Int
  ownerId   Int
  name      String
  status    ProjectStatus @default(PLANNING)
  startDate DateTime?
  endDate   DateTime?
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  // M7 - Status & Reporting
  healthStatus      ProjectHealthStatus @default(ON_TRACK)
  statusSummary     String?
  statusUpdatedAt   DateTime?

  // Sales/Pipeline fields
  pipelineStage      PipelineStage?
  pipelineValue      Decimal?       @db.Decimal(12, 2)
  currency           String?        @default("USD")
  probability        Int?
  expectedCloseDate  DateTime?
  leadSource         LeadSource?
  lostReason         String?

  client    Client     @relation(fields: [clientId], references: [id], onDelete: Cascade)
  owner     User       @relation(fields: [ownerId], references: [id])
  documents Document[]
  tasks     Task[]
  meetings  Meeting[]
  milestones Milestone[]
  assets    ProjectAIAsset[]

  @@index([status, pipelineStage])
}

model Document {
  id        Int          @id @default(autoincrement())
  clientId  Int
  projectId Int?
  ownerId   Int
  type      DocumentType @default(OTHER)
  filename  String
  url       String
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  client  Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  project Project? @relation(fields: [projectId], references: [id], onDelete: SetNull)
  owner   User     @relation(fields: [ownerId], references: [id])

  @@index([projectId])
}

model Milestone {
  id          Int             @id @default(autoincrement())
  projectId   Int
  name        String
  description String?
  dueDate     DateTime?
  status      MilestoneStatus @default(NOT_STARTED)
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  tasks   Task[]
}

model Task {
  id              Int         @id @default(autoincrement())
  projectId       Int
  ownerId         Int
  milestoneId     Int?
  sourceMeetingId Int?
  linkedAssetId   Int?
  title           String
  description     String?
  status          TaskStatus  @default(BACKLOG)
  priority        Priority    @default(P1)
  dueDate         DateTime?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  project   Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  owner     User      @relation(fields: [ownerId], references: [id])
  milestone Milestone? @relation(fields: [milestoneId], references: [id], onDelete: SetNull)
  sourceMeeting Meeting? @relation(fields: [sourceMeetingId], references: [id], onDelete: SetNull)

  @@index([projectId, status, priority])
  @@index([ownerId, status])
}

model Meeting {
  id            Int             @id @default(autoincrement())
  projectId     Int
  title         String
  date          DateTime
  time          String
  attendees     String[]
  notes         String?
  decisions     String?
  risks         String?
  category      MeetingCategory @default(DELIVERY)
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  project       Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  sourceTasks   Task[]

  @@index([projectId, date(sort: Desc)])
  @@index([category, date(sort: Desc)])
}

model AIAsset {
  id          Int         @id @default(autoincrement())
  type        AssetType
  name        String
  description String?
  content     Json?
  tags        String[]    @default([])
  archived    Boolean     @default(false)
  isTemplate  Boolean     @default(false)
  clientId    Int?
  createdById Int?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  client    Client?   @relation(fields: [clientId], references: [id], onDelete: SetNull)
  createdBy User?     @relation(fields: [createdById], references: [id])
  projects  ProjectAIAsset[]

  @@unique([name, clientId])
}

model ProjectAIAsset {
  id        Int      @id @default(autoincrement())
  projectId Int
  assetId   Int
  notes     String?
  createdAt DateTime @default(now())

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  asset   AIAsset @relation(fields: [assetId], references: [id], onDelete: Cascade)

  @@unique([projectId, assetId])
}
