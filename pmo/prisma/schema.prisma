generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum CompanySize {
  MICRO
  SMALL
  MEDIUM
}

enum AiMaturity {
  NONE
  LOW
  MEDIUM
  HIGH
}

enum ProjectStatus {
  PLANNING
  IN_PROGRESS
  ON_HOLD
  COMPLETED
  CANCELLED
}

enum ProjectHealthStatus {
  ON_TRACK
  AT_RISK
  OFF_TRACK
}

enum TaskStatus {
  NOT_STARTED
  BACKLOG
  IN_PROGRESS
  BLOCKED
  DONE
}

enum Priority {
  P0
  P1
  P2
}

enum MilestoneStatus {
  NOT_STARTED
  IN_PROGRESS
  DONE
}

enum AssetType {
  PROMPT_TEMPLATE
  WORKFLOW
  DATASET
  EVALUATION
  GUARDRAIL
}

enum DocumentType {
  REQUIREMENTS
  PROPOSAL
  CONTRACT
  REPORT
  OTHER
}

/**
 * @deprecated Use CRMLeadSource instead for new CRM features.
 * This enum is kept for backward compatibility with legacy PMO InboundLead model.
 * Migration mapping:
 * WEBSITE_CONTACT -> WEBSITE
 * WEBSITE_DOWNLOAD -> WEBSITE
 * REFERRAL -> REFERRAL
 * LINKEDIN -> LINKEDIN
 * OUTBOUND -> OUTBOUND
 * EVENT -> EVENT
 * OTHER -> OTHER
 */
enum LeadSource {
  WEBSITE_CONTACT
  WEBSITE_DOWNLOAD
  REFERRAL
  LINKEDIN
  OUTBOUND
  EVENT
  OTHER
}

/**
 * @deprecated Use ContactLifecycle (CRM) instead for new features.
 * This enum is for legacy PMO InboundLead model.
 * Migration mapping to ContactLifecycle:
 * NEW -> LEAD
 * CONTACTED -> MQL
 * QUALIFIED -> SQL
 * DISQUALIFIED -> CHURNED
 * CONVERTED -> OPPORTUNITY (or CUSTOMER)
 */
enum LeadStatus {
  NEW
  CONTACTED
  QUALIFIED
  DISQUALIFIED
  CONVERTED
}

enum ServiceInterest {
  STRATEGY
  POC
  IMPLEMENTATION
  TRAINING
  PMO_ADVISORY
  NOT_SURE
}

/**
 * @deprecated Use SalesPipelineStage model (CRM) instead for new features.
 * The CRM uses a dynamic stage model via the Pipeline and SalesPipelineStage models,
 * allowing tenants to customize pipeline stages. Legacy PMO Project model still uses this enum.
 * Migration: Create pipeline stages matching these values via the SalesPipelineStage model.
 */
enum PipelineStage {
  NEW_LEAD
  DISCOVERY
  SHAPING_SOLUTION
  PROPOSAL_SENT
  NEGOTIATION
  VERBAL_YES
  WON
  LOST
}

enum MeetingCategory {
  SALES
  DELIVERY
  INTERNAL
}

enum UserRole {
  USER
  ADMIN
  SUPER_ADMIN
}

enum ContentType {
  BLOG_POST
  CASE_STUDY
  LINKEDIN_POST
  TWITTER_POST
  EMAIL_TEMPLATE
  WHITEPAPER
  SOCIAL_STORY
  VIDEO_SCRIPT
  NEWSLETTER
  OTHER
}

enum ContentStatus {
  IDEA
  DRAFT
  IN_REVIEW
  APPROVED
  READY
  PUBLISHED
  ARCHIVED
}

enum ContentChannel {
  WEB
  LINKEDIN
  INSTAGRAM
  TWITTER
  EMAIL
  GENERIC
}

enum CampaignStatus {
  PLANNING
  ACTIVE
  PAUSED
  COMPLETED
  ARCHIVED
}

enum BrandAssetType {
  LOGO
  IMAGE
  TEMPLATE
  DOCUMENT
  VIDEO
  OTHER
}

enum PublishingPlatform {
  LINKEDIN
  TWITTER
  INSTAGRAM
  FACEBOOK
}

model User {
  id           Int      @id @default(autoincrement())
  name         String
  email        String   @unique
  passwordHash String
  role         UserRole @default(USER)
  timezone     String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // User preferences stored as JSON
  // Includes dashboard panel preferences, theme settings, notification preferences, etc.
  // Example: { dashboardPanels: ['active-clients', 'open-tasks'], theme: 'light' }
  preferences Json?

  ownedProjects    Project[]
  documents        Document[]
  tasks            Task[]
  createdAssets    AIAsset[]
  ownedLeads       InboundLead[]
  createdContents  MarketingContent[]
  createdCampaigns Campaign[]

  // Customer Success Platform relations
  ownedSuccessPlans    SuccessPlan[]
  ownedCTAs            CTA[]
  assignedCTATasks     CTATask[]
  assignedSuccessTasks SuccessTask[]
  createdPlaybooks     Playbook[]
  csActivityLogs       CSActivityLog[]
  createdCSRules       CSRule[]
  createdSurveys       CSSurvey[]

  // Multi-tenant CRM relations
  tenantMemberships   TenantUser[]
  ownedAccounts       Account[]
  ownedCRMContacts    CRMContact[]
  ownedOpportunities  Opportunity[]
  changedStageHistory OpportunityStageHistory[]
  ownedActivities     CRMActivity[]             @relation("ActivityOwner")
  createdActivities   CRMActivity[]             @relation("ActivityCreator")
  notifications       Notification[]
  savedReports        SavedReport[]
  // Audit logging
  auditLogs           AuditLog[]                @relation("AuditLogUser")

  // Finance Tracking relations
  ownedBudgets        Budget[]        @relation("BudgetOwner")
  ownedExpenses       Expense[]       @relation("ExpenseOwner")
  approvedExpenses    Expense[]       @relation("ExpenseApprover")
  ownedRecurringCosts RecurringCost[] @relation("RecurringCostOwner")
  employeeCosts       RecurringCost[] @relation("EmployeeCost")
  financeAlerts       FinanceAlert[]

  // Shift Scheduling relations
  shiftEmployees ShiftEmployee[]

  // AI Monitoring relations
  aiUsageEvents        AIUsageEvent[]
  acknowledgedAnomalies Anomaly[]      @relation("AnomalyAcknowledgedBy")
  resolvedAnomalies    Anomaly[]      @relation("AnomalyResolvedBy")

  // Password reset tokens
  passwordResets PasswordReset[]
}

/// Stores password reset tokens for self-service password recovery.
/// Tokens are hashed for security and expire after a short time period.
model PasswordReset {
  id        String   @id @default(cuid())
  userId    Int
  tokenHash String   // SHA-256 hash of the actual token
  expiresAt DateTime
  usedAt    DateTime? // Set when token is used to prevent reuse
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([tokenHash])
  @@index([expiresAt])
}

model Client {
  id          Int          @id @default(autoincrement())
  tenantId    String?
  name        String
  industry    String?
  companySize CompanySize?
  timezone    String?
  aiMaturity  AiMaturity?
  notes       String?
  archived    Boolean      @default(false)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  tenant                Tenant?                @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  contacts              Contact[]
  projects              Project[]
  documents             Document[]
  aiAssets              AIAsset[]
  inboundLeads          InboundLead[]
  marketingContents     MarketingContent[]
  campaigns             Campaign[]
  brandProfile          BrandProfile?
  publishingConnections PublishingConnection[]

  // Phase 1 AI Tools
  chatbotConfig            ChatbotConfig?
  productDescriptionConfig ProductDescriptionConfig?
  schedulingConfig         SchedulingConfig?
  intakeConfig             IntakeConfig?

  // Phase 2 AI Tools
  documentAnalyzerConfig DocumentAnalyzerConfig?
  contentGeneratorConfig ContentGeneratorConfig?
  leadScoringConfig      LeadScoringConfig?
  priorAuthConfig        PriorAuthConfig?

  // Phase 3 AI Tools
  inventoryForecastConfig     InventoryForecastConfig?
  complianceMonitorConfig     ComplianceMonitorConfig?
  predictiveMaintenanceConfig PredictiveMaintenanceConfig?
  revenueManagementConfig     RevenueManagementConfig?
  safetyMonitorConfig         SafetyMonitorConfig?

  // Customer Success Platform relations
  healthScores      CustomerHealthScore[]
  successPlans      SuccessPlan[]
  ctas              CTA[]
  csActivityLogs    CSActivityLog[]
  csMetricSnapshots CSMetricSnapshot[]
  csSurveys         CSSurvey[]
  csSurveyResponses CSSurveyResponse[]
}

/**
 * Contact - Legacy PMO contact model (project-related contacts)
 * @deprecated For CRM use cases, use CRMContact instead which has:
 * - Lifecycle management (LEAD, MQL, SQL, etc.)
 * - Lead scoring
 * - Account hierarchy support
 * Email uniqueness: Per-client (allows same email for contacts at different clients)
 * This differs from CRMContact which enforces per-tenant uniqueness.
 */
model Contact {
  id        Int      @id @default(autoincrement())
  tenantId  String?
  clientId  Int
  name      String
  email     String
  role      String?
  phone     String?
  notes     String?
  archived  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant         Tenant?       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  client         Client        @relation(fields: [clientId], references: [id], onDelete: Cascade)
  convertedLeads InboundLead[]

  // Customer Success Platform relations
  engagement        ContactEngagement?
  csActivityLogs    CSActivityLog[]
  csSurveyResponses CSSurveyResponse[]

  // Email unique per client (legacy behavior)
  // CRMContact uses @@unique([tenantId, email]) for stricter deduplication
  @@unique([clientId, email])
}

model InboundLead {
  id               Int             @id @default(autoincrement())
  tenantId         String?
  name             String?
  email            String
  company          String?
  website          String?
  source           LeadSource      @default(OTHER)
  serviceInterest  ServiceInterest @default(NOT_SURE)
  message          String?
  status           LeadStatus      @default(NEW)
  ownerUserId      Int?
  clientId         Int?
  primaryContactId Int?
  firstResponseAt  DateTime?
  // Tracking fields for website submissions
  page             String?
  utmSource        String?
  utmMedium        String?
  utmCampaign      String?
  utmContent       String?
  utmTerm          String?
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt

  tenant         Tenant?  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  owner          User?    @relation(fields: [ownerUserId], references: [id], onDelete: SetNull)
  client         Client?  @relation(fields: [clientId], references: [id], onDelete: SetNull)
  primaryContact Contact? @relation(fields: [primaryContactId], references: [id], onDelete: SetNull)

  @@index([status, createdAt(sort: Desc)])
  @@index([ownerUserId, status])
  @@index([source, createdAt(sort: Desc)])
}

model Project {
  id        Int           @id @default(autoincrement())
  tenantId  String?
  clientId  Int? // @deprecated - use accountId
  accountId Int? // Preferred: link to CRM Account
  ownerId   Int
  name      String
  status    ProjectStatus @default(PLANNING)
  startDate DateTime?
  endDate   DateTime?
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  // M7 - Status & Reporting
  healthStatus    ProjectHealthStatus @default(ON_TRACK)
  statusSummary   String?
  statusUpdatedAt DateTime?

  // Note: Pipeline fields (pipelineStage, pipelineValue, probability, expectedCloseDate, leadSource, lostReason)
  // have been removed. Use CRM Opportunity for sales pipeline tracking.
  // See MED-04 in TECHNICAL-DEBT-REPORT.md for migration details.

  // Customer Success Platform fields
  renewalDate           DateTime? // When the contract/project renews
  contractValue         Decimal?  @db.Decimal(12, 2) // Annual/total contract value
  licenseCount          Int? // Number of licenses purchased
  licenseUtilization    Float? // Percentage of licenses in use
  lastContactDate       DateTime? // Last interaction with customer
  nextCheckInDate       DateTime? // Next scheduled check-in
  npsScore              Int? // Most recent NPS score (0-10)
  csatScore             Float? // Most recent CSAT score
  onboardingComplete    Boolean   @default(false)
  onboardingCompletedAt DateTime?

  // Tenant visibility settings
  isSharedWithTenant Boolean @default(false) // When true, all users in tenant can view this project

  tenant            Tenant?            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  client            Client?            @relation(fields: [clientId], references: [id], onDelete: Cascade)
  account           Account?           @relation(fields: [accountId], references: [id], onDelete: Cascade)
  owner             User               @relation(fields: [ownerId], references: [id])
  documents         Document[]
  tasks             Task[]
  meetings          Meeting[]
  milestones        Milestone[]
  assets            ProjectAIAsset[]
  marketingContents MarketingContent[]
  campaigns         Campaign[]

  // Customer Success Platform relations
  healthScores      CustomerHealthScore[]
  successPlans      SuccessPlan[]
  ctas              CTA[]
  csActivityLogs    CSActivityLog[]
  csMetricSnapshots CSMetricSnapshot[]
  csSurveyResponses CSSurveyResponse[]

  // Finance Tracking relations
  budgets  Budget[]
  expenses Expense[]

  @@index([status])
  @@index([renewalDate])
  @@index([healthStatus, renewalDate])
  @@index([accountId])
}

model Document {
  id        Int          @id @default(autoincrement())
  clientId  Int? // @deprecated - use accountId
  accountId Int? // Preferred: link to CRM Account
  projectId Int?
  ownerId   Int
  type      DocumentType @default(OTHER)
  filename  String
  url       String
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  client  Client?  @relation(fields: [clientId], references: [id], onDelete: Cascade)
  account Account? @relation(fields: [accountId], references: [id], onDelete: Cascade)
  project Project? @relation(fields: [projectId], references: [id], onDelete: SetNull)
  owner   User     @relation(fields: [ownerId], references: [id])

  @@index([projectId])
  @@index([accountId])
}

model Milestone {
  id          Int             @id @default(autoincrement())
  tenantId    String?
  projectId   Int
  name        String
  description String?
  dueDate     DateTime?
  status      MilestoneStatus @default(NOT_STARTED)
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  tenant  Tenant? @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  tasks   Task[]
}

model Task {
  id              Int        @id @default(autoincrement())
  tenantId        String?
  projectId       Int
  ownerId         Int
  milestoneId     Int?
  sourceMeetingId Int?
  linkedAssetId   Int?
  parentTaskId    Int?
  title           String
  description     String?
  status          TaskStatus @default(BACKLOG)
  priority        Priority   @default(P1)
  dueDate         DateTime?
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt

  tenant        Tenant?    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  project       Project    @relation(fields: [projectId], references: [id], onDelete: Cascade)
  owner         User       @relation(fields: [ownerId], references: [id])
  milestone     Milestone? @relation(fields: [milestoneId], references: [id], onDelete: SetNull)
  sourceMeeting Meeting?   @relation(fields: [sourceMeetingId], references: [id], onDelete: SetNull)
  parentTask    Task?      @relation("SubTasks", fields: [parentTaskId], references: [id], onDelete: Cascade)
  subTasks      Task[]     @relation("SubTasks")

  @@index([projectId, status, priority])
  @@index([ownerId, status])
  @@index([parentTaskId])
}

model Meeting {
  id        Int             @id @default(autoincrement())
  tenantId  String?
  projectId Int
  accountId Int? // Preferred: link to CRM Account
  title     String
  date      DateTime
  time      String
  attendees String[]
  notes     String?
  decisions String?
  risks     String?
  category  MeetingCategory @default(DELIVERY)
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt

  tenant            Tenant?            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  project           Project            @relation(fields: [projectId], references: [id], onDelete: Cascade)
  account           Account?           @relation(fields: [accountId], references: [id], onDelete: Cascade)
  sourceTasks       Task[]
  marketingContents MarketingContent[]

  @@index([projectId, date(sort: Desc)])
  @@index([category, date(sort: Desc)])
  @@index([accountId])
}

model AIAsset {
  id          Int       @id @default(autoincrement())
  tenantId    String?
  type        AssetType
  name        String
  description String?
  content     Json?
  tags        String[]  @default([])
  archived    Boolean   @default(false)
  isTemplate  Boolean   @default(false)
  clientId    Int? // @deprecated - use accountId
  accountId   Int? // Preferred: link to CRM Account
  createdById Int?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  tenant    Tenant?          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  client    Client?          @relation(fields: [clientId], references: [id], onDelete: SetNull)
  account   Account?         @relation(fields: [accountId], references: [id], onDelete: SetNull)
  createdBy User?            @relation(fields: [createdById], references: [id])
  projects  ProjectAIAsset[]

  @@unique([name, clientId])
  @@index([accountId])
}

model ProjectAIAsset {
  id        Int      @id @default(autoincrement())
  projectId Int
  assetId   Int
  notes     String?
  createdAt DateTime @default(now())

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  asset   AIAsset @relation(fields: [assetId], references: [id], onDelete: Cascade)

  @@unique([projectId, assetId])
}

model MarketingContent {
  id       Int             @id @default(autoincrement())
  tenantId String?
  name     String
  slug     String?         @unique
  type     ContentType
  channel  ContentChannel?
  status   ContentStatus   @default(DRAFT)
  content  Json?
  summary  String?
  tags     String[]        @default([])

  // Relations
  clientId        Int? // @deprecated - use accountId
  accountId       Int? // Preferred: link to CRM Account
  projectId       Int?
  sourceMeetingId Int?
  createdById     Int?
  sourceContentId Int?
  campaignId      Int?

  // Publishing metadata
  publishedAt            DateTime?
  scheduledFor           DateTime?
  publishingConnectionId Int?
  publishedUrl           String?
  publishError           String?
  lastPublishAttempt     DateTime?
  archived               Boolean   @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant               Tenant?               @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  client               Client?               @relation(fields: [clientId], references: [id], onDelete: Cascade)
  account              Account?              @relation(fields: [accountId], references: [id], onDelete: Cascade)
  project              Project?              @relation(fields: [projectId], references: [id], onDelete: SetNull)
  sourceMeeting        Meeting?              @relation(fields: [sourceMeetingId], references: [id], onDelete: SetNull)
  createdBy            User?                 @relation(fields: [createdById], references: [id])
  campaign             Campaign?             @relation(fields: [campaignId], references: [id], onDelete: SetNull)
  publishingConnection PublishingConnection? @relation(fields: [publishingConnectionId], references: [id], onDelete: SetNull)

  // Self-referential relation for repurposed content
  sourceContent     MarketingContent?  @relation("RepurposedFrom", fields: [sourceContentId], references: [id], onDelete: SetNull)
  repurposedContent MarketingContent[] @relation("RepurposedFrom")

  @@index([clientId, type])
  @@index([accountId, type])
  @@index([status, createdAt(sort: Desc)])
  @@index([projectId])
  @@index([campaignId])
  @@index([slug])
}

model Campaign {
  id          Int            @id @default(autoincrement())
  tenantId    String?
  name        String
  description String?
  goals       Json?
  status      CampaignStatus @default(PLANNING)
  startDate   DateTime?
  endDate     DateTime?
  archived    Boolean        @default(false)

  // Relations
  clientId    Int? // @deprecated - use accountId
  accountId   Int? // Preferred: link to CRM Account
  projectId   Int?
  createdById Int?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant    Tenant?            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  client    Client?            @relation(fields: [clientId], references: [id], onDelete: Cascade)
  account   Account?           @relation(fields: [accountId], references: [id], onDelete: Cascade)
  project   Project?           @relation(fields: [projectId], references: [id], onDelete: SetNull)
  createdBy User?              @relation(fields: [createdById], references: [id])
  contents  MarketingContent[]

  @@index([clientId, status])
  @@index([accountId, status])
  @@index([status, startDate])
}

model BrandProfile {
  id                  Int      @id @default(autoincrement())
  clientId            Int      @unique
  name                String
  description         String?
  logoUrl             String?
  primaryColor        String?
  secondaryColor      String?
  accentColor         String?
  fonts               Json?
  metadata            Json? // Extended brand data: full color palette, file formats, etc.
  toneVoiceGuidelines String?
  valueProposition    String?
  targetAudience      String?
  keyMessages         String[] @default([])
  archived            Boolean  @default(false)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  client Client       @relation(fields: [clientId], references: [id], onDelete: Cascade)
  assets BrandAsset[]
}

model BrandAsset {
  id             Int            @id @default(autoincrement())
  brandProfileId Int
  name           String
  type           BrandAssetType @default(OTHER)
  url            String
  description    String?
  tags           String[]       @default([])
  archived       Boolean        @default(false)
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  brandProfile BrandProfile @relation(fields: [brandProfileId], references: [id], onDelete: Cascade)

  @@index([brandProfileId, type])
}

model PublishingConnection {
  id           Int                @id @default(autoincrement())
  clientId     Int
  platform     PublishingPlatform
  accountName  String
  accessToken  String
  refreshToken String?
  expiresAt    DateTime?
  isActive     Boolean            @default(true)
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt

  client            Client             @relation(fields: [clientId], references: [id], onDelete: Cascade)
  publishedContents MarketingContent[]

  @@unique([clientId, platform, accountName])
  @@index([clientId, platform])
}

// ============================================================================
// FEATURE FLAGS & MODULE CONFIGURATION
// ============================================================================

/**
 * FeatureFlag - Global feature flags for the system
 * Used for gradual rollouts, A/B testing, and feature toggling
 */
model FeatureFlag {
  id          Int     @id @default(autoincrement())
  key         String  @unique
  name        String
  description String?
  enabled     Boolean @default(false)

  // Percentage rollout (0-100) for gradual rollouts
  rolloutPercentage Int @default(100)

  // JSON for additional configuration
  // Example: { "allowedUserIds": [1, 2, 3], "allowedRoles": ["ADMIN"] }
  config Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([key, enabled])
}

/**
 * TenantModuleConfig - Per-tenant/deployment module configuration
 * Allows enabling/disabling modules for specific tenants or deployments
 * Tenant identifier can be:
 * - "default" for system-wide defaults
 * - A specific tenant/customer identifier
 * - An environment identifier (e.g., "production", "staging")
 */
model TenantModuleConfig {
  id Int @id @default(autoincrement())

  // Tenant identifier - "default" for system defaults, or specific tenant ID
  tenantId String @default("default")

  // Module ID from the ModuleId type (dashboard, tasks, clients, projects, assets, marketing, leads, pipeline, admin)
  moduleId String

  // Whether this module is enabled for this tenant
  enabled Boolean @default(true)

  // Optional: override module settings for this tenant
  // Example: { "maxUsers": 10, "customFeatures": ["featureA"] }
  settings Json?

  // Audit fields
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  updatedBy Int?

  @@unique([tenantId, moduleId])
  @@index([tenantId])
  @@index([moduleId, enabled])
}

// ============================================================================
// PHASE 1 AI TOOLS - TOOL 1.1: CUSTOMER SERVICE CHATBOT
// ============================================================================

enum ChatChannel {
  WEB
  SMS
  FACEBOOK_MESSENGER
  WHATSAPP
  INSTAGRAM_DM
  EMAIL
  SLACK
  TEAMS
}

enum ConversationStatus {
  ACTIVE
  WAITING_CUSTOMER
  WAITING_AGENT
  ESCALATED
  RESOLVED
  CLOSED
}

enum MessageSender {
  CUSTOMER
  BOT
  AGENT
}

enum IntentType {
  ORDER_STATUS
  RETURN_REQUEST
  PRODUCT_INQUIRY
  FAQ
  COMPLAINT
  GENERAL
  ESCALATION
  UNKNOWN
}

/**
 * ChatbotConfig - Configuration for a customer service chatbot
 * Note: accountId is the preferred field; clientId is deprecated
 */
model ChatbotConfig {
  id              Int     @id @default(autoincrement())
  tenantId        String? // Multi-tenant support
  clientId        Int?    @unique // @deprecated - use accountId
  accountId       Int?    @unique // Preferred: link to CRM Account
  name            String
  welcomeMessage  String?
  fallbackMessage String?

  // Feature toggles
  enableOrderTracking Boolean @default(true)
  enableReturns       Boolean @default(true)
  enableFAQ           Boolean @default(true)
  enableHumanHandoff  Boolean @default(true)

  // Channel settings (JSON: { channel: { enabled: boolean, config: {...} } })
  channelSettings Json?

  // Business hours (JSON: { timezone: string, hours: { day: { open: string, close: string } } })
  businessHours Json?

  // Integration credentials (encrypted)
  shopifyApiKey     String?
  woocommerceApiKey String?
  zendeskApiKey     String?
  freshdeskApiKey   String?

  // Widget customization settings
  widgetPosition       String  @default("bottom-right") // bottom-right, bottom-left
  widgetPrimaryColor   String  @default("#3B82F6") // Primary brand color
  widgetTextColor      String  @default("#FFFFFF") // Text color on primary
  widgetBubbleIcon     String  @default("chat") // chat, message, support, custom
  widgetTitle          String? // Custom title in header
  widgetSubtitle       String? // Subtitle text
  widgetAvatarUrl      String? // Bot avatar image URL
  widgetAllowedDomains String? // Comma-separated allowed domains
  widgetCustomCss      String? // Custom CSS overrides

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant         Tenant?             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  client         Client?             @relation(fields: [clientId], references: [id], onDelete: Cascade)
  account        Account?            @relation(fields: [accountId], references: [id], onDelete: Cascade)
  conversations  ChatConversation[]
  knowledgeBase  KnowledgeBaseItem[]
  webhooks       WebhookConfig[]
  channelConfigs ChannelConfig[]

  @@index([tenantId, isActive])
  @@index([clientId, isActive])
  @@index([accountId, isActive])
}

/**
 * WebhookConfig - Webhook endpoints for real-time event notifications
 */
model WebhookConfig {
  id              Int      @id @default(autoincrement())
  chatbotConfigId Int
  name            String // Friendly name for the webhook
  url             String // Target URL
  secret          String // HMAC signing secret
  events          String[] // Array of event types to subscribe to
  isActive        Boolean  @default(true)

  // Retry configuration
  maxRetries   Int @default(3)
  retryDelayMs Int @default(1000)
  timeoutMs    Int @default(30000)

  // Metadata
  lastTriggeredAt DateTime?
  failureCount    Int       @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  chatbotConfig ChatbotConfig        @relation(fields: [chatbotConfigId], references: [id], onDelete: Cascade)
  deliveryLogs  WebhookDeliveryLog[]

  @@index([chatbotConfigId, isActive])
}

/**
 * WebhookDeliveryLog - Log of webhook delivery attempts
 */
model WebhookDeliveryLog {
  id        Int    @id @default(autoincrement())
  webhookId Int
  event     String // Event type that triggered this
  payload   Json // The payload that was sent

  // Delivery status
  statusCode   Int? // HTTP response status
  responseBody String? // Response body (truncated)
  errorMessage String? // Error message if failed

  // Timing
  deliveredAt DateTime?
  durationMs  Int? // How long the request took
  attempt     Int       @default(1) // Which attempt this was

  createdAt DateTime @default(now())

  webhook WebhookConfig @relation(fields: [webhookId], references: [id], onDelete: Cascade)

  @@index([webhookId, createdAt])
}

/**
 * ChannelConfig - Multi-channel messaging configuration (Twilio, Slack, etc.)
 */
model ChannelConfig {
  id              Int    @id @default(autoincrement())
  chatbotConfigId Int
  channel         String // twilio_sms, twilio_whatsapp, slack, teams
  name            String // Friendly name

  // Encrypted credentials and settings
  credentials Json // API keys, tokens (encrypted at rest)
  settings    Json? // Channel-specific settings

  // Phone number or channel identifier
  identifier String? // e.g., +1234567890 for SMS, channel ID for Slack

  isActive   Boolean @default(true)
  isVerified Boolean @default(false) // Whether credentials are verified

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  chatbotConfig ChatbotConfig @relation(fields: [chatbotConfigId], references: [id], onDelete: Cascade)

  @@unique([chatbotConfigId, channel])
  @@index([chatbotConfigId, isActive])
}

/**
 * ChatConversation - A conversation session with a customer
 */
model ChatConversation {
  id              Int                @id @default(autoincrement())
  chatbotConfigId Int
  channel         ChatChannel        @default(WEB)
  status          ConversationStatus @default(ACTIVE)

  // Customer info
  customerEmail      String?
  customerName       String?
  customerPhone      String?
  externalCustomerId String?

  // Session metadata
  sessionId String    @unique
  startedAt DateTime  @default(now())
  endedAt   DateTime?

  // Escalation info
  escalatedAt        DateTime?
  escalatedToAgentId Int?
  escalationReason   String?

  // Satisfaction (1-5 stars)
  satisfactionRating   Int?
  satisfactionFeedback String?

  // Order context
  orderNumber String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  chatbotConfig ChatbotConfig @relation(fields: [chatbotConfigId], references: [id], onDelete: Cascade)
  messages      ChatMessage[]

  @@index([chatbotConfigId, status])
  @@index([customerEmail])
  @@index([sessionId])
  @@index([createdAt(sort: Desc)])
}

/**
 * ChatMessage - Individual message in a conversation
 */
model ChatMessage {
  id             Int           @id @default(autoincrement())
  conversationId Int
  sender         MessageSender
  content        String

  // AI analysis
  detectedIntent   IntentType?
  intentConfidence Float?
  sentiment        Float? // -1 to 1 scale

  // For bot messages
  suggestedActions Json? // Array of action buttons

  // Metadata
  metadata Json?

  createdAt DateTime @default(now())

  conversation ChatConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId, createdAt])
}

/**
 * KnowledgeBaseItem - FAQ and knowledge base entries for the chatbot
 */
model KnowledgeBaseItem {
  id              Int @id @default(autoincrement())
  chatbotConfigId Int

  // Content
  question String
  answer   String
  keywords String[] @default([])
  category String?

  // For ordering and display
  priority    Int     @default(0)
  isPublished Boolean @default(true)

  // Analytics
  viewCount       Int @default(0)
  helpfulCount    Int @default(0)
  notHelpfulCount Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  chatbotConfig ChatbotConfig @relation(fields: [chatbotConfigId], references: [id], onDelete: Cascade)

  @@index([chatbotConfigId, category])
  @@index([chatbotConfigId, isPublished])
}

/**
 * ChatAnalytics - Daily aggregated analytics for chatbot performance
 */
model ChatAnalytics {
  id              Int      @id @default(autoincrement())
  chatbotConfigId Int
  date            DateTime @db.Date

  // Volume metrics
  totalConversations Int @default(0)
  totalMessages      Int @default(0)
  uniqueCustomers    Int @default(0)

  // Performance metrics
  avgResponseTimeMs     Int?
  avgConversationLength Int?

  // Resolution metrics
  resolvedByBot       Int @default(0)
  escalatedToAgent    Int @default(0)
  abandonedByCustomer Int @default(0)

  // Satisfaction metrics
  avgSatisfactionRating Float?
  totalRatings          Int    @default(0)

  // Intent breakdown (JSON: { intent: count })
  intentBreakdown Json?

  // Channel breakdown (JSON: { channel: count })
  channelBreakdown Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([chatbotConfigId, date])
  @@index([chatbotConfigId, date(sort: Desc)])
}

// ============================================================================
// PHASE 1 AI TOOLS - TOOL 1.2: PRODUCT DESCRIPTION GENERATOR
// ============================================================================

enum Marketplace {
  GENERIC
  AMAZON
  EBAY
  SHOPIFY
  ETSY
  WALMART
  WOOCOMMERCE
}

enum GenerationJobStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}

enum ComplianceMode {
  NONE
  FOOD
  SUPPLEMENTS
  COSMETICS
  AUTOMOTIVE
  MEDICAL
}

enum ComplianceStatus {
  PENDING
  APPROVED
  FLAGGED
  REQUIRES_REVIEW
}

/**
 * ProductDescriptionConfig - Configuration for product description generation
 * Enhanced with multi-tenancy, compliance, and language support
 */
model ProductDescriptionConfig {
  id       Int    @id @default(autoincrement())
  tenantId String

  // Account relationship (replaces legacy Client)
  accountId Int @unique

  // Legacy client relationship (deprecated - use accountId)
  clientId Int? @unique

  // Default settings
  defaultTone   String? // professional, casual, luxurious, etc.
  defaultLength String? // short, medium, long

  // Brand voice settings (trained from examples)
  // Structure: { toneMarkers: string[], prohibitedWords: string[], preferredPhrases: string[], styleRules: object, sampleIds: string[], trainingStatus: string }
  brandVoiceProfile Json?

  // SEO settings
  enableSEO      Boolean  @default(true)
  targetKeywords String[] @default([])

  // Compliance settings
  complianceMode ComplianceMode @default(NONE)

  // Language settings
  defaultLanguage    String   @default("en")
  supportedLanguages String[] @default(["en"])

  // Integration credentials
  shopifyApiKey        String?
  amazonMwsCredentials Json?

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant    Tenant                @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  account   Account               @relation(fields: [accountId], references: [id], onDelete: Cascade)
  client    Client?               @relation(fields: [clientId], references: [id], onDelete: SetNull)
  products  Product[]
  templates DescriptionTemplate[]
  bulkJobs  BulkGenerationJob[]

  @@index([tenantId])
  @@index([accountId, isActive])
}

/**
 * Product - Product data for description generation
 */
model Product {
  id       Int @id @default(autoincrement())
  configId Int

  // Basic info
  name        String
  sku         String?
  category    String?
  subcategory String?

  // Product attributes
  attributes Json? // { color, size, material, etc. }

  // Images
  imageUrls String[] @default([])

  // Original/source description
  sourceDescription String?

  // External IDs
  shopifyProductId String?
  amazonAsin       String?

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  config       ProductDescriptionConfig @relation(fields: [configId], references: [id], onDelete: Cascade)
  descriptions ProductDescription[]

  @@index([configId, isActive])
  @@index([sku])
}

/**
 * ProductDescription - Generated product descriptions
 * Enhanced with multi-language, SEO scoring, and compliance tracking
 */
model ProductDescription {
  id        Int @id @default(autoincrement())
  productId Int

  // Generated content
  title            String?
  shortDescription String?
  longDescription  String?
  bulletPoints     String[] @default([])

  // SEO content
  metaTitle       String?
  metaDescription String?
  keywords        String[] @default([])

  // Marketplace-specific
  marketplace Marketplace @default(GENERIC)

  // Language support
  language String @default("en")

  // SEO scoring (0-100)
  seoScore         Int?
  readabilityScore Float?

  // Compliance tracking
  complianceStatus ComplianceStatus @default(PENDING)
  complianceNotes  String[]         @default([])

  // Template used for generation
  templateId Int?

  // A/B testing
  variant   String? // A, B, C, etc.
  isControl Boolean @default(false)

  // Performance tracking
  impressions Int @default(0)
  clicks      Int @default(0)
  conversions Int @default(0)

  // Status
  isPublished Boolean   @default(false)
  publishedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId, marketplace])
  @@index([productId, variant])
  @@index([productId, language])
}

/**
 * DescriptionTemplate - Templates for generating descriptions
 */
model DescriptionTemplate {
  id       Int @id @default(autoincrement())
  configId Int

  name        String
  description String?

  // Template content with placeholders
  titleTemplate     String?
  shortDescTemplate String?
  longDescTemplate  String?
  bulletTemplate    String?

  // Target marketplace
  marketplace Marketplace @default(GENERIC)

  // Category-specific template
  category String?

  isDefault Boolean @default(false)
  isActive  Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  config ProductDescriptionConfig @relation(fields: [configId], references: [id], onDelete: Cascade)

  @@index([configId, marketplace])
  @@index([configId, category])
}

/**
 * BulkGenerationJob - Batch processing for bulk description generation
 * Enhanced with multi-language targeting and resume capability
 */
model BulkGenerationJob {
  id       Int @id @default(autoincrement())
  configId Int

  status GenerationJobStatus @default(PENDING)

  // Job details
  totalItems      Int @default(0)
  processedItems  Int @default(0)
  successfulItems Int @default(0)
  failedItems     Int @default(0)

  // Settings for this job
  marketplace Marketplace @default(GENERIC)
  templateId  Int?
  settings    Json?

  // Language targeting for multi-language generation
  targetLanguages String[] @default(["en"])

  // Resume capability - track last processed position
  lastProcessedIndex Int @default(0)

  // Input file (for CSV import)
  inputFileUrl  String?
  inputFileName String?

  // Output file (for CSV export)
  outputFileUrl  String?
  outputFileName String?

  // Error log with detailed error information
  errorLog Json?

  // Timing
  startedAt   DateTime?
  completedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  config ProductDescriptionConfig @relation(fields: [configId], references: [id], onDelete: Cascade)

  @@index([configId, status])
  @@index([status, createdAt(sort: Desc)])
}

// ============================================================================
// PHASE 1 AI TOOLS - TOOL 1.3: AI SCHEDULING ASSISTANT
// ============================================================================

enum AppointmentStatus {
  SCHEDULED
  CONFIRMED
  CHECKED_IN
  IN_PROGRESS
  COMPLETED
  CANCELLED
  NO_SHOW
  RESCHEDULED
}

enum ReminderChannel {
  SMS
  EMAIL
  PUSH
}

enum ReminderStatus {
  PENDING
  SENT
  DELIVERED
  FAILED
}

// New enums for enhanced scheduling features
enum CalendarPlatform {
  GOOGLE
  OUTLOOK
}

enum VideoPlatform {
  ZOOM
  GOOGLE_MEET
  TEAMS
}

enum PaymentTiming {
  BOOKING // Collect at time of booking
  APPOINTMENT // Collect at appointment time
  NONE // No payment collection
}

enum PaymentStatus {
  PENDING
  PROCESSING
  SUCCEEDED
  FAILED
  REFUNDED
  PARTIALLY_REFUNDED
}

enum PaymentType {
  DEPOSIT
  FULL
  REFUND
}

// Type B: Employee/Shift Scheduling enums
enum EmploymentType {
  FULL_TIME
  PART_TIME
  CONTRACTOR
  SEASONAL
  TEMPORARY
}

enum ScheduleStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum ShiftStatus {
  SCHEDULED
  CONFIRMED
  IN_PROGRESS
  COMPLETED
  MISSED
  CANCELLED
}

enum AvailabilityType {
  AVAILABLE
  PREFERRED
  UNAVAILABLE
}

enum TimeOffType {
  VACATION
  SICK
  PERSONAL
  BEREAVEMENT
  JURY_DUTY
  UNPAID
  OTHER
}

enum TimeOffStatus {
  PENDING
  APPROVED
  DENIED
  CANCELLED
}

enum SwapStatus {
  PENDING
  PEER_APPROVED
  APPROVED
  DENIED
  CANCELLED
  EXPIRED
}

/**
 * SchedulingConfig - Configuration for scheduling assistant per account
 *
 * NOTE: This model has been migrated from Client to Account as the primary reference.
 * - accountId is now the preferred reference for new implementations
 * - clientId is kept for backward compatibility with existing data
 */
model SchedulingConfig {
  id        Int  @id @default(autoincrement())
  accountId Int? @unique // Primary reference - links to CRM Account (preferred for new implementations)
  clientId  Int? @unique // Legacy reference - kept for backward compatibility

  // Multi-tenant support
  tenantId String?

  // Practice/Business info
  practiceName String?
  timezone     String  @default("America/New_York")

  // Booking settings
  minAdvanceBookingHours Int     @default(24)
  maxAdvanceBookingDays  Int     @default(90)
  defaultSlotDurationMin Int     @default(30)
  bufferBetweenSlotsMin  Int     @default(0)
  allowWalkIns           Boolean @default(false)
  requirePhone           Boolean @default(true)
  autoConfirm            Boolean @default(false)

  // Booking page settings
  showProviderSelection Boolean @default(true)
  showAppointmentTypes  Boolean @default(true)
  requireIntakeForm     Boolean @default(false)
  cancellationPolicy    String?

  // Reminder settings
  enableReminders     Boolean @default(true)
  reminderHoursBefore Int[]   @default([24, 2])

  // No-show prediction settings
  enableNoShowPrediction Boolean @default(true)
  noShowThreshold        Float   @default(0.7)
  enableOverbooking      Boolean @default(false)

  // Waitlist settings
  enableWaitlist Boolean @default(true)

  // HIPAA compliance
  isHipaaEnabled Boolean @default(false)

  // Industry template settings
  industryTemplate String? // healthcare, professional_services, home_services, beauty_wellness, restaurant
  templateSettings Json? // Stores template-specific configuration

  // Integration credentials (encrypted)
  twilioAccountSid     String?
  twilioAuthToken      String?
  sendgridApiKey       String?
  googleCalendarCreds  Json?
  outlookCalendarCreds Json?

  // EHR integration
  ehrSystem      String? // epic, cerner, drchrono, etc.
  ehrCredentials Json?

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  account          Account?          @relation(fields: [accountId], references: [id], onDelete: SetNull)
  client           Client?           @relation(fields: [clientId], references: [id], onDelete: Cascade)
  tenant           Tenant?           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  providers        Provider[]
  appointmentTypes AppointmentType[]
  appointments     Appointment[]
  waitlistEntries  WaitlistEntry[]
  intakeFormFields SchedulingIntakeField[]

  // New public booking and integration relations
  bookingPages         BookingPage[]
  calendarIntegrations CalendarIntegration[]
  videoMeetingConfigs  VideoMeetingConfig[]
  paymentConfig        PaymentConfig?

  @@index([accountId, isActive])
  @@index([clientId, isActive])
  @@index([tenantId])
}

/**
 * Provider - Service providers (doctors, therapists, etc.)
 */
model Provider {
  id       Int @id @default(autoincrement())
  configId Int

  // Basic info
  name      String
  email     String?
  phone     String?
  title     String? // Dr., NP, etc.
  specialty String?

  // External IDs
  externalProviderId String?
  npiNumber          String?

  // Availability settings (JSON: { dayOfWeek: [{ start, end }] })
  availabilitySchedule Json?

  // Override dates (JSON: { date: [{ start, end }] or "blocked" })
  availabilityOverrides Json?

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  config               SchedulingConfig      @relation(fields: [configId], references: [id], onDelete: Cascade)
  appointments         Appointment[]
  calendarIntegrations CalendarIntegration[]

  @@index([configId, isActive])
}

/**
 * AppointmentType - Types of appointments offered
 */
model AppointmentType {
  id       Int @id @default(autoincrement())
  configId Int

  name            String
  description     String?
  durationMinutes Int     @default(30)

  // Pricing (optional)
  price    Decimal? @db.Decimal(10, 2)
  currency String?  @default("USD")

  // Booking rules
  requiresDeposit Boolean  @default(false)
  depositAmount   Decimal? @db.Decimal(10, 2)
  depositPercent  Int? // Percentage-based deposit (0-100)

  // Display
  color    String?
  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  config       SchedulingConfig @relation(fields: [configId], references: [id], onDelete: Cascade)
  appointments Appointment[]

  @@index([configId, isActive])
}

/**
 * SchedulingIntakeField - Custom intake form fields for scheduling
 * These are lightweight intake fields specific to booking appointments,
 * distinct from the full IntakeForm system.
 */
model SchedulingIntakeField {
  id       Int @id @default(autoincrement())
  configId Int

  // Field definition
  name        String
  label       String
  type        String // text, email, phone, textarea, select, checkbox, date
  placeholder String?

  // Validation
  required Boolean  @default(false)
  options  String[] @default([]) // For select/radio fields

  // Layout
  sortOrder Int @default(0)
  isActive  Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  config SchedulingConfig @relation(fields: [configId], references: [id], onDelete: Cascade)

  @@index([configId, sortOrder])
}

/**
 * Appointment - Scheduled appointments
 */
model Appointment {
  id                Int  @id @default(autoincrement())
  configId          Int
  providerId        Int?
  appointmentTypeId Int?
  bookingPageId     Int?

  // Patient/Client info
  patientName       String
  patientEmail      String?
  patientPhone      String?
  externalPatientId String?

  // Public booking fields
  confirmationCode String? @unique // For self-service access
  customerTimezone String? // Customer's timezone at booking

  // Scheduling
  scheduledAt     DateTime
  durationMinutes Int               @default(30)
  status          AppointmentStatus @default(SCHEDULED)

  // Confirmation
  confirmedAt        DateTime?
  confirmationMethod String?

  // Check-in
  checkedInAt DateTime?

  // Completion
  completedAt DateTime?
  notes       String?

  // Cancellation
  cancelledAt        DateTime?
  cancellationReason String?
  cancelledBy        String? // patient, provider, system

  // Rescheduling
  rescheduledFrom Int?
  rescheduledTo   Int?

  // No-show prediction
  noShowRiskScore   Float?
  noShowPredictedAt DateTime?

  // External sync
  googleEventId    String?
  outlookEventId   String?
  ehrAppointmentId String?

  // Video meeting
  videoMeetingUrl      String?
  videoMeetingId       String?
  videoMeetingPassword String?

  // HIPAA compliance - encrypted notes
  encryptedNotes String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  config              SchedulingConfig            @relation(fields: [configId], references: [id], onDelete: Cascade)
  provider            Provider?                   @relation(fields: [providerId], references: [id], onDelete: SetNull)
  appointmentType     AppointmentType?            @relation(fields: [appointmentTypeId], references: [id], onDelete: SetNull)
  bookingPage         BookingPage?                @relation(fields: [bookingPageId], references: [id], onDelete: SetNull)
  reminders           AppointmentReminder[]
  intakeFormResponses BookingIntakeFormResponse[]
  paymentTransactions PaymentTransaction[]

  @@index([configId, scheduledAt])
  @@index([configId, status])
  @@index([providerId, scheduledAt])
  @@index([patientEmail])
  @@index([confirmationCode])
}

/**
 * AppointmentReminder - Reminders sent for appointments
 */
model AppointmentReminder {
  id            Int @id @default(autoincrement())
  appointmentId Int

  channel ReminderChannel
  status  ReminderStatus  @default(PENDING)

  // Scheduling
  scheduledFor DateTime
  sentAt       DateTime?
  deliveredAt  DateTime?

  // Content
  message String?

  // Response
  responseReceived Boolean @default(false)
  responseContent  String?
  responseAction   String? // confirmed, cancelled, rescheduled

  // Error tracking
  errorMessage String?
  retryCount   Int     @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  appointment Appointment @relation(fields: [appointmentId], references: [id], onDelete: Cascade)

  @@index([appointmentId, status])
  @@index([status, scheduledFor])
}

/**
 * WaitlistEntry - Waitlist for cancelled/available slots
 */
model WaitlistEntry {
  id       Int @id @default(autoincrement())
  configId Int

  // Patient info
  patientName  String
  patientEmail String?
  patientPhone String?

  // Preferences
  preferredProviderId Int?
  preferredDays       String[] @default([])
  preferredTimeStart  String? // HH:MM format
  preferredTimeEnd    String?

  // Priority (lower = higher priority)
  priority Int @default(100)

  // Status
  isActive            Boolean   @default(true)
  notifiedAt          DateTime?
  bookedAt            DateTime?
  bookedAppointmentId Int?

  expiresAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  config SchedulingConfig @relation(fields: [configId], references: [id], onDelete: Cascade)

  @@index([configId, isActive])
  @@index([configId, priority])
}

/**
 * NoShowPredictionModel - ML model performance tracking
 */
model NoShowPredictionLog {
  id            Int @id @default(autoincrement())
  configId      Int
  appointmentId Int

  // Prediction details
  predictedScore Float
  predictedAt    DateTime

  // Actual outcome
  actualOutcome     Boolean? // true = no-show, false = showed up
  outcomeRecordedAt DateTime?

  // Features used (for model improvement)
  features Json?

  createdAt DateTime @default(now())

  @@index([configId, predictedAt(sort: Desc)])
  @@index([appointmentId])
}

// ============================================================================
// SCHEDULING ASSISTANT - PUBLIC BOOKING & INTEGRATIONS (Phase 1 Extensions)
// ============================================================================

/**
 * BookingPage - Public booking page configuration
 * Enables customer-facing self-service booking
 */
model BookingPage {
  id       Int @id @default(autoincrement())
  configId Int

  // URL and branding
  slug         String  @unique // e.g., "acme-consulting" -> /book/acme-consulting
  title        String
  description  String?
  logoUrl      String?
  primaryColor String  @default("#3B82F6")

  // Booking settings
  showProviderSelection Boolean @default(true)
  showAppointmentTypes  Boolean @default(true)
  requirePhone          Boolean @default(true)
  requireIntakeForm     Boolean @default(false)

  // SEO
  metaTitle       String?
  metaDescription String?

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  config       SchedulingConfig    @relation(fields: [configId], references: [id], onDelete: Cascade)
  intakeForms  BookingIntakeForm[]
  appointments Appointment[]

  @@index([slug])
  @@index([configId])
}

/**
 * BookingIntakeForm - Custom intake forms for booking pages
 */
model BookingIntakeForm {
  id            Int @id @default(autoincrement())
  bookingPageId Int

  name         String
  description  String?
  fields       Json // Array of field definitions: [{ name, type, label, required, options? }]
  isRequired   Boolean @default(false)
  displayOrder Int     @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  bookingPage BookingPage                 @relation(fields: [bookingPageId], references: [id], onDelete: Cascade)
  responses   BookingIntakeFormResponse[]

  @@index([bookingPageId])
}

/**
 * BookingIntakeFormResponse - Responses to booking intake forms
 */
model BookingIntakeFormResponse {
  id            Int @id @default(autoincrement())
  formId        Int
  appointmentId Int

  responses   Json // Field ID -> value mapping
  submittedAt DateTime @default(now())

  form        BookingIntakeForm @relation(fields: [formId], references: [id], onDelete: Cascade)
  appointment Appointment       @relation(fields: [appointmentId], references: [id], onDelete: Cascade)

  @@index([formId])
  @@index([appointmentId])
}

/**
 * CalendarIntegration - OAuth tokens for calendar sync
 */
model CalendarIntegration {
  id         Int  @id @default(autoincrement())
  configId   Int
  providerId Int? // If null, applies to all providers

  platform       CalendarPlatform
  accessToken    String // Encrypted via AES-256-GCM in calendar.service.ts
  refreshToken   String? // Encrypted via AES-256-GCM in calendar.service.ts
  tokenExpiresAt DateTime?
  calendarId     String // Selected calendar ID from provider
  syncEnabled    Boolean          @default(true)
  lastSyncAt     DateTime?
  lastSyncError  String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  config   SchedulingConfig @relation(fields: [configId], references: [id], onDelete: Cascade)
  provider Provider?        @relation(fields: [providerId], references: [id], onDelete: SetNull)

  @@unique([configId, providerId, platform])
  @@index([configId])
}

/**
 * VideoMeetingConfig - Video conferencing integration settings
 */
model VideoMeetingConfig {
  id       Int @id @default(autoincrement())
  configId Int

  platform        VideoPlatform
  accessToken     String // MUST encrypt via utils/crypto.ts when service is implemented
  refreshToken    String? // MUST encrypt via utils/crypto.ts when service is implemented
  tokenExpiresAt  DateTime?
  defaultSettings Json? // Platform-specific settings

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  config SchedulingConfig @relation(fields: [configId], references: [id], onDelete: Cascade)

  @@unique([configId, platform])
}

/**
 * PaymentConfig - Stripe payment configuration for scheduling
 */
model PaymentConfig {
  id       Int @id @default(autoincrement())
  configId Int @unique

  stripeAccountId  String? // Connected Stripe account ID
  stripeOnboarded  Boolean       @default(false)
  currency         String        @default("USD")
  collectPaymentAt PaymentTiming @default(BOOKING)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  config SchedulingConfig @relation(fields: [configId], references: [id], onDelete: Cascade)
}

/**
 * PaymentTransaction - Payment records for appointments
 */
model PaymentTransaction {
  id            Int @id @default(autoincrement())
  appointmentId Int

  stripePaymentIntentId String?
  stripeChargeId        String?
  amount                Decimal       @db.Decimal(10, 2)
  currency              String
  status                PaymentStatus
  type                  PaymentType // DEPOSIT, FULL, REFUND

  processedAt   DateTime?
  refundedAt    DateTime?
  failureReason String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  appointment Appointment @relation(fields: [appointmentId], references: [id], onDelete: Cascade)

  @@index([appointmentId])
  @@index([stripePaymentIntentId])
}

// ============================================================================
// TYPE B: EMPLOYEE/SHIFT SCHEDULING (Phase 5+)
// ============================================================================

/**
 * ShiftSchedulingConfig - Configuration for employee/shift scheduling
 */
model ShiftSchedulingConfig {
  id        Int    @id @default(autoincrement())
  tenantId  String
  accountId Int? // Link to CRM Account/business

  // Business settings
  businessName String
  timezone     String @default("America/New_York")
  weekStartDay Int    @default(0) // 0 = Sunday, 1 = Monday

  // Overtime rules
  weeklyOvertimeThreshold Int     @default(40) // Hours before overtime
  dailyOvertimeThreshold  Int? // Optional daily threshold
  overtimeMultiplier      Decimal @default(1.5) @db.Decimal(3, 2)

  // Compliance settings
  minRestBetweenShifts Int     @default(8) // Minimum hours between shifts
  maxConsecutiveDays   Int     @default(6) // Max days without day off
  requireBreaks        Boolean @default(true)
  breakDurationMinutes Int     @default(30)
  breakAfterHours      Int     @default(6) // Require break after X hours

  // Notification settings
  schedulePublishLeadDays Int     @default(7) // Days in advance to publish
  enableShiftReminders    Boolean @default(true)
  reminderHoursBefore     Int     @default(12)

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  account   Account?        @relation(fields: [accountId], references: [id], onDelete: SetNull)
  employees ShiftEmployee[]
  shifts    Shift[]
  schedules ShiftSchedule[]
  locations ShiftLocation[]
  roles     ShiftRole[]

  @@index([tenantId])
  @@index([accountId])
}

/**
 * ShiftEmployee - Employee records for shift scheduling
 */
model ShiftEmployee {
  id       Int  @id @default(autoincrement())
  configId Int
  userId   Int? // Link to User if they have system access

  // Basic info
  firstName      String
  lastName       String
  email          String
  phone          String?
  employeeNumber String? // External employee ID

  // Employment details
  roleId         Int?
  hourlyRate     Decimal?       @db.Decimal(10, 2)
  employmentType EmploymentType @default(FULL_TIME)
  hireDate       DateTime?

  // Skills and certifications
  skills         Json? // Array of skill tags
  certifications Json? // Array of { name, expiresAt }

  // Scheduling preferences
  maxHoursPerWeek    Int?
  minHoursPerWeek    Int?
  preferredLocations Json? // Array of location IDs

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  config           ShiftSchedulingConfig  @relation(fields: [configId], references: [id], onDelete: Cascade)
  role             ShiftRole?             @relation(fields: [roleId], references: [id], onDelete: SetNull)
  user             User?                  @relation(fields: [userId], references: [id], onDelete: SetNull)
  shifts           Shift[]
  availability     EmployeeAvailability[]
  timeOffRequests  TimeOffRequest[]
  swapRequestsFrom ShiftSwapRequest[]     @relation("SwapRequester")
  swapRequestsTo   ShiftSwapRequest[]     @relation("SwapTarget")

  @@unique([configId, email])
  @@index([configId])
  @@index([roleId])
}

/**
 * ShiftLocation - Locations/departments for multi-location scheduling
 */
model ShiftLocation {
  id       Int @id @default(autoincrement())
  configId Int

  name     String
  address  String?
  timezone String? // Override config timezone
  color    String  @default("#3B82F6")

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  config ShiftSchedulingConfig @relation(fields: [configId], references: [id], onDelete: Cascade)
  shifts Shift[]

  @@index([configId])
}

/**
 * ShiftRole - Job roles/positions for scheduling
 */
model ShiftRole {
  id       Int @id @default(autoincrement())
  configId Int

  name              String // e.g., "Server", "Manager", "Cashier"
  description       String?
  color             String   @default("#10B981")
  defaultHourlyRate Decimal? @db.Decimal(10, 2)

  // Requirements
  requiredSkills Json? // Skills needed for this role

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  config    ShiftSchedulingConfig @relation(fields: [configId], references: [id], onDelete: Cascade)
  employees ShiftEmployee[]
  shifts    Shift[]

  @@index([configId])
}

/**
 * ShiftSchedule - Weekly/monthly schedule container
 */
model ShiftSchedule {
  id       Int @id @default(autoincrement())
  configId Int

  name      String? // e.g., "Week of Dec 16, 2025"
  startDate DateTime
  endDate   DateTime
  status    ScheduleStatus @default(DRAFT)

  publishedAt DateTime?
  publishedBy Int? // User ID who published

  notes String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  config ShiftSchedulingConfig @relation(fields: [configId], references: [id], onDelete: Cascade)
  shifts Shift[]

  @@index([configId])
  @@index([startDate, endDate])
}

/**
 * Shift - Individual shift assignments
 */
model Shift {
  id         Int  @id @default(autoincrement())
  configId   Int
  scheduleId Int?

  // Assignment
  employeeId Int?
  roleId     Int?
  locationId Int?

  // Timing
  startTime    DateTime
  endTime      DateTime
  breakMinutes Int      @default(0)

  // Status
  status ShiftStatus @default(SCHEDULED)
  isOpen Boolean     @default(false) // Open for claiming

  // Notes
  notes String?
  color String? // Override role/location color

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  config       ShiftSchedulingConfig @relation(fields: [configId], references: [id], onDelete: Cascade)
  schedule     ShiftSchedule?        @relation(fields: [scheduleId], references: [id], onDelete: SetNull)
  employee     ShiftEmployee?        @relation(fields: [employeeId], references: [id], onDelete: SetNull)
  role         ShiftRole?            @relation(fields: [roleId], references: [id], onDelete: SetNull)
  location     ShiftLocation?        @relation(fields: [locationId], references: [id], onDelete: SetNull)
  swapRequests ShiftSwapRequest[]

  @@index([configId])
  @@index([scheduleId])
  @@index([employeeId])
  @@index([startTime, endTime])
}

/**
 * EmployeeAvailability - Employee availability preferences
 */
model EmployeeAvailability {
  id         Int @id @default(autoincrement())
  employeeId Int

  // Recurring weekly availability
  dayOfWeek    Int? // 0-6 (Sunday-Saturday), null for specific date
  specificDate DateTime? // For one-time availability/unavailability

  startTime String // "09:00" format
  endTime   String // "17:00" format

  type  AvailabilityType @default(AVAILABLE)
  notes String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  employee ShiftEmployee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@index([employeeId])
  @@index([dayOfWeek])
  @@index([specificDate])
}

/**
 * TimeOffRequest - Time-off requests (PTO, vacation, sick)
 */
model TimeOffRequest {
  id         Int @id @default(autoincrement())
  employeeId Int

  startDate DateTime
  endDate   DateTime
  type      TimeOffType
  reason    String?

  status      TimeOffStatus @default(PENDING)
  reviewedBy  Int? // User ID of reviewer
  reviewedAt  DateTime?
  reviewNotes String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  employee ShiftEmployee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@index([employeeId])
  @@index([startDate, endDate])
  @@index([status])
}

/**
 * ShiftSwapRequest - Shift swap requests between employees
 */
model ShiftSwapRequest {
  id      Int @id @default(autoincrement())
  shiftId Int

  requesterId      Int
  targetEmployeeId Int? // Null if open swap (anyone can take)

  offeredShiftId Int? // Shift offered in exchange (null for giveaway)

  status SwapStatus @default(PENDING)
  reason String?

  // Approval chain
  peerApprovedAt    DateTime?
  managerApprovedAt DateTime?
  managerApprovedBy Int?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  shift          Shift          @relation(fields: [shiftId], references: [id], onDelete: Cascade)
  requester      ShiftEmployee  @relation("SwapRequester", fields: [requesterId], references: [id], onDelete: Cascade)
  targetEmployee ShiftEmployee? @relation("SwapTarget", fields: [targetEmployeeId], references: [id], onDelete: SetNull)

  @@index([shiftId])
  @@index([requesterId])
  @@index([targetEmployeeId])
  @@index([status])
}

// ============================================================================
// PHASE 1 AI TOOLS - TOOL 1.4: CLIENT INTAKE AUTOMATOR
// ============================================================================

enum IntakeFormStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum FieldType {
  TEXT
  TEXTAREA
  EMAIL
  PHONE
  NUMBER
  DATE
  TIME
  DATETIME
  SELECT
  MULTISELECT
  CHECKBOX
  RADIO
  FILE_UPLOAD
  SIGNATURE
  ADDRESS
  SSN_LAST4
  INSURANCE_INFO
}

enum SubmissionStatus {
  IN_PROGRESS
  SUBMITTED
  UNDER_REVIEW
  APPROVED
  REJECTED
  NEEDS_RESUBMISSION
}

enum DocumentVerificationStatus {
  PENDING
  VERIFIED
  REJECTED
  NEEDS_REVIEW
}

enum WorkflowStepStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  SKIPPED
  BLOCKED
}

/**
 * IntakeConfig - Configuration for client intake automation
 */
model IntakeConfig {
  id       Int     @id @default(autoincrement())
  tenantId String? // Multi-tenant support
  clientId Int     @unique

  // Portal branding
  portalName   String?
  logoUrl      String?
  primaryColor String?
  customDomain String?

  // Compliance settings
  requireIdentityVerification Boolean @default(false)
  requireDocumentVerification Boolean @default(false)
  retentionDays               Int     @default(365)

  // E-signature settings
  docusignAccountId String?
  docusignApiKey    String?
  hellosignApiKey   String?

  // Notification settings
  notifyOnSubmission Boolean  @default(true)
  notifyOnCompletion Boolean  @default(true)
  notificationEmails String[] @default([])

  // Storage integration
  storageProvider    String? // s3, gcs, sharepoint, gdrive, dropbox
  storageCredentials Json?

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant              Tenant?              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  client              Client               @relation(fields: [clientId], references: [id], onDelete: Cascade)
  forms               IntakeForm[]
  submissions         IntakeSubmission[]
  workflows           IntakeWorkflow[]
  complianceTemplates ComplianceTemplate[]

  @@index([tenantId, isActive])
  @@index([clientId, isActive])
}

/**
 * IntakeForm - Form definitions for client intake
 */
model IntakeForm {
  id       Int @id @default(autoincrement())
  configId Int

  name        String
  description String?
  slug        String?

  // Form settings
  status  IntakeFormStatus @default(DRAFT)
  version Int              @default(1)

  // Multi-page support
  isMultiPage Boolean @default(false)

  // Submission settings
  allowSaveProgress Boolean @default(true)
  requireSignature  Boolean @default(false)

  // Expiration
  expiresAfterDays Int?

  // Display order
  sortOrder Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  config      IntakeConfig       @relation(fields: [configId], references: [id], onDelete: Cascade)
  fields      IntakeFormField[]
  submissions IntakeSubmission[]

  @@unique([configId, slug])
  @@index([configId, status])
}

/**
 * IntakeFormField - Individual fields in an intake form
 */
model IntakeFormField {
  id     Int @id @default(autoincrement())
  formId Int

  // Field definition
  name        String
  label       String
  type        FieldType
  placeholder String?
  helpText    String?

  // Validation
  isRequired      Boolean @default(false)
  validationRules Json? // { minLength, maxLength, pattern, etc. }

  // Options for select/radio/checkbox
  options Json? // [{ value, label }]

  // Conditional display
  conditionalLogic Json? // { fieldId, operator, value }

  // Layout
  pageNumber Int     @default(1)
  sortOrder  Int     @default(0)
  width      String? // full, half, third

  // Prefill from source
  prefillSource String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  form IntakeForm @relation(fields: [formId], references: [id], onDelete: Cascade)

  @@index([formId, pageNumber, sortOrder])
}

/**
 * IntakeSubmission - Completed form submissions
 */
model IntakeSubmission {
  id       Int @id @default(autoincrement())
  configId Int
  formId   Int

  // Submitter info
  submitterEmail String
  submitterName  String?
  submitterPhone String?

  // Unique access token for client portal
  accessToken String @unique

  // Status tracking
  status SubmissionStatus @default(IN_PROGRESS)

  // Form data (encrypted for sensitive info)
  formData      Json?
  encryptedData String?

  // Completion tracking
  startedAt   DateTime  @default(now())
  lastSavedAt DateTime?
  submittedAt DateTime?
  reviewedAt  DateTime?
  reviewedBy  Int?

  // E-signature
  signatureUrl       String?
  signedAt           DateTime?
  docusignEnvelopeId String?
  hellosignRequestId String?

  // Expiration
  expiresAt DateTime?

  // Notes from reviewers
  reviewNotes     String?
  rejectionReason String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  config           IntakeConfig       @relation(fields: [configId], references: [id], onDelete: Cascade)
  form             IntakeForm         @relation(fields: [formId], references: [id], onDelete: Cascade)
  documents        IntakeDocument[]
  complianceChecks ComplianceCheck[]
  workflowProgress WorkflowProgress[]
  conversation     IntakeConversation?

  @@index([configId, status])
  @@index([formId, status])
  @@index([submitterEmail])
  @@index([accessToken])
}

/**
 * IntakeConversationStatus - Status of an intake conversation
 */
enum IntakeConversationStatus {
  ACTIVE
  PAUSED
  COMPLETED
  ABANDONED
}

/**
 * IntakeConversation - Conversational intake session linked to submission
 */
model IntakeConversation {
  id           Int @id @default(autoincrement())
  submissionId Int @unique

  // Conversation messages: [{ role: 'user' | 'assistant', content, timestamp, extractedData? }]
  messages Json @default("[]")

  // Current field being collected
  currentFieldId String?

  // Fields that have been completed with extracted data
  completedFields Json @default("[]") // Array of field IDs

  // Conversation status
  status IntakeConversationStatus @default(ACTIVE)

  // Session metadata
  lastActivityAt DateTime @default(now())
  messageCount   Int      @default(0)

  // AI model used for this conversation
  aiModel String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  submission IntakeSubmission @relation(fields: [submissionId], references: [id], onDelete: Cascade)

  @@index([submissionId])
  @@index([status])
}

/**
 * IntakeDocument - Documents uploaded during intake
 */
model IntakeDocument {
  id           Int @id @default(autoincrement())
  submissionId Int

  // Document info
  filename   String
  mimeType   String
  sizeBytes  Int
  storageUrl String

  // Document type
  documentType String // id, insurance_front, insurance_back, etc.

  // Verification
  verificationStatus DocumentVerificationStatus @default(PENDING)
  verifiedAt         DateTime?
  verifiedBy         Int?
  verificationNotes  String?

  // AI extraction results
  extractedData        Json?
  extractionConfidence Float?

  // Encryption
  isEncrypted     Boolean @default(false)
  encryptionKeyId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  submission IntakeSubmission @relation(fields: [submissionId], references: [id], onDelete: Cascade)

  @@index([submissionId, documentType])
}

/**
 * ComplianceTemplate - Compliance checklist templates
 */
model ComplianceTemplate {
  id       Int @id @default(autoincrement())
  configId Int

  name        String
  description String?

  // Industry/use case
  industry String?
  useCase  String?

  // Requirements as JSON array
  requirements Json // [{ id, name, description, isRequired, documentTypes }]

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  config IntakeConfig      @relation(fields: [configId], references: [id], onDelete: Cascade)
  checks ComplianceCheck[]

  @@index([configId, isActive])
}

/**
 * ComplianceCheck - Compliance status for a submission
 */
model ComplianceCheck {
  id           Int @id @default(autoincrement())
  submissionId Int
  templateId   Int

  // Status per requirement (JSON: { requirementId: status })
  requirementStatus Json?

  // Overall status
  isComplete  Boolean   @default(false)
  completedAt DateTime?

  // Notes
  notes String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  submission IntakeSubmission   @relation(fields: [submissionId], references: [id], onDelete: Cascade)
  template   ComplianceTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@unique([submissionId, templateId])
  @@index([submissionId])
}

/**
 * IntakeWorkflow - Workflow definitions for intake process
 */
model IntakeWorkflow {
  id       Int @id @default(autoincrement())
  configId Int

  name        String
  description String?

  // Workflow steps as JSON
  steps Json // [{ id, name, type, config, order }]

  // Trigger conditions
  triggerFormIds Int[]   @default([])
  autoStart      Boolean @default(true)

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  config   IntakeConfig       @relation(fields: [configId], references: [id], onDelete: Cascade)
  progress WorkflowProgress[]

  @@index([configId, isActive])
}

/**
 * WorkflowProgress - Progress tracking for submissions in workflows
 */
model WorkflowProgress {
  id           Int @id @default(autoincrement())
  submissionId Int
  workflowId   Int

  // Current step
  currentStepId String?

  // Step statuses (JSON: { stepId: { status, completedAt, data } })
  stepStatuses Json?

  // Overall status
  isComplete  Boolean   @default(false)
  completedAt DateTime?

  // Assigned staff
  assignedTo Int?

  // SLA tracking
  dueAt     DateTime?
  isOverdue Boolean   @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  submission IntakeSubmission @relation(fields: [submissionId], references: [id], onDelete: Cascade)
  workflow   IntakeWorkflow   @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  @@unique([submissionId, workflowId])
  @@index([workflowId, isComplete])
  @@index([assignedTo, isComplete])
}

// ============================================================================
// PHASE 2 AI TOOLS - TOOL 2.1: SMART DOCUMENT ANALYZER
// ============================================================================

enum DocumentFormat {
  PDF
  WORD
  EXCEL
  IMAGE
  SCANNED
  TEXT
  OTHER
}

enum AnalysisStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  NEEDS_REVIEW
}

enum ComplianceLevel {
  PASS
  WARNING
  FAIL
  NOT_APPLICABLE
}

// Universal document categories (highest demand)
enum DocumentCategory {
  INVOICE
  CONTRACT
  COMPLIANCE
  HEALTHCARE
  LEGAL
  FINANCIAL
  REAL_ESTATE
  MANUFACTURING
  GENERAL
  OTHER
}

// Target industries for specialized templates
enum IndustryType {
  HEALTHCARE
  LEGAL
  FINANCIAL_SERVICES
  REAL_ESTATE
  MANUFACTURING
  RETAIL
  PROFESSIONAL_SERVICES
  TECHNOLOGY
  CONSTRUCTION
  EDUCATION
  GOVERNMENT
  NONPROFIT
  OTHER
}

// Integration types for external systems
enum IntegrationType {
  QUICKBOOKS
  XERO
  SALESFORCE
  DOCUSIGN
  GOOGLE_DRIVE
  SHAREPOINT
  DROPBOX
  SLACK
  WEBHOOK
  API
}

// Workflow routing action types
enum WorkflowActionType {
  ROUTE_TO_USER
  ROUTE_TO_DEPARTMENT
  SEND_NOTIFICATION
  TRIGGER_INTEGRATION
  MARK_FOR_REVIEW
  AUTO_APPROVE
  ESCALATE
}

/**
 * DocumentAnalyzerConfig - Configuration for smart document analysis
 * Note: accountId is the preferred field; clientId is deprecated
 */
model DocumentAnalyzerConfig {
  id        Int     @id @default(autoincrement())
  tenantId  String? // Multi-tenant support
  clientId  Int?    @unique // @deprecated - use accountId
  accountId Int?    @unique // Preferred: link to CRM Account

  // Industry configuration for specialized templates
  industryType      IndustryType       @default(OTHER)
  enabledCategories DocumentCategory[] @default([GENERAL])

  // Analysis settings
  enableOCR                Boolean @default(true)
  enableNER                Boolean @default(true)
  enableCompliance         Boolean @default(true)
  enableVersionCompare     Boolean @default(false)
  enableAutoClassification Boolean @default(true)
  enableAutoRouting        Boolean @default(false)

  // Classification confidence threshold (0-1)
  classificationThreshold Float @default(0.85)

  // Default extraction fields (JSON: [{ name, type, required }])
  defaultExtractionFields Json?

  // Compliance rules (JSON: [{ ruleId, name, pattern, severity }])
  complianceRules Json?

  // Retention settings
  retentionDays Int @default(365)

  // Integration credentials
  googleVisionApiKey     String?
  azureFormRecognizerKey String?
  openaiApiKey           String?

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant              Tenant?               @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  client              Client?               @relation(fields: [clientId], references: [id], onDelete: Cascade)
  account             Account?              @relation(fields: [accountId], references: [id], onDelete: Cascade)
  analyzedDocuments   AnalyzedDocument[]
  extractionTemplates ExtractionTemplate[]
  batchJobs           DocumentBatchJob[]
  workflows           DocumentWorkflow[]
  integrations        DocumentIntegration[]
  processingMetrics   ProcessingMetrics[]

  @@index([tenantId, isActive])
  @@index([clientId, isActive])
  @@index([accountId, isActive])
  @@index([industryType])
}

/**
 * AnalyzedDocument - Documents that have been analyzed
 */
model AnalyzedDocument {
  id       Int @id @default(autoincrement())
  configId Int

  // Document info
  filename    String
  originalUrl String
  mimeType    String
  sizeBytes   Int
  format      DocumentFormat

  // Analysis status
  status         AnalysisStatus @default(PENDING)
  analyzedAt     DateTime?
  analysisTimeMs Int?

  // OCR results
  ocrText       String?
  ocrConfidence Float?
  pageCount     Int?

  // Extracted data (JSON: { fieldName: { value, confidence, location } })
  extractedFields Json?

  // Named entities (JSON: { entityType: [{ value, confidence, location }] })
  namedEntities Json?

  // Compliance results
  complianceStatus ComplianceLevel?
  complianceFlags  Json? // [{ ruleId, status, message, location }]
  riskScore        Float? // 0-100 risk score

  // Classification (enhanced)
  documentType           String? // Specific type (e.g., "INVOICE_AP", "CONTRACT_NDA")
  documentTypeConfidence Float?
  category               DocumentCategory? // High-level category
  industryCategory       String? // Industry-specific sub-category
  tags                   String[]          @default([])

  // Routing and workflow
  assignedTo         Int? // User ID for routing
  assignedDepartment String?
  workflowStatus     String? // Custom workflow status
  priority           String?   @default("NORMAL") // LOW, NORMAL, HIGH, URGENT
  dueDate            DateTime?

  // Financial document fields (for invoices, etc.)
  totalAmount   Float?
  currency      String?
  vendorName    String?
  invoiceNumber String?
  paymentTerms  String?

  // Contract-specific fields
  contractParties String[]  @default([])
  effectiveDate   DateTime?
  expirationDate  DateTime?
  autoRenewal     Boolean?

  // Audit trail
  auditLog Json? // [{ action, userId, timestamp, details }]

  // Version comparison
  previousVersionId Int?
  changesSummary    Json?

  // Integration sync status
  syncedToIntegrations Json? // [{ integrationType, syncedAt, externalId }]

  // Error tracking
  errorMessage String?
  retryCount   Int       @default(0)
  lastRetryAt  DateTime?

  // Processing metrics
  queuedAt            DateTime?
  processingStartedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  config DocumentAnalyzerConfig @relation(fields: [configId], references: [id], onDelete: Cascade)

  @@index([configId, status])
  @@index([configId, documentType])
  @@index([configId, category])
  @@index([assignedTo, status])
  @@index([createdAt(sort: Desc)])
  @@index([priority, status])
}

/**
 * ExtractionTemplate - Templates for custom field extraction
 * Includes both built-in industry templates and custom user templates
 */
model ExtractionTemplate {
  id       Int  @id @default(autoincrement())
  configId Int? // Null for built-in templates

  name        String
  description String?

  // Template categorization
  category     DocumentCategory @default(GENERAL)
  industryType IndustryType? // Which industry this template is designed for
  documentType String? // Specific document type (e.g., "CMS-1500", "W-9", "NDA")

  // Template source
  isBuiltIn Boolean @default(false) // System-provided templates
  isPublic  Boolean @default(false) // Can be used by all clients

  // Extraction rules (JSON: [{ fieldName, type, pattern, location, required, validation }])
  extractionRules Json

  // Field definitions (JSON: detailed field metadata)
  // { fields: [{ name, label, type, required, validation, helpText }] }
  fieldDefinitions Json?

  // Compliance rules specific to this template
  complianceRules Json?

  // ML model settings
  useMLExtraction     Boolean @default(true)
  mlModelId           String?
  confidenceThreshold Float   @default(0.8)

  // Template versioning
  version           String @default("1.0.0")
  previousVersionId Int?

  // Usage stats (for built-in templates)
  usageCount  Int    @default(0)
  successRate Float?

  isDefault Boolean  @default(false)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  config DocumentAnalyzerConfig? @relation(fields: [configId], references: [id], onDelete: Cascade)

  @@index([configId, documentType])
  @@index([configId, isActive])
  @@index([category, industryType])
  @@index([isBuiltIn, isActive])
}

/**
 * DocumentBatchJob - Batch processing jobs for document analysis
 */
model DocumentBatchJob {
  id       Int @id @default(autoincrement())
  configId Int

  status AnalysisStatus @default(PENDING)

  // Job details
  totalDocuments      Int @default(0)
  processedDocuments  Int @default(0)
  successfulDocuments Int @default(0)
  failedDocuments     Int @default(0)

  // Settings
  extractionTemplateId Int?
  settings             Json?

  // Timing
  startedAt   DateTime?
  completedAt DateTime?

  // Error log
  errorLog Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  config DocumentAnalyzerConfig @relation(fields: [configId], references: [id], onDelete: Cascade)

  @@index([configId, status])
  @@index([status, createdAt(sort: Desc)])
}

/**
 * DocumentWorkflow - Rules for automatic document routing and processing
 */
model DocumentWorkflow {
  id       Int @id @default(autoincrement())
  configId Int

  name        String
  description String?
  isActive    Boolean @default(true)
  priority    Int     @default(0) // Higher priority rules evaluated first

  // Trigger conditions (JSON: { conditions: [{ field, operator, value }], logic: 'AND'|'OR' })
  // Example: { conditions: [{ field: 'category', operator: 'equals', value: 'INVOICE' }] }
  triggerConditions Json

  // Actions to perform when triggered (JSON: [{ type, config }])
  // Example: [{ type: 'ROUTE_TO_USER', config: { userId: 123 } }]
  actions Json

  // Document categories this workflow applies to
  categories    DocumentCategory[] @default([])
  documentTypes String[]           @default([])

  // Notification settings
  notifyOnTrigger    Boolean  @default(false)
  notificationEmails String[] @default([])

  // Execution stats
  executionCount Int       @default(0)
  lastExecutedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  config DocumentAnalyzerConfig @relation(fields: [configId], references: [id], onDelete: Cascade)

  @@index([configId, isActive])
  @@index([categories])
}

/**
 * DocumentIntegration - External system connections for document sync
 */
model DocumentIntegration {
  id       Int @id @default(autoincrement())
  configId Int

  name            String
  integrationType IntegrationType
  isActive        Boolean         @default(true)

  // Connection credentials (encrypted)
  credentials    Json? // { apiKey, clientId, clientSecret, etc. }
  accessToken    String?
  refreshToken   String?
  tokenExpiresAt DateTime?

  // Integration settings
  settings Json? // { syncFrequency, filterCategories, autoSync, etc. }

  // Webhook configuration (for incoming data)
  webhookUrl    String?
  webhookSecret String?

  // Sync configuration
  syncDirection  String    @default("EXPORT") // EXPORT, IMPORT, BIDIRECTIONAL
  lastSyncAt     DateTime?
  lastSyncStatus String? // SUCCESS, FAILED, PARTIAL
  lastSyncError  String?

  // Mapping rules (JSON: how fields map to external system)
  fieldMappings Json?

  // Stats
  documentsExported Int @default(0)
  documentsImported Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  config DocumentAnalyzerConfig @relation(fields: [configId], references: [id], onDelete: Cascade)

  @@unique([configId, integrationType])
  @@index([configId, isActive])
  @@index([integrationType])
}

/**
 * ProcessingMetrics - Analytics and ROI tracking for document processing
 */
model ProcessingMetrics {
  id       Int @id @default(autoincrement())
  configId Int

  // Time period
  periodStart DateTime
  periodEnd   DateTime
  periodType  String   @default("DAILY") // DAILY, WEEKLY, MONTHLY

  // Volume metrics
  documentsProcessed    Int @default(0)
  documentsSuccessful   Int @default(0)
  documentsFailed       Int @default(0)
  documentsManualReview Int @default(0)

  // Category breakdown (JSON: { category: count })
  categoryBreakdown Json?

  // Processing time metrics (in milliseconds)
  totalProcessingTime Int    @default(0)
  avgProcessingTime   Float?
  minProcessingTime   Int?
  maxProcessingTime   Int?

  // Accuracy metrics
  avgConfidence   Float?
  fieldsExtracted Int    @default(0)
  fieldsVerified  Int    @default(0)

  // Compliance metrics
  compliancePassRate Float?
  complianceWarnings Int    @default(0)
  complianceFailures Int    @default(0)

  // ROI metrics (estimated)
  estimatedTimeSaved Int? // Minutes saved vs manual processing
  estimatedCostSaved Float? // Dollar amount saved

  // Integration sync metrics
  integrationSyncs  Int @default(0)
  integrationErrors Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  config DocumentAnalyzerConfig @relation(fields: [configId], references: [id], onDelete: Cascade)

  @@unique([configId, periodStart, periodType])
  @@index([configId, periodType])
  @@index([periodStart, periodEnd])
}

/**
 * ComplianceRuleSet - Pre-built and custom compliance rule sets
 */
model ComplianceRuleSet {
  id Int @id @default(autoincrement())

  name        String
  description String?
  code        String  @unique // e.g., "HIPAA", "SOC2", "GDPR", "AML"

  // Which industries/categories this applies to
  industries IndustryType[]     @default([])
  categories DocumentCategory[] @default([])

  // Rules definition (JSON: [{ ruleId, name, description, pattern, requiredFields, severity }])
  rules Json

  // Metadata
  isBuiltIn Boolean @default(false)
  isActive  Boolean @default(true)
  version   String  @default("1.0.0")

  // Usage tracking
  adoptionCount Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([code])
  @@index([industries])
  @@index([isBuiltIn, isActive])
}

// ============================================================================
// PHASE 2 AI TOOLS - TOOL 2.2: CONTENT GENERATION SUITE
// ============================================================================

enum ContentGenerationType {
  SOCIAL_POST
  EMAIL
  BLOG_POST
  AD_COPY
  LANDING_PAGE
  NEWSLETTER
  PRESS_RELEASE
  PRODUCT_COPY
  VIDEO_SCRIPT
  // Phase 1 additions - Business document content types
  PROPOSAL        // Business/project proposals with pricing, scope, timeline
  CASE_STUDY      // Client success stories for lead nurturing
  FAQ_CONTENT     // FAQ entries for knowledge bases & chatbots
  WELCOME_PACKET  // New client welcome content/guides
  WHITEPAPER      // Thought leadership content for lead generation
}

enum ContentApprovalStatus {
  DRAFT
  PENDING_REVIEW
  REVISION_REQUESTED
  APPROVED
  REJECTED
  PUBLISHED
}

enum WorkflowStepType {
  CREATE
  REVIEW
  REVISE
  APPROVE
  PUBLISH
}

/**
 * ContentGeneratorConfig - Configuration for content generation per client
 */
model ContentGeneratorConfig {
  id       Int     @id @default(autoincrement())
  tenantId String? // Multi-tenant support
  clientId Int     @unique

  // Brand voice settings
  brandVoiceDescription String?
  toneKeywords          String[] @default([])
  avoidKeywords         String[] @default([])

  // Brand voice samples (for training)
  voiceSamples   Json? // [{ text, type, source }]
  voiceTrainedAt DateTime?

  // SEO settings
  enableSEO      Boolean  @default(true)
  targetKeywords String[] @default([])

  // Plagiarism settings
  enablePlagiarismCheck Boolean @default(true)

  // Default settings
  defaultTone   String? // professional, casual, formal, friendly
  defaultLength String? // short, medium, long

  // Integration settings
  cmsIntegrations    Json? // { wordpress: {...}, webflow: {...} }
  socialIntegrations Json? // { hootsuite: {...}, buffer: {...} }
  emailIntegrations  Json? // { mailchimp: {...}, klaviyo: {...} }

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant            Tenant?                   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  client            Client                    @relation(fields: [clientId], references: [id], onDelete: Cascade)
  generatedContents GeneratedContent[]
  contentTemplates  ContentTemplate[]
  approvalWorkflows ContentApprovalWorkflow[]
  contentSequences  ContentSequence[]

  @@index([tenantId, isActive])
  @@index([clientId, isActive])
}

/**
 * GeneratedContent - AI-generated content pieces
 */
model GeneratedContent {
  id       Int @id @default(autoincrement())
  configId Int

  // Content details
  title       String
  type        ContentGenerationType
  content     String
  contentHtml String?

  // SEO elements
  metaTitle       String?
  metaDescription String?
  keywords        String[] @default([])
  seoScore        Int? // 0-100

  // Brand voice
  voiceConsistencyScore Float? // 0-1
  toneAnalysis          Json? // { tone, confidence }

  // Plagiarism check
  originalityScore  Float? // 0-1
  plagiarismSources Json? // [{ url, similarity }]

  // Approval workflow
  approvalStatus     ContentApprovalStatus @default(DRAFT)
  approvalWorkflowId Int?
  currentApproverId  Int?
  approvedAt         DateTime?
  approvedBy         Int?

  // Revision history
  version         Int     @default(1)
  parentVersionId Int?
  revisionNotes   String?

  // Generation metadata
  prompt           String?
  modelUsed        String?
  generationParams Json?

  // Variants for A/B testing
  variantGroup     String?
  isControlVariant Boolean @default(false)

  // Publishing
  publishedAt     DateTime?
  publishedUrl    String?
  publishPlatform String?

  // Performance tracking
  impressions    Int    @default(0)
  clicks         Int    @default(0)
  engagementRate Float?

  // Multi-language support (Phase 4)
  language            String            @default("en") // ISO 639-1 code
  parentTranslationId Int? // Links to original content for translations
  parentTranslation   GeneratedContent? @relation("ContentTranslations", fields: [parentTranslationId], references: [id])
  translations        GeneratedContent[] @relation("ContentTranslations")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  config         ContentGeneratorConfig @relation(fields: [configId], references: [id], onDelete: Cascade)
  sequencePieces ContentSequencePiece[]

  @@index([configId, type])
  @@index([configId, approvalStatus])
  @@index([createdAt(sort: Desc)])
  @@index([parentTranslationId])
  @@index([language])
}

/**
 * ContentTemplate - Templates for content generation
 */
model ContentTemplate {
  id       Int @id @default(autoincrement())
  configId Int

  name        String
  description String?
  type        ContentGenerationType

  // Template content with placeholders
  template     String
  placeholders Json? // [{ name, description, required }]

  // Prompt configuration
  systemPrompt   String?
  exampleOutputs Json? // [{ input, output }]

  // Category for organization
  category String?
  tags     String[] @default([])

  isDefault Boolean  @default(false)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  config ContentGeneratorConfig @relation(fields: [configId], references: [id], onDelete: Cascade)

  @@index([configId, type])
  @@index([configId, category])
}

/**
 * ContentApprovalWorkflow - Approval workflow definitions
 */
model ContentApprovalWorkflow {
  id       Int @id @default(autoincrement())
  configId Int

  name        String
  description String?

  // Workflow steps (JSON: [{ stepId, name, type, approverIds, required }])
  steps Json

  // Auto-assignment rules
  autoAssign      Boolean @default(false)
  assignmentRules Json? // { type: [...approverIds] }

  isDefault Boolean  @default(false)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  config ContentGeneratorConfig @relation(fields: [configId], references: [id], onDelete: Cascade)

  @@index([configId, isActive])
}

/**
 * ContentSequence - Multi-piece content sequences (email drips, onboarding, etc.)
 */
enum ContentSequenceType {
  ONBOARDING    // New client welcome sequence
  NURTURE       // Lead nurturing sequence
  FOLLOW_UP     // Post-meeting/intake follow-up
  DRIP          // Educational content drip
  REENGAGEMENT  // Win-back sequence
}

enum ContentSequenceStatus {
  DRAFT
  ACTIVE
  PAUSED
  COMPLETED
  ARCHIVED
}

model ContentSequence {
  id       Int    @id @default(autoincrement())
  configId Int
  config   ContentGeneratorConfig @relation(fields: [configId], references: [id], onDelete: Cascade)

  name        String
  description String?
  type        ContentSequenceType

  // Trigger configuration
  triggerEvent String?  // e.g., "intake_submitted", "opportunity_created", "manual"

  // Sequence status
  status   ContentSequenceStatus @default(DRAFT)
  isActive Boolean               @default(false)

  // Pieces in this sequence
  pieces ContentSequencePiece[]

  // Metadata
  totalPieces     Int @default(0)
  totalDurationDays Int? // Total days from start to end

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([configId, status])
  @@index([configId, type])
}

model ContentSequencePiece {
  id         Int             @id @default(autoincrement())
  sequenceId Int
  sequence   ContentSequence @relation(fields: [sequenceId], references: [id], onDelete: Cascade)

  // Order in sequence
  order     Int // 1, 2, 3...
  delayDays Int @default(0) // Days after trigger/previous piece

  // Content reference (optional - may be generated later)
  contentId Int?
  content   GeneratedContent? @relation(fields: [contentId], references: [id])

  // Piece configuration
  purpose     String   // "welcome", "value_prop", "case_study", "cta", "reminder"
  subject     String?  // For emails
  contentType ContentGenerationType @default(EMAIL)

  // Generation prompt hints
  promptHints String?
  keywords    String[] @default([])

  // Status
  isGenerated Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([sequenceId, order])
}

// ============================================================================
// PHASE 2 AI TOOLS - TOOL 2.3: LEAD SCORING & CRM ASSISTANT
// ============================================================================

enum LeadScoreLevel {
  HOT
  WARM
  COLD
  DEAD
}

enum NurtureSequenceStatus {
  ACTIVE
  PAUSED
  COMPLETED
  CANCELLED
}

enum NurtureStepType {
  EMAIL
  SMS
  WAIT
  CONDITION
  TASK
  NOTIFICATION
}

/**
 * LeadScoringConfig - Configuration for lead scoring per client
 */
model LeadScoringConfig {
  id       Int     @id @default(autoincrement())
  tenantId String? // Multi-tenant support
  clientId Int     @unique

  // Scoring model settings
  scoringModelVersion String?
  lastModelTrainedAt  DateTime?

  // Scoring weights (JSON: { demographic: {...}, behavioral: {...}, engagement: {...} })
  scoringWeights Json?

  // Thresholds
  hotThreshold  Int @default(80)
  warmThreshold Int @default(50)
  coldThreshold Int @default(20)

  // Activity tracking settings
  trackEmailOpens      Boolean @default(true)
  trackEmailClicks     Boolean @default(true)
  trackWebsiteVisits   Boolean @default(true)
  trackFormSubmissions Boolean @default(true)

  // CRM integration
  crmType        String? // salesforce, hubspot, zoho
  crmCredentials Json?
  crmSyncEnabled Boolean   @default(false)
  lastCrmSyncAt  DateTime?

  // Email integration
  emailProvider    String? // sendgrid, mailgun, ses
  emailCredentials Json?

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant           Tenant?           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  client           Client            @relation(fields: [clientId], references: [id], onDelete: Cascade)
  scoredLeads      ScoredLead[]
  nurtureSequences NurtureSequence[]
  leadActivities   LeadActivity[]

  @@index([tenantId, isActive])
  @@index([clientId, isActive])
}

/**
 * ScoredLead - Leads with ML-based scoring
 */
model ScoredLead {
  id       Int @id @default(autoincrement())
  configId Int

  // Lead identification
  email   String
  name    String?
  company String?
  phone   String?
  title   String?

  // External IDs
  crmLeadId    String?
  crmContactId String?

  // Current score
  score      Int            @default(0)
  scoreLevel LeadScoreLevel @default(COLD)
  scoredAt   DateTime?

  // Score components (JSON: { demographic: X, behavioral: Y, engagement: Z })
  scoreBreakdown Json?

  // Score history (JSON: [{ score, level, scoredAt, reason }])
  scoreHistory Json?

  // Prediction
  conversionProbability Float?
  predictedValue        Decimal?  @db.Decimal(12, 2)
  predictedCloseDate    DateTime?

  // Engagement metrics
  totalEmailsSent    Int       @default(0)
  totalEmailsOpened  Int       @default(0)
  totalEmailsClicked Int       @default(0)
  totalWebsiteVisits Int       @default(0)
  lastEngagementAt   DateTime?

  // Pipeline tracking
  pipelineStage String?
  pipelineValue Decimal? @db.Decimal(12, 2)
  assignedTo    Int?

  // Nurture sequence
  currentSequenceId Int?
  sequenceStepIndex Int?

  // Tags and segments
  tags     String[] @default([])
  segments String[] @default([])

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  config              LeadScoringConfig   @relation(fields: [configId], references: [id], onDelete: Cascade)
  activities          LeadActivity[]
  sequenceEnrollments NurtureEnrollment[]

  @@unique([configId, email])
  @@index([configId, scoreLevel])
  @@index([configId, score(sort: Desc)])
  @@index([email])
}

/**
 * LeadActivity - Activity tracking for leads
 */
model LeadActivity {
  id       Int  @id @default(autoincrement())
  configId Int
  leadId   Int?

  // Activity details
  activityType String // email_open, email_click, page_view, form_submit, meeting, call
  activityData Json? // { url, subject, duration, etc. }

  // Attribution
  source   String? // utm_source equivalent
  medium   String? // utm_medium equivalent
  campaign String? // utm_campaign equivalent

  // Scoring impact
  scoreImpact Int @default(0)

  // Metadata
  ipAddress  String?
  userAgent  String?
  deviceType String?

  createdAt DateTime @default(now())

  config LeadScoringConfig @relation(fields: [configId], references: [id], onDelete: Cascade)
  lead   ScoredLead?       @relation(fields: [leadId], references: [id], onDelete: SetNull)

  @@index([configId, activityType])
  @@index([leadId, createdAt(sort: Desc)])
  @@index([createdAt(sort: Desc)])
}

/**
 * NurtureSequence - Automated nurture sequence definitions
 */
model NurtureSequence {
  id       Int @id @default(autoincrement())
  configId Int

  name        String
  description String?

  // Trigger conditions (JSON: { scoreLevel, tags, segments, customConditions })
  triggerConditions Json?

  // Sequence steps (JSON: [{ stepId, type, config, delayDays, delayHours }])
  steps Json

  // Settings
  allowReEnrollment Boolean @default(false)
  reEnrollmentDays  Int?
  exitOnConversion  Boolean @default(true)
  exitOnReply       Boolean @default(true)

  // Metrics
  totalEnrollments Int @default(0)
  totalCompletions Int @default(0)
  totalConversions Int @default(0)

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  config      LeadScoringConfig   @relation(fields: [configId], references: [id], onDelete: Cascade)
  enrollments NurtureEnrollment[]

  @@index([configId, isActive])
}

/**
 * NurtureEnrollment - Lead enrollment in nurture sequences
 */
model NurtureEnrollment {
  id         Int @id @default(autoincrement())
  sequenceId Int
  leadId     Int

  status NurtureSequenceStatus @default(ACTIVE)

  // Progress tracking
  currentStepIndex    Int       @default(0)
  nextStepScheduledAt DateTime?

  // Step execution history (JSON: [{ stepIndex, executedAt, result }])
  executionHistory Json?

  // Completion
  completedAt DateTime?
  exitReason  String?

  // A/B variant tracking
  variant String?

  enrolledAt DateTime @default(now())
  updatedAt  DateTime @updatedAt

  sequence NurtureSequence @relation(fields: [sequenceId], references: [id], onDelete: Cascade)
  lead     ScoredLead      @relation(fields: [leadId], references: [id], onDelete: Cascade)

  @@unique([sequenceId, leadId])
  @@index([sequenceId, status])
  @@index([nextStepScheduledAt])
}

/**
 * LeadScoringAnalytics - Daily analytics for lead scoring
 */
model LeadScoringAnalytics {
  id       Int      @id @default(autoincrement())
  configId Int
  date     DateTime @db.Date

  // Lead counts
  totalLeads Int @default(0)
  hotLeads   Int @default(0)
  warmLeads  Int @default(0)
  coldLeads  Int @default(0)
  newLeads   Int @default(0)

  // Score changes
  leadsUpgraded   Int @default(0)
  leadsDowngraded Int @default(0)

  // Engagement metrics
  totalActivities Int @default(0)
  emailsSent      Int @default(0)
  emailsOpened    Int @default(0)
  emailsClicked   Int @default(0)
  websiteVisits   Int @default(0)

  // Conversion metrics
  conversions     Int      @default(0)
  conversionValue Decimal? @db.Decimal(12, 2)

  // Nurture metrics
  sequenceEnrollments Int @default(0)
  sequenceCompletions Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([configId, date])
  @@index([configId, date(sort: Desc)])
}

// ============================================================================
// PHASE 2 AI TOOLS - TOOL 2.4: PRIOR AUTHORIZATION BOT
// ============================================================================

enum PARequestStatus {
  DRAFT
  SUBMITTED
  PENDING
  APPROVED
  DENIED
  PARTIAL_APPROVAL
  WITHDRAWN
  EXPIRED
}

enum PAUrgency {
  ROUTINE
  URGENT
  EMERGENT
}

enum DenialReason {
  MEDICAL_NECESSITY
  OUT_OF_NETWORK
  EXPERIMENTAL
  DOCUMENTATION_INCOMPLETE
  BENEFIT_EXCLUSION
  PRE_EXISTING
  DUPLICATE_REQUEST
  OTHER
}

enum AppealStatus {
  NOT_APPEALED
  APPEAL_PENDING
  APPEAL_SUBMITTED
  APPEAL_APPROVED
  APPEAL_DENIED
  EXTERNAL_REVIEW
}

/**
 * PriorAuthConfig - Configuration for prior authorization automation per client
 */
model PriorAuthConfig {
  id       Int     @id @default(autoincrement())
  tenantId String? // Multi-tenant support
  clientId Int     @unique

  // Practice info
  practiceName    String?
  practiceNPI     String?
  practiceAddress Json?

  // Payer settings (JSON: { payerId: { name, portalUrl, credentials, rules } })
  payerConfigurations Json?

  // EHR integration
  ehrSystem      String? // epic, cerner, drchrono
  ehrCredentials Json?
  ehrSyncEnabled Boolean @default(false)

  // Payer portal integrations
  availityCredentials     Json?
  changeHealthCredentials Json?

  // Fax integration
  faxProvider    String? // srfax, phaxio
  faxCredentials Json?

  // Notification settings
  notifyOnSubmission   Boolean  @default(true)
  notifyOnStatusChange Boolean  @default(true)
  notificationEmails   String[] @default([])

  // HIPAA compliance
  isHipaaEnabled Boolean @default(true)

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant      Tenant?      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  client      Client       @relation(fields: [clientId], references: [id], onDelete: Cascade)
  paRequests  PARequest[]
  payerRules  PayerRule[]
  paTemplates PATemplate[]

  @@index([tenantId, isActive])
  @@index([clientId, isActive])
}

/**
 * PARequest - Prior authorization requests
 */
model PARequest {
  id       Int @id @default(autoincrement())
  configId Int

  // Request identification
  requestNumber     String  @unique
  externalRefNumber String? // Payer's reference number

  // Patient info (encrypted for HIPAA)
  patientName      String
  patientDob       DateTime
  patientMemberId  String
  patientEncrypted String? // Encrypted patient details

  // Provider info
  requestingProvider    String
  requestingProviderNPI String?
  renderingProvider     String?
  renderingProviderNPI  String?
  facilityName          String?
  facilityNPI           String?

  // Payer info
  payerId   String
  payerName String
  planName  String?
  planType  String? // commercial, medicare, medicaid

  // Request details
  serviceType    String // procedure, medication, dme, imaging
  procedureCodes String[] @default([])
  diagnosisCodes String[] @default([])
  description    String?
  clinicalNotes  String?
  encryptedNotes String?

  // Dates
  serviceStartDate DateTime?
  serviceEndDate   DateTime?
  submittedAt      DateTime?
  responseDeadline DateTime?

  // Status
  status  PARequestStatus @default(DRAFT)
  urgency PAUrgency       @default(ROUTINE)

  // Decision details
  decidedAt         DateTime?
  approvalNumber    String?
  approvedUnits     Int?
  approvedStartDate DateTime?
  approvedEndDate   DateTime?

  // Denial details
  denialReason      DenialReason?
  denialExplanation String?

  // Appeal tracking
  appealStatus   AppealStatus @default(NOT_APPEALED)
  appealDeadline DateTime?

  // Document references
  supportingDocuments Json? // [{ type, url, uploadedAt }]

  // Audit trail
  auditLog Json? // [{ action, userId, timestamp, details }]

  // Staff tracking
  assignedTo    Int?
  lastUpdatedBy Int?

  // Metrics
  turnaroundDays Int?
  followUpCount  Int  @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  config        PriorAuthConfig   @relation(fields: [configId], references: [id], onDelete: Cascade)
  statusHistory PAStatusHistory[]
  appeals       PAAppeal[]

  @@index([configId, status])
  @@index([payerId, status])
  @@index([patientMemberId])
  @@index([requestNumber])
  @@index([createdAt(sort: Desc)])
}

/**
 * PAStatusHistory - Status change history for PA requests
 */
model PAStatusHistory {
  id        Int @id @default(autoincrement())
  requestId Int

  fromStatus PARequestStatus?
  toStatus   PARequestStatus

  // Change details
  changedBy    Int?
  changeReason String?
  notes        String?

  // Payer response details
  payerResponse Json?

  createdAt DateTime @default(now())

  request PARequest @relation(fields: [requestId], references: [id], onDelete: Cascade)

  @@index([requestId, createdAt(sort: Desc)])
}

/**
 * PAAppeal - Appeals for denied PA requests
 */
model PAAppeal {
  id        Int @id @default(autoincrement())
  requestId Int

  // Appeal details
  appealLevel Int     @default(1) // 1st level, 2nd level, external
  appealType  String? // standard, expedited, external_review

  // Submission
  submittedAt      DateTime?
  submissionMethod String? // portal, fax, mail

  // Appeal arguments
  appealRationale    String?
  supportingEvidence Json? // [{ type, description, url }]
  peerToPeerNotes    String?

  // Response
  status        AppealStatus @default(APPEAL_PENDING)
  decidedAt     DateTime?
  decisionNotes String?

  // Deadlines
  responseDeadline DateTime?

  // Staff tracking
  preparedBy Int?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  request PARequest @relation(fields: [requestId], references: [id], onDelete: Cascade)

  @@index([requestId, appealLevel])
  @@index([status])
}

/**
 * PayerRule - Payer-specific rules and requirements
 */
model PayerRule {
  id       Int @id @default(autoincrement())
  configId Int

  // Payer identification
  payerId   String
  payerName String

  // Service type this rule applies to
  serviceType   String?
  procedureCode String?

  // Rule details
  ruleName        String
  ruleDescription String?

  // Requirements (JSON: { clinicalCriteria, documentation, timeframes })
  requirements Json

  // Submission preferences
  preferredMethod String? // portal, fax, edi
  portalUrl       String?
  faxNumber       String?

  // Timeframes
  standardTurnaround Int? // days
  urgentTurnaround   Int? // days

  // Tips for success
  successTips Json? // [{ tip, importance }]

  lastVerified DateTime?
  isActive     Boolean   @default(true)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  config PriorAuthConfig @relation(fields: [configId], references: [id], onDelete: Cascade)

  @@index([configId, payerId])
  @@index([payerId, serviceType])
}

/**
 * PATemplate - Templates for common PA request types
 */
model PATemplate {
  id       Int @id @default(autoincrement())
  configId Int

  name        String
  description String?

  // What this template is for
  serviceType    String
  procedureCodes String[] @default([])

  // Pre-filled content
  clinicalTemplate  String?
  rationaleTemplate String?

  // Required documentation checklist
  requiredDocs Json? // [{ docType, description, required }]

  // Common diagnosis codes
  commonDiagnoses Json? // [{ code, description }]

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  config PriorAuthConfig @relation(fields: [configId], references: [id], onDelete: Cascade)

  @@index([configId, serviceType])
}

/**
 * PAAnalytics - Daily analytics for prior authorization
 */
model PAAnalytics {
  id       Int      @id @default(autoincrement())
  configId Int
  date     DateTime @db.Date

  // Volume metrics
  totalRequests     Int @default(0)
  newRequests       Int @default(0)
  submittedRequests Int @default(0)

  // Outcome metrics
  approvedRequests Int @default(0)
  deniedRequests   Int @default(0)
  partialApprovals Int @default(0)
  pendingRequests  Int @default(0)

  // Performance metrics
  avgTurnaroundDays Float?
  onTimeSubmissions Int    @default(0)

  // Appeal metrics
  appealsSubmitted Int @default(0)
  appealsWon       Int @default(0)
  appealsLost      Int @default(0)

  // Breakdown by payer (JSON: { payerId: { submitted, approved, denied } })
  payerBreakdown Json?

  // Breakdown by service type (JSON: { type: { count, approvalRate } })
  serviceTypeBreakdown Json?

  // Denial reason analysis (JSON: { reason: count })
  denialReasons Json?

  // Staff workload (JSON: { userId: { submitted, processed } })
  staffMetrics Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([configId, date])
  @@index([configId, date(sort: Desc)])
}

// ============================================================================
// PHASE 3 AI TOOLS - TOOL 3.1: INVENTORY FORECASTING ENGINE
// ============================================================================

enum ForecastStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum AlertSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum AlertStatus {
  ACTIVE
  ACKNOWLEDGED
  RESOLVED
  DISMISSED
}

model InventoryForecastConfig {
  id       Int     @id @default(autoincrement())
  tenantId String? // Multi-tenant support
  clientId Int     @unique

  businessName String?
  timezone     String  @default("America/New_York")
  currency     String  @default("USD")

  forecastHorizonDays  Int   @default(90)
  historicalDataMonths Int   @default(24)
  confidenceLevel      Float @default(0.95)

  enableSeasonality    Boolean @default(true)
  enableTrendDetection Boolean @default(true)
  enableHolidayImpact  Boolean @default(true)
  modelType            String  @default("prophet")

  lowStockThreshold  Float @default(0.2)
  overstockThreshold Float @default(2.0)

  erpSystem      String?
  erpCredentials Json?
  posSystem      String?
  posCredentials Json?

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant    Tenant?             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  client    Client              @relation(fields: [clientId], references: [id], onDelete: Cascade)
  locations InventoryLocation[]
  products  InventoryProduct[]
  forecasts InventoryForecast[]
  alerts    InventoryAlert[]
  scenarios ForecastScenario[]

  @@index([tenantId, isActive])
  @@index([clientId, isActive])
}

model InventoryLocation {
  id       Int @id @default(autoincrement())
  configId Int

  name     String
  code     String?
  address  Json?
  timezone String?

  leadTimeDays    Int @default(7)
  safetyStockDays Int @default(14)

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  config      InventoryForecastConfig @relation(fields: [configId], references: [id], onDelete: Cascade)
  stockLevels StockLevel[]
  forecasts   InventoryForecast[]

  @@unique([configId, code])
  @@index([configId, isActive])
}

model InventoryProduct {
  id       Int @id @default(autoincrement())
  configId Int

  sku         String
  name        String
  category    String?
  subcategory String?

  supplierId           String?
  supplierName         String?
  supplierLeadTimeDays Int?

  unitCost     Decimal? @db.Decimal(12, 2)
  sellingPrice Decimal? @db.Decimal(12, 2)

  reorderPoint     Int?
  reorderQuantity  Int?
  minOrderQuantity Int?

  abcClass String?

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  config       InventoryForecastConfig @relation(fields: [configId], references: [id], onDelete: Cascade)
  stockLevels  StockLevel[]
  forecasts    InventoryForecast[]
  salesHistory SalesHistory[]

  @@unique([configId, sku])
  @@index([configId, category])
  @@index([configId, isActive])
}

model StockLevel {
  id         Int @id @default(autoincrement())
  productId  Int
  locationId Int

  quantityOnHand   Int @default(0)
  quantityReserved Int @default(0)
  quantityOnOrder  Int @default(0)

  lastCountDate    DateTime?
  lastReceivedDate DateTime?

  updatedAt DateTime @updatedAt

  product  InventoryProduct  @relation(fields: [productId], references: [id], onDelete: Cascade)
  location InventoryLocation @relation(fields: [locationId], references: [id], onDelete: Cascade)

  @@unique([productId, locationId])
  @@index([productId])
  @@index([locationId])
}

model SalesHistory {
  id        Int @id @default(autoincrement())
  productId Int

  date         DateTime @db.Date
  quantitySold Int      @default(0)
  revenue      Decimal? @db.Decimal(12, 2)
  locationId   Int?

  wasPromotion     Boolean @default(false)
  wasHoliday       Boolean @default(false)
  weatherCondition String?

  createdAt DateTime @default(now())

  product InventoryProduct @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([productId, date, locationId])
  @@index([productId, date(sort: Desc)])
}

model InventoryForecast {
  id         Int  @id @default(autoincrement())
  configId   Int
  productId  Int
  locationId Int?

  status ForecastStatus @default(PENDING)

  startDate   DateTime
  endDate     DateTime
  generatedAt DateTime?

  predictions Json?

  totalPredictedDemand Int?
  peakDemandDate       DateTime?
  peakDemandValue      Int?

  mape       Float?
  rmse       Float?
  confidence Float?

  suggestedReorderDate DateTime?
  suggestedReorderQty  Int?
  stockoutRiskScore    Float?

  seasonalityPattern Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  config   InventoryForecastConfig @relation(fields: [configId], references: [id], onDelete: Cascade)
  product  InventoryProduct        @relation(fields: [productId], references: [id], onDelete: Cascade)
  location InventoryLocation?      @relation(fields: [locationId], references: [id], onDelete: SetNull)

  @@index([configId, status])
  @@index([productId, startDate])
  @@index([generatedAt(sort: Desc)])
}

model InventoryAlert {
  id       Int @id @default(autoincrement())
  configId Int

  alertType String
  severity  AlertSeverity @default(MEDIUM)
  status    AlertStatus   @default(ACTIVE)

  title      String
  message    String
  productId  Int?
  locationId Int?

  threshold    Float?
  currentValue Float?

  acknowledgedAt DateTime?
  acknowledgedBy Int?
  resolvedAt     DateTime?
  resolvedBy     Int?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  config InventoryForecastConfig @relation(fields: [configId], references: [id], onDelete: Cascade)

  @@index([configId, status])
  @@index([configId, severity])
  @@index([createdAt(sort: Desc)])
}

model ForecastScenario {
  id       Int @id @default(autoincrement())
  configId Int

  name        String
  description String?

  demandMultiplier Float @default(1.0)
  leadTimeChange   Int   @default(0)
  priceChange      Float @default(0)
  promotionImpact  Float @default(0)

  results       Json?
  costImpact    Decimal? @db.Decimal(12, 2)
  revenueImpact Decimal? @db.Decimal(12, 2)

  isBaseline Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  config InventoryForecastConfig @relation(fields: [configId], references: [id], onDelete: Cascade)

  @@index([configId])
}

model InventoryForecastAnalytics {
  id       Int      @id @default(autoincrement())
  configId Int
  date     DateTime @db.Date

  forecastAccuracy Float?
  mapeScore        Float?

  totalSkus     Int @default(0)
  lowStockSkus  Int @default(0)
  overstockSkus Int @default(0)
  stockoutSkus  Int @default(0)

  inventoryValue        Decimal? @db.Decimal(14, 2)
  potentialStockoutCost Decimal? @db.Decimal(12, 2)
  holdingCost           Decimal? @db.Decimal(12, 2)

  alertsGenerated Int @default(0)
  alertsResolved  Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([configId, date])
  @@index([configId, date(sort: Desc)])
}

// ============================================================================
// PHASE 3 AI TOOLS - TOOL 3.2: COMPLIANCE MONITORING SYSTEM
// ============================================================================

enum RiskLevel {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum ViolationStatus {
  OPEN
  INVESTIGATING
  REMEDIATED
  RESOLVED
  ESCALATED
  CLOSED
  FALSE_POSITIVE
}

enum AuditStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  OVERDUE
}

model ComplianceMonitorConfig {
  id       Int     @id @default(autoincrement())
  tenantId String? // Multi-tenant support
  clientId Int     @unique

  organizationName String?
  industry         String?
  jurisdiction     String?

  enableHipaa      Boolean  @default(false)
  enableSox        Boolean  @default(false)
  enableGdpr       Boolean  @default(false)
  enablePci        Boolean  @default(false)
  enableFinra      Boolean  @default(false)
  customFrameworks String[] @default([])

  realTimeMonitoring  Boolean @default(true)
  monitoringFrequency String  @default("daily")

  alertThreshold     String   @default("medium")
  notificationEmails String[] @default([])
  slackWebhook       String?
  msTeamsWebhook     String?

  dataSourceConfigs Json?

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant          Tenant?               @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  client          Client                @relation(fields: [clientId], references: [id], onDelete: Cascade)
  complianceRules ComplianceRule[]
  violations      ComplianceViolation[]
  audits          ComplianceAudit[]
  evidenceItems   ComplianceEvidence[]
  riskAssessments RiskAssessment[]
  reports         ComplianceReport[]

  @@index([tenantId, isActive])
  @@index([clientId, isActive])
}

model ComplianceRule {
  id       Int @id @default(autoincrement())
  configId Int

  name        String
  description String?
  framework   String
  category    String?

  ruleType       String
  ruleDefinition Json
  severity       RiskLevel @default(MEDIUM)

  isRealtime     Boolean @default(false)
  checkFrequency String?

  autoRemediate     Boolean @default(false)
  remediationAction Json?

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  config     ComplianceMonitorConfig @relation(fields: [configId], references: [id], onDelete: Cascade)
  violations ComplianceViolation[]

  @@index([configId, framework])
  @@index([configId, isActive])
}

model ComplianceViolation {
  id       Int @id @default(autoincrement())
  configId Int
  ruleId   Int

  status   ViolationStatus @default(OPEN)
  severity RiskLevel

  title           String
  description     String?
  sourceSystem    String?
  sourceReference String?

  violationData    Json?
  affectedEntities Json?

  detectedAt     DateTime  @default(now())
  acknowledgedAt DateTime?
  acknowledgedBy Int?
  remediatedAt   DateTime?
  remediatedBy   Int?

  remediationNotes    String?
  remediationEvidence Json?

  impactScore     Int?
  financialImpact Decimal? @db.Decimal(12, 2)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  config ComplianceMonitorConfig @relation(fields: [configId], references: [id], onDelete: Cascade)
  rule   ComplianceRule          @relation(fields: [ruleId], references: [id], onDelete: Cascade)

  @@index([configId, status])
  @@index([configId, severity])
  @@index([ruleId])
  @@index([detectedAt(sort: Desc)])
}

model ComplianceAudit {
  id       Int @id @default(autoincrement())
  configId Int

  name        String
  description String?
  framework   String
  scope       Json?

  status AuditStatus @default(SCHEDULED)

  scheduledDate DateTime
  dueDate       DateTime?
  startedAt     DateTime?
  completedAt   DateTime?

  leadAuditor String?
  auditTeam   String[] @default([])

  findings       Json?
  overallScore   Int?
  passedControls Int?
  failedControls Int?
  totalControls  Int?

  recommendations Json?
  remediationPlan Json?

  reportUrl String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  config ComplianceMonitorConfig @relation(fields: [configId], references: [id], onDelete: Cascade)

  @@index([configId, status])
  @@index([scheduledDate])
}

model ComplianceEvidence {
  id       Int @id @default(autoincrement())
  configId Int

  title        String
  description  String?
  evidenceType String
  framework    String?
  controlId    String?

  fileUrl  String?
  fileHash String?
  content  String?

  collectedAt DateTime  @default(now())
  collectedBy Int?
  verifiedAt  DateTime?
  verifiedBy  Int?

  retentionDays Int?
  expiresAt     DateTime?

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  config ComplianceMonitorConfig @relation(fields: [configId], references: [id], onDelete: Cascade)

  @@index([configId, framework])
  @@index([configId, evidenceType])
}

model RiskAssessment {
  id       Int @id @default(autoincrement())
  configId Int

  entityType String
  entityId   String
  entityName String?

  overallRiskScore Int
  riskLevel        RiskLevel

  scoreBreakdown Json?

  previousScore Int?
  scoreTrend    String?

  riskFactors Json?

  mitigationPlan   Json?
  mitigationStatus String?

  assessedAt       DateTime  @default(now())
  nextAssessmentAt DateTime?

  config ComplianceMonitorConfig @relation(fields: [configId], references: [id], onDelete: Cascade)

  @@index([configId, entityType])
  @@index([configId, riskLevel])
  @@index([assessedAt(sort: Desc)])
}

model ComplianceReport {
  id       Int @id @default(autoincrement())
  configId Int

  name       String
  reportType String
  framework  String?
  period     String?

  reportData   Json?
  summaryStats Json?
  charts       Json?

  generatedAt DateTime @default(now())
  generatedBy Int?
  fileUrl     String?

  submissionRequired Boolean   @default(false)
  submissionDeadline DateTime?
  submittedAt        DateTime?
  submissionRef      String?

  createdAt DateTime @default(now())

  config ComplianceMonitorConfig @relation(fields: [configId], references: [id], onDelete: Cascade)

  @@index([configId, reportType])
  @@index([generatedAt(sort: Desc)])
}

model ComplianceMonitorAnalytics {
  id       Int      @id @default(autoincrement())
  configId Int
  date     DateTime @db.Date

  totalViolations    Int @default(0)
  openViolations     Int @default(0)
  criticalViolations Int @default(0)
  resolvedViolations Int @default(0)

  averageRiskScore   Float?
  entitiesAtHighRisk Int    @default(0)

  overallComplianceScore Float?

  frameworkScores Json?

  controlsMonitored Int @default(0)
  controlsPassing   Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([configId, date])
  @@index([configId, date(sort: Desc)])
}

// ============================================================================
// PHASE 3 AI TOOLS - TOOL 3.3: PREDICTIVE MAINTENANCE PLATFORM
// ============================================================================

enum EquipmentStatus {
  OPERATIONAL
  DEGRADED
  WARNING
  CRITICAL
  OFFLINE
  MAINTENANCE
}

enum MaintenanceType {
  PREVENTIVE
  PREDICTIVE
  CORRECTIVE
  EMERGENCY
}

enum WorkOrderStatus {
  DRAFT
  SCHEDULED
  IN_PROGRESS
  ON_HOLD
  COMPLETED
  CANCELLED
}

enum WorkOrderPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

model PredictiveMaintenanceConfig {
  id       Int     @id @default(autoincrement())
  tenantId String? // Multi-tenant support
  clientId Int     @unique

  facilityName String?
  timezone     String  @default("America/New_York")

  predictionHorizonDays Int    @default(30)
  alertThreshold        Float  @default(0.7)
  modelUpdateFrequency  String @default("weekly")

  sensorDataRetentionDays Int     @default(90)
  anomalyDetectionEnabled Boolean @default(true)
  realTimeMonitoring      Boolean @default(true)

  iotGateway      String?
  iotCredentials  Json?
  erp             String?
  erpCredentials  Json?
  cmms            String?
  cmmsCredentials Json?

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant              Tenant?                @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  client              Client                 @relation(fields: [clientId], references: [id], onDelete: Cascade)
  equipment           Equipment[]
  sensors             Sensor[]
  workOrders          MaintenanceWorkOrder[]
  predictions         FailurePrediction[]
  sparePartsInventory SparePart[]

  @@index([tenantId, isActive])
  @@index([clientId, isActive])
}

model Equipment {
  id       Int @id @default(autoincrement())
  configId Int

  assetTag     String
  name         String
  description  String?
  manufacturer String?
  model        String?
  serialNumber String?

  category    String?
  criticality String?
  location    String?
  department  String?

  status          EquipmentStatus @default(OPERATIONAL)
  healthScore     Int?
  lastHealthCheck DateTime?

  installationDate  DateTime?
  warrantyExpiry    DateTime?
  expectedLifeYears Int?

  maintenanceSchedule Json?
  lastMaintenanceDate DateTime?
  nextMaintenanceDate DateTime?

  purchaseCost        Decimal? @db.Decimal(12, 2)
  maintenanceCostYtd  Decimal? @db.Decimal(12, 2)
  downtimeCostPerHour Decimal? @db.Decimal(10, 2)

  externalAssetId String?
  cmmsAssetId     String?

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  config         PredictiveMaintenanceConfig @relation(fields: [configId], references: [id], onDelete: Cascade)
  sensors        Sensor[]
  workOrders     MaintenanceWorkOrder[]
  predictions    FailurePrediction[]
  downtimeEvents DowntimeEvent[]

  @@unique([configId, assetTag])
  @@index([configId, status])
  @@index([configId, category])
}

model Sensor {
  id          Int @id @default(autoincrement())
  configId    Int
  equipmentId Int

  sensorId   String
  name       String
  sensorType String

  unit           String?
  minThreshold   Float?
  maxThreshold   Float?
  normalRangeMin Float?
  normalRangeMax Float?

  isOnline      Boolean   @default(true)
  lastReading   Float?
  lastReadingAt DateTime?
  batteryLevel  Int?

  alertEnabled   Boolean @default(true)
  alertThreshold Float?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  config    PredictiveMaintenanceConfig @relation(fields: [configId], references: [id], onDelete: Cascade)
  equipment Equipment                   @relation(fields: [equipmentId], references: [id], onDelete: Cascade)
  readings  SensorReading[]
  anomalies SensorAnomaly[]

  @@unique([configId, sensorId])
  @@index([equipmentId])
  @@index([sensorType])
}

model SensorReading {
  id       Int @id @default(autoincrement())
  sensorId Int

  timestamp DateTime
  value     Float
  quality   String?

  rawValue       Float?
  processedValue Float?

  sensor Sensor @relation(fields: [sensorId], references: [id], onDelete: Cascade)

  @@index([sensorId, timestamp(sort: Desc)])
}

model SensorAnomaly {
  id       Int @id @default(autoincrement())
  sensorId Int

  detectedAt  DateTime      @default(now())
  anomalyType String
  severity    AlertSeverity @default(MEDIUM)

  expectedValue Float?
  actualValue   Float
  deviation     Float?

  possibleCauses    Json?
  recommendedAction String?

  isResolved Boolean   @default(false)
  resolvedAt DateTime?
  resolution String?

  sensor Sensor @relation(fields: [sensorId], references: [id], onDelete: Cascade)

  @@index([sensorId, detectedAt(sort: Desc)])
  @@index([severity, isResolved])
}

model FailurePrediction {
  id          Int @id @default(autoincrement())
  configId    Int
  equipmentId Int

  failureType      String
  probability      Float
  confidenceLevel  Float?
  predictedDate    DateTime?
  predictionWindow String?

  modelVersion String?
  features     Json?

  riskScore      Int?
  impactEstimate Json?

  recommendedAction String?
  preventiveSteps   Json?

  actualOutcome String?
  outcomeDate   DateTime?
  outcomeNotes  String?

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  config    PredictiveMaintenanceConfig @relation(fields: [configId], references: [id], onDelete: Cascade)
  equipment Equipment                   @relation(fields: [equipmentId], references: [id], onDelete: Cascade)

  @@index([configId, isActive])
  @@index([equipmentId, predictedDate])
  @@index([probability(sort: Desc)])
}

model MaintenanceWorkOrder {
  id          Int @id @default(autoincrement())
  configId    Int
  equipmentId Int

  workOrderNumber String
  title           String
  description     String?

  type     MaintenanceType
  priority WorkOrderPriority @default(MEDIUM)
  status   WorkOrderStatus   @default(DRAFT)

  scheduledDate DateTime?
  dueDate       DateTime?
  startedAt     DateTime?
  completedAt   DateTime?

  assignedTo   String?
  assignedTeam String?

  laborHours Decimal? @db.Decimal(6, 2)
  partsUsed  Json?
  notes      String?
  findings   String?

  laborCost Decimal? @db.Decimal(10, 2)
  partsCost Decimal? @db.Decimal(10, 2)
  totalCost Decimal? @db.Decimal(10, 2)

  checklistItems Json?

  cmmsWorkOrderId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  config    PredictiveMaintenanceConfig @relation(fields: [configId], references: [id], onDelete: Cascade)
  equipment Equipment                   @relation(fields: [equipmentId], references: [id], onDelete: Cascade)

  @@unique([configId, workOrderNumber])
  @@index([configId, status])
  @@index([equipmentId])
  @@index([scheduledDate])
}

model SparePart {
  id       Int @id @default(autoincrement())
  configId Int

  partNumber  String
  name        String
  description String?
  category    String?

  quantityOnHand  Int     @default(0)
  reorderPoint    Int?
  reorderQuantity Int?
  location        String?

  unitCost     Decimal? @db.Decimal(10, 2)
  supplier     String?
  leadTimeDays Int?

  lastUsedDate DateTime?
  usageCount   Int       @default(0)

  compatibleEquipment String[] @default([])

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  config PredictiveMaintenanceConfig @relation(fields: [configId], references: [id], onDelete: Cascade)

  @@unique([configId, partNumber])
  @@index([configId, category])
}

model DowntimeEvent {
  id          Int @id @default(autoincrement())
  equipmentId Int

  startTime       DateTime
  endTime         DateTime?
  durationMinutes Int?

  reason      String
  description String?
  rootCause   String?

  productionLoss Decimal? @db.Decimal(12, 2)
  laborCost      Decimal? @db.Decimal(10, 2)
  partsCost      Decimal? @db.Decimal(10, 2)
  totalCost      Decimal? @db.Decimal(12, 2)

  wasPlanned   Boolean @default(false)
  wasPredicted Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  equipment Equipment @relation(fields: [equipmentId], references: [id], onDelete: Cascade)

  @@index([equipmentId, startTime(sort: Desc)])
}

model PredictiveMaintenanceAnalytics {
  id       Int      @id @default(autoincrement())
  configId Int
  date     DateTime @db.Date

  totalEquipment         Int @default(0)
  operationalEquipment   Int @default(0)
  equipmentInMaintenance Int @default(0)
  criticalEquipment      Int @default(0)

  predictionsGenerated Int    @default(0)
  highRiskPredictions  Int    @default(0)
  predictionsAccuracy  Float?

  workOrdersCreated     Int @default(0)
  workOrdersCompleted   Int @default(0)
  preventiveMaintenance Int @default(0)
  correctiveMaintenance Int @default(0)

  maintenanceCost Decimal? @db.Decimal(12, 2)
  downtimeCost    Decimal? @db.Decimal(12, 2)
  costSavings     Decimal? @db.Decimal(12, 2)

  oeeScore     Float?
  availability Float?
  performance  Float?
  quality      Float?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([configId, date])
  @@index([configId, date(sort: Desc)])
}

// ============================================================================
// PHASE 3 AI TOOLS - TOOL 3.4: REVENUE MANAGEMENT AI
// ============================================================================

enum PricingStrategy {
  STATIC
  DYNAMIC
  COMPETITIVE
  DEMAND_BASED
  TIME_BASED
}

enum RateType {
  STANDARD
  PROMOTIONAL
  LAST_MINUTE
  EARLY_BIRD
  PACKAGE
}

model RevenueManagementConfig {
  id       Int     @id @default(autoincrement())
  tenantId String? // Multi-tenant support
  clientId Int     @unique

  businessName String?
  businessType String?
  timezone     String  @default("America/New_York")
  currency     String  @default("USD")

  pricingStrategy      PricingStrategy @default(DYNAMIC)
  minPriceFloor        Float?
  maxPriceCeiling      Float?
  priceChangeFrequency String          @default("daily")

  forecastHorizonDays  Int @default(90)
  historicalDataMonths Int @default(24)

  competitorMonitoring      Boolean @default(true)
  competitorUpdateFrequency String  @default("daily")

  autoApproveChanges   Boolean @default(false)
  maxAutoChangePercent Float   @default(10)

  pmsSystem          String?
  pmsCredentials     Json?
  channelManager     String?
  channelCredentials Json?
  otaConnections     Json?

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant               Tenant?               @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  client               Client                @relation(fields: [clientId], references: [id], onDelete: Cascade)
  rateCategories       RateCategory[]
  competitors          Competitor[]
  demandForecasts      DemandForecast[]
  priceRecommendations PriceRecommendation[]
  promotions           RevenuePromotion[]
  bookings             BookingData[]

  @@index([tenantId, isActive])
  @@index([clientId, isActive])
}

model RateCategory {
  id       Int @id @default(autoincrement())
  configId Int

  code         String
  name         String
  description  String?
  categoryType String

  baseRate Decimal  @db.Decimal(10, 2)
  minRate  Decimal? @db.Decimal(10, 2)
  maxRate  Decimal? @db.Decimal(10, 2)

  totalInventory Int?
  maxOccupancy   Int?

  pricingEnabled   Boolean @default(true)
  demandMultiplier Float   @default(1.0)

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  config          RevenueManagementConfig @relation(fields: [configId], references: [id], onDelete: Cascade)
  recommendations PriceRecommendation[]
  forecasts       DemandForecast[]
  bookings        BookingData[]

  @@unique([configId, code])
  @@index([configId, isActive])
}

model Competitor {
  id       Int @id @default(autoincrement())
  configId Int

  name       String
  website    String?
  location   String?
  starRating Float?

  trackingEnabled Boolean @default(true)
  scrapeUrl       String?
  apiEndpoint     String?

  categoryMapping Json?

  lastScrapedAt DateTime?

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  config RevenueManagementConfig @relation(fields: [configId], references: [id], onDelete: Cascade)
  rates  CompetitorRate[]

  @@index([configId, isActive])
}

model CompetitorRate {
  id           Int @id @default(autoincrement())
  competitorId Int

  date         DateTime @db.Date
  categoryCode String?
  rate         Decimal  @db.Decimal(10, 2)
  availability Boolean  @default(true)
  restrictions Json?

  scrapedAt DateTime @default(now())

  competitor Competitor @relation(fields: [competitorId], references: [id], onDelete: Cascade)

  @@index([competitorId, date])
}

model DemandForecast {
  id         Int  @id @default(autoincrement())
  configId   Int
  categoryId Int?

  forecastDate DateTime @db.Date

  predictedDemand   Float
  predictedBookings Int?
  confidenceLevel   Float?

  demandDrivers Json?
  isHoliday     Boolean @default(false)
  isWeekend     Boolean @default(false)
  eventImpact   Json?

  recommendedRate Decimal? @db.Decimal(10, 2)
  rateMultiplier  Float?

  generatedAt DateTime @default(now())

  config   RevenueManagementConfig @relation(fields: [configId], references: [id], onDelete: Cascade)
  category RateCategory?           @relation(fields: [categoryId], references: [id], onDelete: SetNull)

  @@unique([configId, categoryId, forecastDate])
  @@index([configId, forecastDate])
}

model PriceRecommendation {
  id         Int @id @default(autoincrement())
  configId   Int
  categoryId Int

  date            DateTime @db.Date
  currentRate     Decimal  @db.Decimal(10, 2)
  recommendedRate Decimal  @db.Decimal(10, 2)
  changePercent   Float

  reason             String?
  demandLevel        String?
  competitorPosition String?
  confidence         Float?

  projectedBookings Int?
  projectedRevenue  Decimal? @db.Decimal(12, 2)
  projectedRevPAR   Decimal? @db.Decimal(10, 2)

  status          String    @default("pending")
  approvedAt      DateTime?
  approvedBy      Int?
  appliedAt       DateTime?
  rejectionReason String?

  generatedAt DateTime  @default(now())
  expiresAt   DateTime?

  config   RevenueManagementConfig @relation(fields: [configId], references: [id], onDelete: Cascade)
  category RateCategory            @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@index([configId, status])
  @@index([categoryId, date])
  @@index([date])
}

model RevenuePromotion {
  id       Int @id @default(autoincrement())
  configId Int

  name        String
  code        String?
  description String?

  discountType  String
  discountValue Decimal @db.Decimal(10, 2)

  startDate          DateTime
  endDate            DateTime
  bookingWindowStart DateTime?
  bookingWindowEnd   DateTime?

  minNights            Int?
  maxNights            Int?
  applicableCategories String[]   @default([])
  blackoutDates        DateTime[] @default([])

  usageCount   Int      @default(0)
  maxUsage     Int?
  totalRevenue Decimal? @db.Decimal(12, 2)

  projectedRoi Float?
  actualRoi    Float?

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  config RevenueManagementConfig @relation(fields: [configId], references: [id], onDelete: Cascade)

  @@unique([configId, code])
  @@index([configId, isActive])
  @@index([startDate, endDate])
}

model BookingData {
  id         Int  @id @default(autoincrement())
  configId   Int
  categoryId Int?

  bookingDate  DateTime
  stayDate     DateTime  @db.Date
  checkoutDate DateTime? @db.Date

  rate         Decimal  @db.Decimal(10, 2)
  nights       Int      @default(1)
  totalRevenue Decimal  @db.Decimal(12, 2)
  rateType     RateType @default(STANDARD)

  channel       String?
  promotionCode String?

  leadTimeDays Int?

  isCancelled Boolean   @default(false)
  cancelledAt DateTime?

  createdAt DateTime @default(now())

  config   RevenueManagementConfig @relation(fields: [configId], references: [id], onDelete: Cascade)
  category RateCategory?           @relation(fields: [categoryId], references: [id], onDelete: SetNull)

  @@index([configId, stayDate])
  @@index([categoryId, stayDate])
  @@index([bookingDate])
}

model RevenueManagementAnalytics {
  id       Int      @id @default(autoincrement())
  configId Int
  date     DateTime @db.Date

  occupancyRate      Float?
  availableInventory Int?
  soldInventory      Int?

  totalRevenue Decimal? @db.Decimal(12, 2)
  adr          Decimal? @db.Decimal(10, 2)
  revPar       Decimal? @db.Decimal(10, 2)

  revenueVsLastYear Float?
  revParVsLastYear  Float?
  revenueVsBudget   Float?

  recommendationsApplied Int @default(0)
  priceChangesAuto       Int @default(0)
  priceChangesManual     Int @default(0)

  avgCompetitorRate Decimal? @db.Decimal(10, 2)
  marketPosition    String?

  forecastAccuracy Float?
  demandVariance   Float?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([configId, date])
  @@index([configId, date(sort: Desc)])
}

// ============================================================================
// PHASE 3 AI TOOLS - TOOL 3.5: SAFETY & COMPLIANCE MONITOR
// ============================================================================

enum IncidentSeverity {
  NEAR_MISS
  MINOR
  MODERATE
  SERIOUS
  SEVERE
  FATAL
}

enum IncidentStatus {
  REPORTED
  UNDER_INVESTIGATION
  ROOT_CAUSE_IDENTIFIED
  CORRECTIVE_ACTION_PENDING
  CORRECTIVE_ACTION_COMPLETE
  CLOSED
}

enum ChecklistStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
  OVERDUE
  SKIPPED
}

enum TrainingStatus {
  NOT_ASSIGNED
  ASSIGNED
  IN_PROGRESS
  COMPLETED
  EXPIRED
  FAILED
}

model SafetyMonitorConfig {
  id       Int     @id @default(autoincrement())
  tenantId String? // Multi-tenant support
  clientId Int     @unique

  organizationName String?
  industry         String?
  timezone         String  @default("America/New_York")

  oshaEnabled       Boolean  @default(true)
  stateRegulations  String[] @default([])
  industryStandards String[] @default([])

  incidentAlertEmails String[] @default([])
  safetyManagerEmail  String?
  emergencyContacts   Json?

  oshaEstablishmentName    String?
  oshaEstablishmentAddress Json?
  oshaReportingThreshold   Int     @default(10)

  enableMobileApp      Boolean @default(true)
  requirePhotoEvidence Boolean @default(false)
  enableOfflineMode    Boolean @default(true)

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant               Tenant?               @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  client               Client                @relation(fields: [clientId], references: [id], onDelete: Cascade)
  checklists           SafetyChecklist[]
  checklistCompletions ChecklistCompletion[]
  incidents            SafetyIncident[]
  hazards              HazardReport[]
  trainingRequirements TrainingRequirement[]
  trainingRecords      TrainingRecord[]
  oshaLogs             OshaLog[]
  inspections          SafetyInspection[]

  @@index([tenantId, isActive])
  @@index([clientId, isActive])
}

model SafetyChecklist {
  id       Int @id @default(autoincrement())
  configId Int

  name        String
  description String?
  category    String?
  department  String?
  location    String?

  frequency String?
  dueTime   String?

  items Json

  regulatoryReference String?
  complianceCategory  String?

  isTemplate Boolean  @default(true)
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  config      SafetyMonitorConfig   @relation(fields: [configId], references: [id], onDelete: Cascade)
  completions ChecklistCompletion[]

  @@index([configId, category])
  @@index([configId, isActive])
}

model ChecklistCompletion {
  id          Int @id @default(autoincrement())
  configId    Int
  checklistId Int

  status ChecklistStatus @default(NOT_STARTED)

  assignedTo     Int?
  assignedToName String?
  location       String?
  department     String?

  dueDate     DateTime?
  startedAt   DateTime?
  completedAt DateTime?

  responses         Json?
  deficienciesFound Int   @default(0)
  correctiveActions Json?

  signatureUrl String?
  signedAt     DateTime?

  latitude  Float?
  longitude Float?

  notes String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  config    SafetyMonitorConfig @relation(fields: [configId], references: [id], onDelete: Cascade)
  checklist SafetyChecklist     @relation(fields: [checklistId], references: [id], onDelete: Cascade)

  @@index([configId, status])
  @@index([checklistId, dueDate])
  @@index([assignedTo, status])
}

model SafetyIncident {
  id       Int @id @default(autoincrement())
  configId Int

  incidentNumber String
  title          String
  description    String

  incidentType String
  severity     IncidentSeverity
  status       IncidentStatus   @default(REPORTED)

  occurredAt       DateTime
  reportedAt       DateTime @default(now())
  location         String?
  department       String?
  specificLocation String?

  affectedPersons Json?
  witnesses       Json?
  reportedBy      String?
  reportedById    Int?

  isOshaRecordable   Boolean @default(false)
  oshaClassification String?
  daysAwayFromWork   Int?
  daysRestricted     Int?
  daysTransferred    Int?

  investigator           String?
  investigatorId         Int?
  investigationStartedAt DateTime?
  rootCause              String?
  contributingFactors    Json?

  correctiveActions  Json?
  preventiveMeasures Json?

  photoUrls    String[] @default([])
  documentUrls String[] @default([])

  resolvedAt      DateTime?
  resolutionNotes String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  config SafetyMonitorConfig @relation(fields: [configId], references: [id], onDelete: Cascade)

  @@unique([configId, incidentNumber])
  @@index([configId, status])
  @@index([configId, severity])
  @@index([occurredAt(sort: Desc)])
}

model HazardReport {
  id       Int @id @default(autoincrement())
  configId Int

  title       String
  description String

  hazardType String
  riskLevel  RiskLevel
  location   String?
  department String?

  reportedBy   String?
  reportedById Int?
  reportedAt   DateTime @default(now())

  likelihood  Int?
  consequence Int?
  riskScore   Int?

  controlMeasures  Json?
  mitigationStatus String @default("open")

  resolvedAt   DateTime?
  resolvedBy   Int?
  residualRisk Int?

  photoUrls String[] @default([])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  config SafetyMonitorConfig @relation(fields: [configId], references: [id], onDelete: Cascade)

  @@index([configId, riskLevel])
  @@index([configId, mitigationStatus])
}

model TrainingRequirement {
  id       Int @id @default(autoincrement())
  configId Int

  name        String
  description String?
  category    String?

  frequency          String?
  validityPeriodDays Int?
  isRequired         Boolean @default(true)

  regulatoryReference String?
  complianceCategory  String?

  applicableRoles       String[] @default([])
  applicableDepartments String[] @default([])

  contentUrl      String?
  durationMinutes Int?
  passingScore    Int?

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  config  SafetyMonitorConfig @relation(fields: [configId], references: [id], onDelete: Cascade)
  records TrainingRecord[]

  @@index([configId, category])
  @@index([configId, isActive])
}

model TrainingRecord {
  id            Int @id @default(autoincrement())
  configId      Int
  requirementId Int

  employeeId   String
  employeeName String
  department   String?
  role         String?

  status      TrainingStatus @default(NOT_ASSIGNED)
  assignedAt  DateTime?
  startedAt   DateTime?
  completedAt DateTime?
  expiresAt   DateTime?

  score    Int?
  passed   Boolean?
  attempts Int      @default(0)

  certificateUrl    String?
  certificateNumber String?

  lastReminderSent DateTime?
  reminderCount    Int       @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  config      SafetyMonitorConfig @relation(fields: [configId], references: [id], onDelete: Cascade)
  requirement TrainingRequirement @relation(fields: [requirementId], references: [id], onDelete: Cascade)

  @@unique([configId, requirementId, employeeId])
  @@index([configId, status])
  @@index([employeeId])
  @@index([expiresAt])
}

model OshaLog {
  id       Int @id @default(autoincrement())
  configId Int

  year       Int
  caseNumber String

  employeeName String
  jobTitle     String
  department   String?

  dateOfInjury    DateTime
  locationOfEvent String?
  description     String

  injuryType       String
  bodyPartAffected String?

  resultedInDeath  Boolean @default(false)
  daysAwayFromWork Int     @default(0)
  daysJobTransfer  Int     @default(0)
  daysRestriction  Int     @default(0)
  otherRecordable  Boolean @default(false)

  incidentId Int?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  config SafetyMonitorConfig @relation(fields: [configId], references: [id], onDelete: Cascade)

  @@unique([configId, year, caseNumber])
  @@index([configId, year])
}

model SafetyInspection {
  id       Int @id @default(autoincrement())
  configId Int

  name           String
  inspectionType String
  inspector      String?
  inspectorId    Int?

  scheduledDate DateTime
  completedAt   DateTime?
  status        String    @default("scheduled")

  location       String?
  department     String?
  areasInspected String[] @default([])

  overallScore     Int?
  findings         Json?
  deficiencies     Int   @default(0)
  criticalFindings Int   @default(0)

  correctiveActions Json?
  followUpDate      DateTime?

  reportUrl String?
  photoUrls String[] @default([])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  config SafetyMonitorConfig @relation(fields: [configId], references: [id], onDelete: Cascade)

  @@index([configId, status])
  @@index([scheduledDate])
}

model SafetyMonitorAnalytics {
  id       Int      @id @default(autoincrement())
  configId Int
  date     DateTime @db.Date

  totalIncidents      Int @default(0)
  oshaRecordables     Int @default(0)
  nearMisses          Int @default(0)
  daysWithoutIncident Int @default(0)

  minorIncidents   Int @default(0)
  seriousIncidents Int @default(0)
  severeIncidents  Int @default(0)

  checklistsCompleted Int @default(0)
  checklistsOverdue   Int @default(0)
  deficienciesFound   Int @default(0)

  hazardsReported  Int @default(0)
  hazardsMitigated Int @default(0)
  openHazards      Int @default(0)

  trainingsCompleted Int    @default(0)
  trainingsOverdue   Int    @default(0)
  complianceRate     Float?

  trir Float?
  dart Float?
  ltir Float?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([configId, date])
  @@index([configId, date(sort: Desc)])
}

// ============================================================================
// CUSTOMER SUCCESS PLATFORM
// ============================================================================

enum HealthScoreCategory {
  HEALTHY // 71-100 - Customer is thriving
  AT_RISK // 31-70 - Customer needs attention
  CRITICAL // 0-30 - Immediate intervention required
}

enum CTAType {
  RISK // Negative trend detected (usage drop, support issues)
  OPPORTUNITY // Positive signal (expansion potential, advocate)
  LIFECYCLE // Scheduled event (renewal, QBR, onboarding milestone)
  ACTIVITY // Tied to timeline activity
  OBJECTIVE // Used in Success Plans
}

enum CTAStatus {
  OPEN
  IN_PROGRESS
  SNOOZED
  COMPLETED
  CANCELLED
}

enum CTAPriority {
  CRITICAL // Immediate attention required
  HIGH // Address within 24-48 hours
  MEDIUM // Address this week
  LOW // Address when time permits
}

enum SuccessPlanStatus {
  DRAFT
  ACTIVE
  COMPLETED
  ON_HOLD
  CANCELLED
}

enum ObjectiveStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
  BLOCKED
}

enum PlaybookStatus {
  DRAFT
  ACTIVE
  ARCHIVED
}

enum EngagementLevel {
  CHAMPION // Strong advocate, highly engaged
  ENGAGED // Regular interaction, positive
  NEUTRAL // Occasional interaction
  DISENGAGED // Minimal interaction
  AT_RISK // Silent or negative signals
}

enum CSActivityType {
  MEETING
  EMAIL_SENT
  EMAIL_RECEIVED
  CALL
  SUPPORT_TICKET
  PRODUCT_USAGE
  NPS_RESPONSE
  CSAT_RESPONSE
  MILESTONE_COMPLETED
  DOCUMENT_SHARED
  NOTE
  CTA_CREATED
  CTA_COMPLETED
  RENEWAL
  EXPANSION
  CONTRACTION
}

/**
 * CustomerHealthScore - Tracks composite health scores for clients/projects
 * Health scoring uses weighted dimensions: Usage, Support, Engagement, Sentiment
 */
model CustomerHealthScore {
  id        Int     @id @default(autoincrement())
  tenantId  String? // Multi-tenant support
  clientId  Int
  projectId Int?

  // Composite score (0-100)
  overallScore Int                 @default(50)
  category     HealthScoreCategory @default(AT_RISK)

  // Individual dimension scores (0-100)
  usageScore      Int? // Product adoption, feature usage, login frequency
  supportScore    Int? // Ticket volume, resolution time, escalations
  engagementScore Int? // Meeting attendance, response time, executive involvement
  sentimentScore  Int? // NPS, CSAT, conversation sentiment
  financialScore  Int? // Payment history, ARR changes, upsell/downsell

  // Dimension weights (should sum to 100)
  usageWeight      Int @default(40)
  supportWeight    Int @default(25)
  engagementWeight Int @default(20)
  sentimentWeight  Int @default(15)
  financialWeight  Int @default(0)

  // Trend tracking
  previousScore   Int?
  scoreTrend      String? // UP, DOWN, STABLE
  trendPercentage Float? // Percentage change from previous

  // Risk indicators
  churnRisk          Float? // 0-1 probability score
  expansionPotential Float? // 0-1 probability score

  // Metadata
  lastCalculatedAt DateTime @default(now())
  calculationNotes String? // Explanation of score factors

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant  Tenant?              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  client  Client               @relation(fields: [clientId], references: [id], onDelete: Cascade)
  project Project?             @relation(fields: [projectId], references: [id], onDelete: Cascade)
  history HealthScoreHistory[]

  @@unique([clientId, projectId])
  @@index([tenantId])
  @@index([clientId, overallScore])
  @@index([category, lastCalculatedAt])
}

/**
 * HealthScoreHistory - Historical snapshots for trend analysis
 */
model HealthScoreHistory {
  id                    Int @id @default(autoincrement())
  customerHealthScoreId Int

  overallScore    Int
  category        HealthScoreCategory
  usageScore      Int?
  supportScore    Int?
  engagementScore Int?
  sentimentScore  Int?
  financialScore  Int?
  churnRisk       Float?

  snapshotDate DateTime @default(now())

  customerHealthScore CustomerHealthScore @relation(fields: [customerHealthScoreId], references: [id], onDelete: Cascade)

  @@index([customerHealthScoreId, snapshotDate(sort: Desc)])
}

/**
 * SuccessPlan - Goal-based customer success plans
 * Based on Gainsight's Success Plans with objectives and milestones
 */
model SuccessPlan {
  id        Int     @id @default(autoincrement())
  tenantId  String? // Multi-tenant support
  clientId  Int
  projectId Int?
  ownerId   Int

  name        String
  description String?
  status      SuccessPlanStatus @default(DRAFT)

  // Timeline
  startDate   DateTime?
  targetDate  DateTime?
  completedAt DateTime?

  // Customer goals (stored as structured JSON)
  // Example: [{ "goal": "Reduce support tickets by 30%", "metric": "ticket_volume", "baseline": 100, "target": 70 }]
  customerGoals Json?

  // Progress tracking
  progressPercent Int @default(0)

  // Customer-facing settings
  isCustomerVisible Boolean @default(false)
  customerNotes     String? // Notes visible to customer

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant     Tenant?            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  client     Client             @relation(fields: [clientId], references: [id], onDelete: Cascade)
  project    Project?           @relation(fields: [projectId], references: [id], onDelete: SetNull)
  owner      User               @relation(fields: [ownerId], references: [id])
  objectives SuccessObjective[]

  @@index([tenantId])
  @@index([clientId, status])
  @@index([ownerId, status])
}

/**
 * SuccessObjective - Individual objectives within a success plan
 */
model SuccessObjective {
  id            Int @id @default(autoincrement())
  successPlanId Int

  title       String
  description String?
  status      ObjectiveStatus @default(NOT_STARTED)

  // Timeline
  dueDate     DateTime?
  completedAt DateTime?

  // Progress
  progressPercent Int @default(0)

  // Ordering
  orderIndex Int @default(0)

  // Success criteria
  successCriteria String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  successPlan SuccessPlan   @relation(fields: [successPlanId], references: [id], onDelete: Cascade)
  tasks       SuccessTask[]

  @@index([successPlanId, status])
}

/**
 * SuccessTask - Tasks within an objective (similar to existing Task model but for CS)
 */
model SuccessTask {
  id          Int  @id @default(autoincrement())
  objectiveId Int
  ownerId     Int?

  title       String
  description String?
  status      TaskStatus @default(BACKLOG)
  priority    Priority   @default(P1)
  dueDate     DateTime?
  completedAt DateTime?

  orderIndex Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  objective SuccessObjective @relation(fields: [objectiveId], references: [id], onDelete: Cascade)
  owner     User?            @relation(fields: [ownerId], references: [id], onDelete: SetNull)

  @@index([objectiveId, status])
}

/**
 * CTA - Call-to-Action for CSM workflow management
 * Central to Gainsight's Cockpit functionality
 */
model CTA {
  id        Int     @id @default(autoincrement())
  tenantId  String? // Multi-tenant support
  clientId  Int
  projectId Int?
  ownerId   Int

  type     CTAType
  status   CTAStatus   @default(OPEN)
  priority CTAPriority @default(MEDIUM)

  title       String
  description String?
  reason      String? // Why this CTA was created

  // Timeline
  dueDate     DateTime?
  snoozeUntil DateTime?
  completedAt DateTime?

  // Playbook attachment
  playbookId Int?

  // Linked records
  successPlanId   Int?
  linkedMeetingId Int?

  // Resolution
  resolutionNotes String?
  outcome         String? // Positive, Neutral, Negative

  // Auto-creation metadata
  isAutomated Boolean @default(false)
  triggerRule String? // Name of rule that created this
  triggerData Json? // Data that triggered creation

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant   Tenant?   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  client   Client    @relation(fields: [clientId], references: [id], onDelete: Cascade)
  project  Project?  @relation(fields: [projectId], references: [id], onDelete: SetNull)
  owner    User      @relation(fields: [ownerId], references: [id])
  playbook Playbook? @relation(fields: [playbookId], references: [id], onDelete: SetNull)
  ctaTasks CTATask[]

  @@index([tenantId])
  @@index([clientId, status])
  @@index([ownerId, status, priority])
  @@index([type, status])
  @@index([dueDate, status])
}

/**
 * CTATask - Tasks within a CTA (from playbook or manual)
 */
model CTATask {
  id      Int  @id @default(autoincrement())
  ctaId   Int
  ownerId Int?

  title       String
  description String?
  status      TaskStatus @default(BACKLOG)
  dueDate     DateTime?
  completedAt DateTime?

  orderIndex     Int     @default(0)
  isFromPlaybook Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  cta   CTA   @relation(fields: [ctaId], references: [id], onDelete: Cascade)
  owner User? @relation(fields: [ownerId], references: [id], onDelete: SetNull)

  @@index([ctaId, status])
}

/**
 * Playbook - Reusable task sequences for standardized CS responses
 */
model Playbook {
  id          Int            @id @default(autoincrement())
  tenantId    String?        // Multi-tenant support
  name        String
  description String?
  status      PlaybookStatus @default(DRAFT)

  // Categorization
  ctaType  CTAType? // Which CTA types this applies to
  category String? // E.g., "Onboarding", "Renewal", "Risk Mitigation"

  // Usage tracking
  timesUsed Int @default(0)

  createdById Int?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tenant    Tenant?        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  createdBy User?          @relation(fields: [createdById], references: [id], onDelete: SetNull)
  tasks     PlaybookTask[]
  ctas      CTA[]

  @@index([tenantId])
  @@index([status, ctaType])
}

/**
 * PlaybookTask - Template tasks within a playbook
 */
model PlaybookTask {
  id         Int @id @default(autoincrement())
  playbookId Int

  title       String
  description String?

  // Relative timing (days from CTA creation)
  daysFromStart Int @default(0)

  // Default assignment
  assignToOwner Boolean @default(true) // Assign to CTA owner

  orderIndex Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  playbook Playbook @relation(fields: [playbookId], references: [id], onDelete: Cascade)

  @@index([playbookId])
}

/**
 * CSActivityLog - Unified timeline of all customer interactions
 * Similar to Gainsight's Activity Timeline
 */
model CSActivityLog {
  id        Int  @id @default(autoincrement())
  clientId  Int
  projectId Int?
  contactId Int? // Which contact was involved
  userId    Int? // Which CSM/user logged this

  activityType CSActivityType
  title        String
  description  String?

  // Activity-specific data (flexible JSON)
  // E.g., for MEETING: { duration: 60, attendees: [...] }
  // E.g., for NPS_RESPONSE: { score: 9, comment: "..." }
  metadata Json?

  // Sentiment analysis (optional AI-enriched)
  sentiment      String? // POSITIVE, NEUTRAL, NEGATIVE
  sentimentScore Float? // -1 to 1

  // Link to source record
  sourceMeetingId Int?
  sourceTicketId  String?
  sourceEmailId   String?

  activityDate DateTime @default(now())
  createdAt    DateTime @default(now())

  client  Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  project Project? @relation(fields: [projectId], references: [id], onDelete: SetNull)
  contact Contact? @relation(fields: [contactId], references: [id], onDelete: SetNull)
  user    User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([clientId, activityDate(sort: Desc)])
  @@index([projectId, activityDate(sort: Desc)])
  @@index([activityType, activityDate(sort: Desc)])
}

/**
 * CSMetricSnapshot - Daily aggregated metrics for dashboards and trends
 */
model CSMetricSnapshot {
  id           Int      @id @default(autoincrement())
  clientId     Int? // null for portfolio-level metrics
  projectId    Int?
  snapshotDate DateTime @db.Date

  // Health metrics
  healthScore    Int?
  healthCategory HealthScoreCategory?
  churnRisk      Float?

  // Engagement metrics
  meetingsCount  Int @default(0)
  emailsSent     Int @default(0)
  emailsReceived Int @default(0)
  supportTickets Int @default(0)

  // Usage metrics
  activeUsers     Int?
  loginCount      Int?
  featureAdoption Float? // Percentage of features used

  // Financial metrics
  arr Decimal? @db.Decimal(12, 2)
  mrr Decimal? @db.Decimal(12, 2)

  // Satisfaction metrics
  npsScore  Int?
  csatScore Float?

  // CTA metrics
  openCTAs      Int @default(0)
  completedCTAs Int @default(0)
  overdueCTAs   Int @default(0)

  createdAt DateTime @default(now())

  client  Client?  @relation(fields: [clientId], references: [id], onDelete: Cascade)
  project Project? @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([clientId, projectId, snapshotDate])
  @@index([snapshotDate(sort: Desc)])
  @@index([clientId, snapshotDate(sort: Desc)])
}

/**
 * ContactEngagement - Track engagement level per contact (stakeholder mapping)
 */
model ContactEngagement {
  id        Int @id @default(autoincrement())
  contactId Int @unique

  engagementLevel EngagementLevel @default(NEUTRAL)

  // Role and influence
  isChampion      Boolean @default(false)
  isDecisionMaker Boolean @default(false)
  isEconomicBuyer Boolean @default(false)
  influence       String? // HIGH, MEDIUM, LOW

  // Engagement metrics
  lastContactDate   DateTime?
  contactFrequency  String? // WEEKLY, MONTHLY, QUARTERLY, RARELY
  responseTime      Int? // Average response time in hours
  meetingAttendance Float? // Percentage of meetings attended

  // Sentiment tracking
  lastSentiment String? // POSITIVE, NEUTRAL, NEGATIVE
  npsScore      Int? // Individual NPS score

  // Relationship notes
  notes String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  contact Contact @relation(fields: [contactId], references: [id], onDelete: Cascade)
}

/**
 * CSRule - Automation rules for CTA creation and alerts
 * Similar to Gainsight's Rules Engine
 */
model CSRule {
  id          Int     @id @default(autoincrement())
  name        String
  description String?
  isActive    Boolean @default(true)

  // Rule type
  ruleType String // CTA_CREATION, ALERT, HEALTH_SCORE, JOURNEY

  // Trigger conditions (stored as JSON)
  // Example: { "type": "health_score_drop", "threshold": 20, "timeframe": "7d" }
  conditions Json

  // Actions to take (stored as JSON)
  // Example: { "type": "create_cta", "ctaType": "RISK", "priority": "HIGH", "playbookId": 1 }
  actions Json

  // Scheduling
  runFrequency String    @default("DAILY") // REALTIME, HOURLY, DAILY, WEEKLY
  lastRunAt    DateTime?
  nextRunAt    DateTime?

  // Statistics
  timesTriggered Int @default(0)

  createdById Int?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  createdBy User? @relation(fields: [createdById], references: [id], onDelete: SetNull)

  @@index([isActive, ruleType])
  @@index([nextRunAt, isActive])
}

/**
 * NPS/CSAT Survey - Customer satisfaction surveys
 */
model CSSurvey {
  id       Int    @id @default(autoincrement())
  clientId Int? // null for template surveys
  name     String

  surveyType String // NPS, CSAT, CES, CUSTOM
  isTemplate Boolean @default(false)
  isActive   Boolean @default(true)

  // Survey configuration (JSON)
  // Example: { "question": "How likely...", "followUpEnabled": true, "followUpQuestion": "..." }
  config Json?

  // Delivery settings
  triggerEvent String? // ONBOARDING_COMPLETE, SUPPORT_RESOLVED, RENEWAL_APPROACHING

  // Statistics
  responseCount Int    @default(0)
  averageScore  Float?

  createdById Int?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  client    Client?            @relation(fields: [clientId], references: [id], onDelete: Cascade)
  createdBy User?              @relation(fields: [createdById], references: [id], onDelete: SetNull)
  responses CSSurveyResponse[]

  @@index([clientId, isActive])
  @@index([surveyType, isTemplate])
}

/**
 * CSSurveyResponse - Individual survey responses
 */
model CSSurveyResponse {
  id        Int  @id @default(autoincrement())
  surveyId  Int
  clientId  Int
  contactId Int?
  projectId Int?

  // Score
  score Int // NPS: 0-10, CSAT: 1-5, etc.

  // Categorization (for NPS)
  category String? // PROMOTER, PASSIVE, DETRACTOR

  // Follow-up
  comment String?

  // AI-enriched
  sentiment String?
  themes    String[] @default([])

  respondedAt DateTime @default(now())

  survey  CSSurvey @relation(fields: [surveyId], references: [id], onDelete: Cascade)
  client  Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  contact Contact? @relation(fields: [contactId], references: [id], onDelete: SetNull)
  project Project? @relation(fields: [projectId], references: [id], onDelete: SetNull)

  @@index([surveyId, respondedAt(sort: Desc)])
  @@index([clientId, respondedAt(sort: Desc)])
}

// ============================================================================
// MULTI-TENANT CRM SYSTEM
// ============================================================================

enum TenantPlan {
  TRIAL
  STARTER
  PROFESSIONAL
  ENTERPRISE
}

enum TenantStatus {
  PENDING
  ACTIVE
  SUSPENDED
  CANCELLED
}

enum TenantRole {
  OWNER
  ADMIN
  MEMBER
  VIEWER
}

enum SSLStatus {
  PENDING
  PROVISIONING
  ACTIVE
  FAILED
}

enum ModuleTier {
  TRIAL
  BASIC
  PREMIUM
  ENTERPRISE
}

enum AccountType {
  PROSPECT
  CUSTOMER
  PARTNER
  COMPETITOR
  CHURNED
  OTHER
}

enum AccountEmployeeCount {
  SOLO
  MICRO
  SMALL
  MEDIUM
  LARGE
  ENTERPRISE
}

enum OpportunityStatus {
  OPEN
  WON
  LOST
}

enum CRMActivityType {
  CALL
  EMAIL
  MEETING
  TASK
  NOTE
  SMS
  LINKEDIN_MESSAGE
  CHAT
  DEMO
  PROPOSAL
  CONTRACT
  OTHER
}

enum CRMActivityStatus {
  PLANNED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  NO_SHOW
}

enum CRMActivityPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

/**
 * CRMLeadSource - Preferred enum for tracking lead sources in CRM.
 * Use this instead of the legacy LeadSource enum for new features.
 * Provides more comprehensive source tracking than the legacy enum.
 */
enum CRMLeadSource {
  WEBSITE
  REFERRAL
  LINKEDIN
  COLD_CALL
  COLD_EMAIL
  EVENT
  PARTNER
  INBOUND
  OUTBOUND
  OTHER
}

/**
 * ContactLifecycle - CRM contact lifecycle stages.
 * Replaces the legacy LeadStatus enum with a more comprehensive lifecycle model.
 * Used for CRMContact to track contacts through their entire journey.
 */
enum ContactLifecycle {
  LEAD
  MQL
  SQL
  OPPORTUNITY
  CUSTOMER
  EVANGELIST
  CHURNED
}

enum PipelineStageType {
  OPEN
  WON
  LOST
}

enum NotificationType {
  DEAL_ASSIGNED
  DEAL_STAGE_CHANGED
  DEAL_WON
  DEAL_LOST
  DEAL_STALE
  DEAL_CLOSE_DATE_APPROACHING
  TASK_ASSIGNED
  TASK_DUE
  TASK_OVERDUE
  MEETING_REMINDER
  MENTION
  ACCOUNT_HEALTH_DROPPED
  ACCOUNT_ASSIGNED
  INTEGRATION_ERROR
  USAGE_LIMIT_WARNING
  USAGE_LIMIT_REACHED
  AI_INSIGHT
  LEAD_SCORE_CHANGED
}

enum NotificationPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

enum NotificationChannel {
  IN_APP
  EMAIL
  SLACK
  SMS
  BROWSER_PUSH
}

// ============================================================================
// TENANT MODELS
// ============================================================================

/**
 * Tenant - Organization/workspace in multi-tenant system
 */
model Tenant {
  id   String @id @default(cuid())
  name String
  slug String @unique

  plan         TenantPlan   @default(STARTER)
  status       TenantStatus @default(ACTIVE)
  billingEmail String?
  settings     Json?

  trialEndsAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  users                     TenantUser[]
  domains                   TenantDomain[]
  branding                  TenantBranding?
  modules                   TenantModule[]
  accounts                  Account[]
  crmContacts               CRMContact[]
  opportunities             Opportunity[]
  pipelines                 Pipeline[]
  activities                CRMActivity[]
  notifications             Notification[]
  // CRM Phase 3-6 relations
  integrations              Integration[]
  usageEvents               UsageEvent[]
  usageSummaries            UsageSummary[]
  savedReports              SavedReport[]
  // Legacy PMO models (tenant-scoped)
  clients                   Client[]
  contacts                  Contact[]
  projects                  Project[]
  tasks                     Task[]
  milestones                Milestone[]
  meetings                  Meeting[]
  aiAssets                  AIAsset[]
  marketingContents         MarketingContent[]
  campaigns                 Campaign[]
  inboundLeads              InboundLead[]
  // AI Tool configurations (tenant-scoped)
  productDescriptionConfigs     ProductDescriptionConfig[]
  schedulingConfigs             SchedulingConfig[]
  chatbotConfigs                ChatbotConfig[]
  intakeConfigs                 IntakeConfig[]
  documentAnalyzerConfigs       DocumentAnalyzerConfig[]
  contentGeneratorConfigs       ContentGeneratorConfig[]
  leadScoringConfigs            LeadScoringConfig[]
  priorAuthConfigs              PriorAuthConfig[]
  inventoryForecastConfigs      InventoryForecastConfig[]
  complianceMonitorConfigs      ComplianceMonitorConfig[]
  predictiveMaintenanceConfigs  PredictiveMaintenanceConfig[]
  revenueManagementConfigs      RevenueManagementConfig[]
  safetyMonitorConfigs          SafetyMonitorConfig[]
  // Audit and health metrics
  auditLogs                 AuditLog[]
  healthMetrics             TenantHealthMetrics[]

  // Finance Tracking relations
  financeConfig        FinanceConfig?
  expenseCategories    ExpenseCategory[]
  budgets              Budget[]
  expenses             Expense[]
  recurringCosts       RecurringCost[]
  accountProfitability AccountProfitability[]
  financeAlerts        FinanceAlert[]
  financeInsights      FinanceInsight[]

  // AI Monitoring relations
  aiUsageEvents    AIUsageEvent[]
  aiUsageSummaries AIUsageSummary[]

  // Customer Success relations
  customerHealthScores CustomerHealthScore[]
  successPlans         SuccessPlan[]
  ctas                 CTA[]
  playbooks            Playbook[]

  @@index([slug])
  @@index([status])
}

/**
 * TenantUser - User membership in a tenant
 */
model TenantUser {
  id       Int        @id @default(autoincrement())
  tenantId String
  userId   Int
  role     TenantRole @default(MEMBER)

  invitedAt  DateTime  @default(now())
  acceptedAt DateTime?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([tenantId, userId])
  @@index([userId])
}

/**
 * TenantDomain - Custom domain configuration
 */
model TenantDomain {
  id       String @id @default(cuid())
  tenantId String
  domain   String @unique

  isPrimary   Boolean   @default(false)
  verified    Boolean   @default(false)
  verifiedAt  DateTime?
  verifyToken String?
  sslStatus   SSLStatus @default(PENDING)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
}

/**
 * TenantBranding - White-label branding settings
 */
model TenantBranding {
  id       Int    @id @default(autoincrement())
  tenantId String @unique

  logoUrl      String?
  logoLightUrl String?
  faviconUrl   String?

  primaryColor   String?
  secondaryColor String?
  accentColor    String?
  fontFamily     String?
  customCss      String?

  emailLogoUrl    String?
  emailFooterText String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
}

/**
 * TenantModule - Module enablement and configuration per tenant
 */
model TenantModule {
  id       Int    @id @default(autoincrement())
  tenantId String
  moduleId String

  enabled     Boolean    @default(true)
  tier        ModuleTier @default(BASIC)
  trialEndsAt DateTime?
  usageLimits Json?
  settings    Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, moduleId])
  @@index([tenantId])
}

// ============================================================================
// CRM ACCOUNT & CONTACT MODELS
// ============================================================================

/**
 * Account - Company/Organization in CRM
 */
model Account {
  id       Int    @id @default(autoincrement())
  tenantId String

  name            String
  website         String?
  phone           String?
  parentAccountId Int?

  type          AccountType           @default(PROSPECT)
  industry      String?
  employeeCount AccountEmployeeCount?
  annualRevenue Decimal?              @db.Decimal(15, 2)

  billingAddress  Json?
  shippingAddress Json?

  healthScore     Int?   @default(50)
  engagementScore Int?   @default(50)
  churnRisk       Float?

  ownerId      Int
  tags         String[] @default([])
  customFields Json?
  archived     Boolean  @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant        Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  owner         User          @relation(fields: [ownerId], references: [id])
  parentAccount Account?      @relation("AccountHierarchy", fields: [parentAccountId], references: [id], onDelete: SetNull)
  childAccounts Account[]     @relation("AccountHierarchy")
  crmContacts   CRMContact[]
  opportunities Opportunity[]
  activities    CRMActivity[]

  // PMO relations (migrated from legacy Client)
  projects          Project[]
  documents         Document[]
  marketingContents MarketingContent[]
  aiAssets          AIAsset[]
  campaigns         Campaign[]
  meetings          Meeting[]

  // AI Tool configurations (replaces legacy Client relations)
  chatbotConfig            ChatbotConfig?
  documentAnalyzerConfig   DocumentAnalyzerConfig?
  productDescriptionConfig ProductDescriptionConfig?

  // Finance Tracking relations
  budgets         Budget[]
  expenses        Expense[]
  recurringCosts  RecurringCost[]
  profitability   AccountProfitability[]
  financeInsights FinanceInsight[]

  // Scheduling relations
  schedulingConfig       SchedulingConfig? // Type A: Appointment scheduling (one-to-one with Account)
  shiftSchedulingConfigs ShiftSchedulingConfig[] // Type B: Shift scheduling

  @@index([tenantId, type])
  @@index([tenantId, ownerId])
  @@index([tenantId, archived])
}

/**
 * CRMContact - Contact within CRM (preferred model for new features)
 * Features not in legacy Contact:
 * - Lifecycle stages (LEAD  MQL  SQL  OPPORTUNITY  CUSTOMER)
 * - Lead scoring with numeric score
 * - Account hierarchy support
 * - Social profiles (LinkedIn, Twitter)
 * - Communication preferences (doNotContact)
 * Email uniqueness: Per-tenant (stricter deduplication than legacy Contact)
 * This prevents duplicate contacts across the entire tenant's CRM.
 */
model CRMContact {
  id        Int    @id @default(autoincrement())
  tenantId  String
  accountId Int?

  firstName  String
  lastName   String
  email      String?
  phone      String?
  mobile     String?
  jobTitle   String?
  department String?

  lifecycle    ContactLifecycle @default(LEAD)
  leadSource   CRMLeadSource?
  leadScore    Int?
  isPrimary    Boolean          @default(false)
  doNotContact Boolean          @default(false)

  linkedinUrl String?
  twitterUrl  String?
  address     Json?

  ownerId      Int?
  tags         String[] @default([])
  customFields Json?
  archived     Boolean  @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant              Tenant               @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  account             Account?             @relation(fields: [accountId], references: [id], onDelete: SetNull)
  owner               User?                @relation(fields: [ownerId], references: [id], onDelete: SetNull)
  opportunityContacts OpportunityContact[]
  activities          CRMActivity[]

  @@unique([tenantId, email])
  @@index([tenantId, accountId])
  @@index([tenantId, lifecycle])
}

// ============================================================================
// PIPELINE & OPPORTUNITY MODELS
// ============================================================================

/**
 * Pipeline - Sales pipeline with customizable stages
 */
model Pipeline {
  id       Int    @id @default(autoincrement())
  tenantId String

  name        String
  description String?
  isDefault   Boolean @default(false)
  isActive    Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant        Tenant               @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  stages        SalesPipelineStage[]
  opportunities Opportunity[]

  @@index([tenantId, isDefault])
}

/**
 * SalesPipelineStage - Stage within a sales pipeline
 */
model SalesPipelineStage {
  id         Int @id @default(autoincrement())
  pipelineId Int

  name        String
  description String?
  order       Int
  probability Int               @default(0)
  type        PipelineStageType @default(OPEN)
  color       String?

  rottenDays Int? // Days before deal is considered stale

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  pipeline      Pipeline                  @relation(fields: [pipelineId], references: [id], onDelete: Cascade)
  opportunities Opportunity[]
  stageHistory  OpportunityStageHistory[] @relation("ToStage")
  fromHistory   OpportunityStageHistory[] @relation("FromStage")

  @@unique([pipelineId, order])
  @@index([pipelineId])
}

/**
 * Opportunity - Deal/Potential revenue
 */
model Opportunity {
  id       Int    @id @default(autoincrement())
  tenantId String

  name        String
  description String?

  accountId  Int
  pipelineId Int?
  stageId    Int

  amount         Decimal? @db.Decimal(15, 2)
  probability    Int?
  weightedAmount Decimal? @db.Decimal(15, 2)
  currency       String   @default("USD")

  status            OpportunityStatus @default(OPEN)
  expectedCloseDate DateTime?
  actualCloseDate   DateTime?

  leadSource       CRMLeadSource?
  campaignId       Int?
  lostReason       String?
  lostReasonDetail String?
  competitorId     Int?

  ownerId      Int
  tags         String[] @default([])
  customFields Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant       Tenant                    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  account      Account                   @relation(fields: [accountId], references: [id], onDelete: Cascade)
  pipeline     Pipeline?                 @relation(fields: [pipelineId], references: [id], onDelete: SetNull)
  stage        SalesPipelineStage        @relation(fields: [stageId], references: [id])
  owner        User                      @relation(fields: [ownerId], references: [id])
  contacts     OpportunityContact[]
  stageHistory OpportunityStageHistory[]
  activities   CRMActivity[]

  // Finance Tracking relations
  expenses Expense[]

  @@index([tenantId, status])
  @@index([tenantId, ownerId])
  @@index([tenantId, expectedCloseDate])
  @@index([accountId])
}

/**
 * OpportunityContact - Junction table for opportunity contacts
 */
model OpportunityContact {
  id            Int @id @default(autoincrement())
  opportunityId Int
  contactId     Int

  role      String?
  isPrimary Boolean @default(false)

  createdAt DateTime @default(now())

  opportunity Opportunity @relation(fields: [opportunityId], references: [id], onDelete: Cascade)
  contact     CRMContact  @relation(fields: [contactId], references: [id], onDelete: Cascade)

  @@unique([opportunityId, contactId])
}

/**
 * OpportunityStageHistory - Track stage changes
 */
model OpportunityStageHistory {
  id            Int  @id @default(autoincrement())
  opportunityId Int
  fromStageId   Int?
  toStageId     Int

  changedById Int
  changedAt   DateTime @default(now())

  duration Int? // Time in previous stage (minutes)
  notes    String?

  opportunity Opportunity         @relation(fields: [opportunityId], references: [id], onDelete: Cascade)
  fromStage   SalesPipelineStage? @relation("FromStage", fields: [fromStageId], references: [id], onDelete: SetNull)
  toStage     SalesPipelineStage  @relation("ToStage", fields: [toStageId], references: [id])
  changedBy   User                @relation(fields: [changedById], references: [id])

  @@index([opportunityId, changedAt(sort: Desc)])
}

// ============================================================================
// CRM ACTIVITY MODEL
// ============================================================================

/**
 * CRMActivity - Unified activity timeline for CRM interactions
 * Tracks all interactions: calls, emails, meetings, tasks, notes, etc.
 * Activities can be linked to accounts, contacts, and/or opportunities.
 * Cascade Rules (intentional design):
 * - Tenant deleted  Activities CASCADE deleted (tenant isolation)
 * - Account deleted  Activity's accountId SET NULL (preserves activity history)
 * - Contact deleted  Activity's contactId SET NULL (preserves activity history)
 * - Opportunity deleted  Activity's opportunityId SET NULL (preserves activity history)
 * The SetNull behavior ensures activity history is preserved even when
 * linked entities are removed, which is important for audit trails.
 */
model CRMActivity {
  id       Int    @id @default(autoincrement())
  tenantId String

  type CRMActivityType

  accountId     Int?
  contactId     Int?
  opportunityId Int?

  subject     String?
  description String?
  outcome     String?

  scheduledAt DateTime?
  dueAt       DateTime?
  completedAt DateTime?
  duration    Int? // minutes

  status   CRMActivityStatus   @default(PLANNED)
  priority CRMActivityPriority @default(NORMAL)

  externalId     String?
  externalSource String?

  ownerId     Int
  createdById Int
  metadata    Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations with explicit cascade rules
  tenant      Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  account     Account?     @relation(fields: [accountId], references: [id], onDelete: SetNull)
  contact     CRMContact?  @relation(fields: [contactId], references: [id], onDelete: SetNull)
  opportunity Opportunity? @relation(fields: [opportunityId], references: [id], onDelete: SetNull)
  owner       User         @relation("ActivityOwner", fields: [ownerId], references: [id])
  createdBy   User         @relation("ActivityCreator", fields: [createdById], references: [id])

  @@index([tenantId, type])
  @@index([tenantId, ownerId])
  @@index([accountId])
  @@index([opportunityId])
  @@index([dueAt])
}

// ============================================================================
// NOTIFICATION MODEL
// ============================================================================

/**
 * Notification - User notifications
 */
model Notification {
  id       Int    @id @default(autoincrement())
  tenantId String
  userId   Int

  type     NotificationType
  title    String
  message  String
  priority NotificationPriority @default(NORMAL)

  actionUrl  String?
  entityType String?
  entityId   Int?

  channels NotificationChannel[] @default([IN_APP])

  read      Boolean   @default(false)
  readAt    DateTime?
  expiresAt DateTime?

  createdAt DateTime @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([tenantId, userId, read])
  @@index([userId, createdAt(sort: Desc)])
}

// ============================================================================
// CRM PHASE 3-6: INTEGRATION HUB
// ============================================================================

enum IntegrationProvider {
  GMAIL
  OUTLOOK
  GOOGLE_CALENDAR
  OUTLOOK_CALENDAR
  SALESFORCE
  HUBSPOT
  PIPEDRIVE
  SLACK
  TEAMS
  ZAPIER
  MAKE
  CUSTOM_WEBHOOK
}

enum IntegrationStatus {
  DISCONNECTED
  CONNECTING
  CONNECTED
  ERROR
  EXPIRED
}

enum SyncDirection {
  INBOUND
  OUTBOUND
  BIDIRECTIONAL
}

enum SyncStatus {
  PENDING
  IN_PROGRESS
  SUCCESS
  FAILED
  SKIPPED
}

/**
 * Integration - External system connections
 */
model Integration {
  id       Int    @id @default(autoincrement())
  tenantId String

  provider IntegrationProvider
  name     String

  status      IntegrationStatus @default(DISCONNECTED)
  credentials String? // Encrypted OAuth tokens, API keys

  syncSettings  Json? // What to sync, direction, frequency
  fieldMappings Json? // Field mapping configuration

  lastSyncAt     DateTime?
  lastSyncStatus String?
  lastSyncError  String?
  nextSyncAt     DateTime?

  webhookUrl    String?
  webhookSecret String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant   Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  syncLogs SyncLog[]

  @@unique([tenantId, provider])
  @@index([tenantId, status])
}

/**
 * SyncLog - Integration sync history
 */
model SyncLog {
  id            Int @id @default(autoincrement())
  integrationId Int

  direction  SyncDirection
  entityType String
  entityId   Int?
  externalId String?

  status       SyncStatus
  errorMessage String?

  payload Json?

  startedAt   DateTime  @default(now())
  completedAt DateTime?

  integration Integration @relation(fields: [integrationId], references: [id], onDelete: Cascade)

  @@index([integrationId, status])
  @@index([integrationId, entityType, entityId])
}

// ============================================================================
// CRM PHASE 3-6: USAGE METERING
// ============================================================================

enum UsagePeriod {
  DAILY
  WEEKLY
  MONTHLY
}

/**
 * UsageEvent - Individual usage events for tracking
 */
model UsageEvent {
  id       BigInt @id @default(autoincrement())
  tenantId String
  moduleId String

  eventType String
  quantity  Int    @default(1)

  userId     Int?
  entityType String?
  entityId   Int?

  metadata Json?

  createdAt DateTime @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, moduleId, createdAt])
  @@index([tenantId, createdAt])
}

/**
 * UsageSummary - Aggregated usage for billing periods
 */
model UsageSummary {
  id       Int    @id @default(autoincrement())
  tenantId String
  moduleId String

  period      UsagePeriod
  periodStart DateTime
  periodEnd   DateTime

  totalEvents   Int @default(0)
  totalQuantity Int @default(0)

  breakdown Json?

  estimatedCost Decimal? @db.Decimal(10, 2)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, moduleId, period, periodStart])
  @@index([tenantId, periodStart])
}

// ============================================================================
// CRM PHASE 3-6: ANALYTICS & REPORTING
// ============================================================================

/**
 * SavedReport - Custom report configurations
 */
model SavedReport {
  id       Int    @id @default(autoincrement())
  tenantId String

  name        String
  description String?
  type        String  @default("CUSTOM")
  entity      String

  config Json // columns, filters, sortBy, groupBy, schedule

  createdById Int
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tenant    Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  createdBy User   @relation(fields: [createdById], references: [id])

  @@index([tenantId, createdById])
  @@index([tenantId, entity])
}

// ============================================================================
// AUDIT LOGGING
// ============================================================================

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  LOGIN
  LOGOUT
  EXPORT
  BULK_UPDATE
  BULK_DELETE
  PERMISSION_CHANGE
  TENANT_SWITCH
}

/**
 * AuditLog - Track all sensitive operations with who did what, when, and what changed
 */
model AuditLog {
  id         String      @id @default(cuid())
  tenantId   String?
  userId     Int?
  action     AuditAction
  entityType String // e.g., "Account", "Opportunity", "CRMContact"
  entityId   String // ID of the affected entity
  changes    Json? // { before: {...}, after: {...} }
  metadata   Json? // Request IP, user agent, etc.
  createdAt  DateTime    @default(now())

  tenant Tenant? @relation(fields: [tenantId], references: [id], onDelete: SetNull)
  user   User?   @relation("AuditLogUser", fields: [userId], references: [id], onDelete: SetNull)

  @@index([tenantId, createdAt])
  @@index([tenantId, entityType, entityId])
  @@index([userId, createdAt])
  @@index([action, createdAt])
}

// ============================================================================
// TENANT HEALTH METRICS
// ============================================================================

/**
 * TenantHealthMetrics - Track tenant usage, quotas, and health metrics
 */
model TenantHealthMetrics {
  id         String   @id @default(cuid())
  tenantId   String
  recordedAt DateTime @default(now())

  // Usage metrics
  activeUsers      Int @default(0)
  totalUsers       Int @default(0)
  accountCount     Int @default(0)
  contactCount     Int @default(0)
  opportunityCount Int @default(0)
  activityCount    Int @default(0)

  // Storage
  storageUsedMB  Float @default(0)
  documentsCount Int   @default(0)

  // API usage
  apiCallsToday Int @default(0)
  apiCallsMonth Int @default(0)

  // Engagement
  dailyActiveUsers  Int       @default(0)
  weeklyActiveUsers Int       @default(0)
  lastActivityAt    DateTime?

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, recordedAt])
}

// ============================================================================
// FINANCE TRACKING MODULE
// ============================================================================

enum BudgetPeriod {
  WEEKLY
  MONTHLY
  QUARTERLY
  YEARLY
  CUSTOM
}

enum BudgetStatus {
  DRAFT
  ACTIVE
  PAUSED
  CLOSED
}

enum ExpenseStatus {
  DRAFT
  PENDING
  APPROVED
  REJECTED
  PAID
  CANCELLED
}

enum RecurringCostType {
  SUBSCRIPTION
  LICENSE
  PAYROLL
  BENEFITS
  CONTRACTOR
  RENT
  UTILITIES
  INSURANCE
  MAINTENANCE
  OTHER
}

enum RecurringFrequency {
  WEEKLY
  BIWEEKLY
  MONTHLY
  QUARTERLY
  SEMIANNUALLY
  YEARLY
}

enum RecurringCostStatus {
  DRAFT
  ACTIVE
  PAUSED
  CANCELLED
  EXPIRED
}

enum ProfitabilityPeriod {
  MONTHLY
  QUARTERLY
  YEARLY
}

enum FinanceAlertType {
  BUDGET_THRESHOLD
  BUDGET_EXCEEDED
  EXPENSE_PENDING_APPROVAL
  EXPENSE_APPROVED
  EXPENSE_REJECTED
  RENEWAL_UPCOMING
  RENEWAL_OVERDUE
  ANOMALY_DETECTED
  FORECAST_WARNING
}

enum FinanceAlertSeverity {
  INFO
  WARNING
  CRITICAL
}

enum FinanceInsightType {
  SPENDING_TREND
  COST_OPTIMIZATION
  BUDGET_RECOMMENDATION
  ANOMALY_INSIGHT
  FORECAST
  PROFITABILITY
}

/**
 * FinanceConfig - Finance module configuration per tenant
 */
model FinanceConfig {
  id       Int    @id @default(autoincrement())
  tenantId String @unique

  // Feature toggles
  enableExpenseTracking  Boolean @default(true)
  enableBudgetManagement Boolean @default(true)
  enableRecurringCosts   Boolean @default(true)
  enableProfitability    Boolean @default(true)

  // AI feature toggles
  enableAICategorization Boolean @default(false)
  enableAnomalyDetection Boolean @default(false)
  enableForecasting      Boolean @default(false)

  // Alert settings
  budgetAlertThresholds Json    @default("[50, 75, 90, 100]")
  notifyOnApproval      Boolean @default(true)

  // Currency settings
  defaultCurrency String @default("USD")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
}

/**
 * ExpenseCategory - Expense categories (predefined + custom)
 */
model ExpenseCategory {
  id          Int     @id @default(autoincrement())
  tenantId    String
  name        String
  description String?
  color       String  @default("#6B7280")
  icon        String  @default("folder")
  isSystem    Boolean @default(false)
  isActive    Boolean @default(true)
  parentId    Int?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant         Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  parent         ExpenseCategory?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children       ExpenseCategory[] @relation("CategoryHierarchy")
  expenses       Expense[]
  budgets        Budget[]
  recurringCosts RecurringCost[]

  @@unique([tenantId, name])
  @@index([tenantId, isActive])
}

/**
 * Budget - Budget definitions
 */
model Budget {
  id         Int    @id @default(autoincrement())
  tenantId   String
  accountId  Int?
  projectId  Int?
  categoryId Int?

  name        String
  description String?
  amount      Decimal @db.Decimal(15, 2)
  spent       Decimal @default(0) @db.Decimal(15, 2)
  currency    String  @default("USD")

  period    BudgetPeriod
  startDate DateTime
  endDate   DateTime?

  alertThresholds Json @default("[50, 75, 90, 100]")
  lastAlertLevel  Int?

  allowRollover  Boolean @default(false)
  rolloverAmount Decimal @default(0) @db.Decimal(15, 2)

  status  BudgetStatus @default(ACTIVE)
  ownerId Int

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant   Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  account  Account?         @relation(fields: [accountId], references: [id], onDelete: SetNull)
  project  Project?         @relation(fields: [projectId], references: [id], onDelete: SetNull)
  category ExpenseCategory? @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  owner    User             @relation("BudgetOwner", fields: [ownerId], references: [id])
  expenses Expense[]
  alerts   FinanceAlert[]

  @@index([tenantId, status])
  @@index([tenantId, accountId])
  @@index([tenantId, categoryId])
}

/**
 * Expense - Individual expense records
 */
model Expense {
  id       Int    @id @default(autoincrement())
  tenantId String

  accountId       Int?
  projectId       Int?
  opportunityId   Int?
  budgetId        Int?
  categoryId      Int
  recurringCostId Int?

  description String
  amount      Decimal  @db.Decimal(15, 2)
  currency    String   @default("USD")
  date        DateTime

  vendorName    String?
  vendorId      String?
  invoiceNumber String?

  status          ExpenseStatus @default(PENDING)
  approvedBy      Int?
  approvedAt      DateTime?
  rejectionReason String?

  attachments Json @default("[]")

  // AI-generated fields
  aiCategorySuggestion String?
  aiConfidenceScore    Float?
  aiAnomalyFlag        Boolean @default(false)
  aiAnomalyReason      String?

  tags  String[] @default([])
  notes String?

  allocations Json?

  ownerId   Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant        Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  account       Account?        @relation(fields: [accountId], references: [id], onDelete: SetNull)
  project       Project?        @relation(fields: [projectId], references: [id], onDelete: SetNull)
  opportunity   Opportunity?    @relation(fields: [opportunityId], references: [id], onDelete: SetNull)
  budget        Budget?         @relation(fields: [budgetId], references: [id], onDelete: SetNull)
  category      ExpenseCategory @relation(fields: [categoryId], references: [id])
  recurringCost RecurringCost?  @relation(fields: [recurringCostId], references: [id], onDelete: SetNull)
  owner         User            @relation("ExpenseOwner", fields: [ownerId], references: [id])
  approver      User?           @relation("ExpenseApprover", fields: [approvedBy], references: [id])

  @@index([tenantId, status])
  @@index([tenantId, accountId])
  @@index([tenantId, categoryId])
  @@index([tenantId, date])
}

/**
 * RecurringCost - Recurring costs (subscriptions, licenses, payroll)
 */
model RecurringCost {
  id       Int    @id @default(autoincrement())
  tenantId String

  accountId  Int?
  categoryId Int

  name        String
  description String?

  type RecurringCostType

  amount    Decimal            @db.Decimal(15, 2)
  currency  String             @default("USD")
  frequency RecurringFrequency

  billingDay  Int?
  startDate   DateTime
  endDate     DateTime?
  nextDueDate DateTime

  vendorName     String?
  vendorUrl      String?
  contractNumber String?
  seatCount      Int?
  costPerSeat    Decimal? @db.Decimal(15, 2)

  employeeId Int?
  department String?

  autoRenew        Boolean @default(true)
  renewalAlertDays Int     @default(30)

  status  RecurringCostStatus @default(ACTIVE)
  ownerId Int

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant   Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  account  Account?        @relation(fields: [accountId], references: [id], onDelete: SetNull)
  category ExpenseCategory @relation(fields: [categoryId], references: [id])
  employee User?           @relation("EmployeeCost", fields: [employeeId], references: [id])
  owner    User            @relation("RecurringCostOwner", fields: [ownerId], references: [id])
  expenses Expense[]

  @@index([tenantId, status])
  @@index([tenantId, type])
  @@index([tenantId, nextDueDate])
}

/**
 * AccountProfitability - Profitability snapshots for accounts
 */
model AccountProfitability {
  id        Int    @id @default(autoincrement())
  tenantId  String
  accountId Int

  period     String
  periodType ProfitabilityPeriod
  startDate  DateTime
  endDate    DateTime

  totalRevenue      Decimal @default(0) @db.Decimal(15, 2)
  recognizedRevenue Decimal @default(0) @db.Decimal(15, 2)

  directCosts    Decimal @default(0) @db.Decimal(15, 2)
  allocatedCosts Decimal @default(0) @db.Decimal(15, 2)
  totalCosts     Decimal @default(0) @db.Decimal(15, 2)

  grossProfit Decimal @default(0) @db.Decimal(15, 2)
  grossMargin Float   @default(0)
  netProfit   Decimal @default(0) @db.Decimal(15, 2)
  netMargin   Float   @default(0)

  costBreakdown Json @default("{}")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant  Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  account Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@unique([tenantId, accountId, period])
  @@index([tenantId, accountId])
  @@index([tenantId, periodType])
}

/**
 * FinanceAlert - Finance alerts and notifications
 */
model FinanceAlert {
  id       Int    @id @default(autoincrement())
  tenantId String

  type     FinanceAlertType
  severity FinanceAlertSeverity @default(INFO)

  title   String
  message String

  budgetId        Int?
  expenseId       Int?
  recurringCostId Int?
  accountId       Int?

  metadata Json @default("{}")

  isRead      Boolean @default(false)
  isDismissed Boolean @default(false)

  userId Int

  createdAt DateTime  @default(now())
  readAt    DateTime?

  tenant Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  budget Budget? @relation(fields: [budgetId], references: [id], onDelete: SetNull)

  @@index([tenantId, userId, isRead])
  @@index([tenantId, type])
}

/**
 * FinanceInsight - AI-generated financial insights
 */
model FinanceInsight {
  id        Int    @id @default(autoincrement())
  tenantId  String
  accountId Int?

  type        FinanceInsightType
  title       String
  description String             @db.Text

  metrics         Json @default("{}")
  recommendations Json @default("[]")

  confidence Float    @default(0)
  validFrom  DateTime
  validUntil DateTime

  isActive    Boolean @default(true)
  isDismissed Boolean @default(false)
  isActedUpon Boolean @default(false)

  createdAt DateTime @default(now())

  tenant  Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  account Account? @relation(fields: [accountId], references: [id], onDelete: SetNull)

  @@index([tenantId, type, isActive])
}

// ============================================================================
// AI MONITORING MODELS
// ============================================================================

/**
 * AIUsageEvent - Individual AI tool call tracking
 * Records every AI API call for cost allocation, billing, and analytics
 */
model AIUsageEvent {
  id       String @id @default(cuid())
  tenantId String

  // Tool identification
  toolId    String // e.g., "chatbot", "document-analyzer", "lead-scoring"
  toolName  String // Human-readable name
  operation String // e.g., "chat", "analyze", "score", "generate"

  // Token tracking
  promptTokens     Int @default(0)
  completionTokens Int @default(0)
  totalTokens      Int @default(0)

  // Cost tracking (USD with 6 decimal precision)
  model         String // e.g., "gpt-4-turbo", "gpt-4o-mini"
  estimatedCost Decimal @db.Decimal(10, 6)

  // Performance
  latencyMs Int     @default(0) // Response time in milliseconds
  success   Boolean @default(true)
  errorType String? // If failed, error classification

  // Context
  userId     Int?
  entityType String? // e.g., "Account", "Lead", "Document"
  entityId   String?
  metadata   Json? // Additional context

  createdAt DateTime @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   User?  @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([tenantId, createdAt])
  @@index([tenantId, toolId])
  @@index([tenantId, toolId, createdAt])
  @@index([createdAt])
  @@index([userId])
}

/**
 * AIUsageSummary - Aggregated AI usage metrics
 * Pre-computed summaries for efficient dashboard queries
 */
model AIUsageSummary {
  id       String @id @default(cuid())
  tenantId String

  // Aggregation period
  periodStart DateTime
  periodEnd   DateTime
  periodType  AIUsagePeriodType // HOURLY, DAILY, MONTHLY

  // Per-tool breakdown
  toolId String

  // Aggregated metrics
  totalCalls      Int @default(0)
  successfulCalls Int @default(0)
  failedCalls     Int @default(0)

  totalPromptTokens     Int @default(0)
  totalCompletionTokens Int @default(0)
  totalTokens           Int @default(0)

  totalCost Decimal @db.Decimal(10, 4)

  avgLatencyMs Int @default(0)
  p95LatencyMs Int @default(0)
  p99LatencyMs Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, periodStart, periodType, toolId])
  @@index([tenantId, periodType, periodStart])
}

enum AIUsagePeriodType {
  HOURLY
  DAILY
  MONTHLY
}

/**
 * InfrastructureMetric - API and system performance metrics
 */
model InfrastructureMetric {
  id String @id @default(cuid())

  metricType String // "API_LATENCY", "DB_QUERY", "MEMORY", "CPU", "ERROR_RATE"
  metricName String // Specific metric (e.g., "POST /api/chatbot/chat")

  // Aggregated values
  count Int   @default(0)
  sum   Float @default(0)
  min   Float?
  max   Float?
  avg   Float?
  p50   Float?
  p95   Float?
  p99   Float?

  // Time window
  windowStart DateTime
  windowEnd   DateTime
  windowSize  String // "1m", "5m", "1h", "1d"

  // Optional tenant scope (null = system-wide)
  tenantId String?

  metadata Json?

  createdAt DateTime @default(now())

  @@index([metricType, windowStart])
  @@index([tenantId, metricType, windowStart])
}

/**
 * SlowQueryLog - Database slow query tracking
 */
model SlowQueryLog {
  id String @id @default(cuid())

  query      String @db.Text // Sanitized query (no values)
  model      String // Prisma model
  operation  String // findMany, create, etc.
  durationMs Int

  tenantId String?
  userId   Int?

  createdAt DateTime @default(now())

  @@index([createdAt])
  @@index([durationMs])
  @@index([tenantId])
}

/**
 * Anomaly - Detected anomalies across all monitoring domains
 */
model Anomaly {
  id       String  @id @default(cuid())
  tenantId String? // null for system-wide anomalies

  // Classification
  type     String // USAGE_SPIKE, HEALTH_DECLINE, AI_COST_SPIKE, etc.
  severity AnomalySeverity
  category AnomalyCategory

  // Detection details
  metric        String
  expectedValue Float?
  actualValue   Float
  deviation     Float? // How far from expected (%)

  // Context
  entityType String? // e.g., "Tenant", "User", "Endpoint"
  entityId   String?
  metadata   Json?

  // Status
  status         AnomalyStatus @default(OPEN)
  acknowledgedAt DateTime?
  acknowledgedBy Int?
  resolvedAt     DateTime?
  resolvedBy     Int?
  resolution     String? // Notes on how it was resolved

  detectedAt DateTime @default(now())

  acknowledgedByUser User? @relation("AnomalyAcknowledgedBy", fields: [acknowledgedBy], references: [id], onDelete: SetNull)
  resolvedByUser     User? @relation("AnomalyResolvedBy", fields: [resolvedBy], references: [id], onDelete: SetNull)

  @@index([status, severity])
  @@index([tenantId, status])
  @@index([category, detectedAt])
  @@index([detectedAt])
}

enum AnomalySeverity {
  CRITICAL
  WARNING
  INFO
}

enum AnomalyCategory {
  USAGE
  HEALTH
  COST
  SECURITY
  INFRASTRUCTURE
  DATA_QUALITY
}

enum AnomalyStatus {
  OPEN
  ACKNOWLEDGED
  RESOLVED
  FALSE_POSITIVE
}

/**
 * AlertRule - Alert configuration for monitoring
 */
model AlertRule {
  id String @id @default(cuid())

  name        String
  description String?

  // Trigger conditions
  anomalyType String? // Link to specific anomaly type
  category    AnomalyCategory?
  severities  AnomalySeverity[] // Which severities trigger this

  // Actions
  channels   AlertChannel[]
  recipients String[] // Email addresses, Slack channels, webhook URLs

  // Throttling
  cooldownMinutes Int @default(60)
  maxAlertsPerDay Int @default(10)

  // Status
  enabled Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  alerts AlertHistory[]
}

enum AlertChannel {
  EMAIL
  SLACK
  WEBHOOK
  IN_APP
}

/**
 * AlertHistory - Record of sent alerts
 */
model AlertHistory {
  id String @id @default(cuid())

  alertRuleId String
  anomalyId   String?

  // What was sent
  channel   AlertChannel
  recipient String
  subject   String
  body      String @db.Text

  // Delivery status
  status       AlertDeliveryStatus
  errorMessage String?

  sentAt DateTime @default(now())

  alertRule AlertRule @relation(fields: [alertRuleId], references: [id], onDelete: Cascade)

  @@index([alertRuleId, sentAt])
  @@index([sentAt])
}

enum AlertDeliveryStatus {
  SENT
  FAILED
  THROTTLED
}
